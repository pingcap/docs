---
title: TiDB 4.0.2 Release Notes
category: Releases
---

# TiDB 4.0.2 Release Notes

Release date: Month Date, Year

TiDB version: 4.0.2

## Compatibility Changes

+ TiDB
    - Remove sensitive information in slow query log and statement summary table. [#18130](https://github.com/pingcap/tidb/pull/18130)
    - Make error message more clear when load schema failed. [#17975](https://github.com/pingcap/tidb/pull/17975)

+ TiKV
    -
+ PD
    -
+ TiFlash
    - Improve backward compatibility when upgrading from the older version. [#786](https://github.com/pingcap/tics/pull/786)
+ Tools
    - TiDB Binlog
        -
    - TiCDC
        -
    - Lignting
        -

## New Features

+ TiDB
    - Add new aggregate function `APPROX_COUNT_DISTINCT` to calculate approximate count distinct result. [#18120](https://github.com/pingcap/tidb/pull/18120)
    - Support `MEMORY_QUOTA()` hint in the `INSERT` statements. [#18101](https://github.com/pingcap/tidb/pull/18101)
    - Add config `EnableCollectExecutionInfo` to collect execution information of each operator [#18073](https://github.com/pingcap/tidb/pull/18073), [#18072](https://github.com/pingcap/tidb/pull/18072)
    - Support authentication based on TLS certificate SAN field [#17698](https://github.com/pingcap/tidb/pull/17698)
    - Add a `status_address` of `inspection_result` table to indicate the `status address`. [#17695](https://github.com/pingcap/tidb/pull/17695)
    - add global variable tidb_slow_log_masking to control masking slow log query. [#17694](https://github.com/pingcap/tidb/pull/17694)
    - Split partition region when adding a new partition [#17665](https://github.com/pingcap/tidb/pull/17665)
    - Enable `if/bitxor/bitneg` pushdown to TiFlash [#17651](https://github.com/pingcap/tidb/pull/17651)
    - Support sql_select_limit session / global vairable [#17604](https://github.com/pingcap/tidb/pull/17604)
    - add domain `CreateWay` in `Binding` to help know the way binding created. [#17587](https://github.com/pingcap/tidb/pull/17587)
    - support collation for REGEXP function [#17581](https://github.com/pingcap/tidb/pull/17581)
    - Make plan cache consider isolation read engines. [#17570](https://github.com/pingcap/tidb/pull/17570)
    
+ TiKV
    -
+ PD
    -
+ TiFlash
    - Support new aggregation function APPROX_COUNT_DISTINCT. [#798](https://github.com/pingcap/tics/pull/798)
    - Enable rough set filter feature by default. [#777](https://github.com/pingcap/tics/pull/777)
    - Enable TiFlash running on ARM architecture. [#769](https://github.com/pingcap/tics/pull/769)
+ Tools
    - TiDB Binlog
        -
    - TiCDC
        -
    - Lignting
        -

## Bug Fixes

+ TiDB
    - Save explain result of plan in session for `explain for connection` usage. [#18124](https://github.com/pingcap/tidb/pull/18124)
    - Fix incorrect result of session variable `last_plan_from_cache`. [#18111](https://github.com/pingcap/tidb/pull/18111)
    - Fix the negative sequence cache problem [#18103](https://github.com/pingcap/tidb/pull/18103)
    - Fix the Index Merge Join executor occasionally hang issue in some scenario [#18091](https://github.com/pingcap/tidb/pull/18091)
    - Refine the memory usage counting of InsertExec and ReplaceExec. [#18062](https://github.com/pingcap/tidb/pull/18062)
    - Fix the panic when using `unix_timestamp` expression in `prepare and execute` statement when plan cache is enabled. [#18002](https://github.com/pingcap/tidb/pull/18002)
    - Fix a compatibility bug that partition table created in old version TiDB can not be loaded in v4.0.0 when the `less than` expression is not an integer [#17983](https://github.com/pingcap/tidb/pull/17983)
    - Fix issue that `cluster_info` table displays the tombstone tikv/tiflash servers [#17953](https://github.com/pingcap/tidb/pull/17953)
    - Fix "Got too many pings" grpc error log in PD-server follower [#17947](https://github.com/pingcap/tidb/pull/17947)
    - Fix panic when the child of HashJoin returns TypeNull column. [#17937](https://github.com/pingcap/tidb/pull/17937)
    - Fix HTTP api get TiFlash replica failed cause by concurrent DDL. [#17901](https://github.com/pingcap/tidb/pull/17901)
    - fix a bug that the coercibility of user variable is wrong [#17890](https://github.com/pingcap/tidb/pull/17890)
    - Fix a bug that caused fail to backup/restore to/from object storage [#17844](https://github.com/pingcap/tidb/pull/17844)
    - Discard feedbacks generated from `delete` / `update` statements. [#17843](https://github.com/pingcap/tidb/pull/17843)
    - Disallow alter auto_random_base on a non-auto_random table. [#17828](https://github.com/pingcap/tidb/pull/17828)
    - fix error message when access denied. [#17724](https://github.com/pingcap/tidb/pull/17724)
    - make isolation read do not filter system tables. [#17719](https://github.com/pingcap/tidb/pull/17719)
    - Fix JSON comparison for int and float. [#17717](https://github.com/pingcap/tidb/pull/17717)
    - Fix type infer for decimal property in count agg [#17704](https://github.com/pingcap/tidb/pull/17704)
    - Fix a bug that collation does not work for enum and set. [#17701](https://github.com/pingcap/tidb/pull/17701)
    - fix query inspection_summary without condition would return null. [#17697](https://github.com/pingcap/tidb/pull/17697)
    - Fix the issue that parallel execution of "drop database" and other DDL may cause panic. [#17659](https://github.com/pingcap/tidb/pull/17659)
    - fix the forever hang in index merge join when oom occurs [#17654](https://github.com/pingcap/tidb/pull/17654)
    - fix alter user with hash string [#17646](https://github.com/pingcap/tidb/pull/17646)
    - fix a bug that hex function return the wrong result if the type of column is binary string [#17620](https://github.com/pingcap/tidb/pull/17620)
    - Fix pre-split region timeout constraint not work when create table. [#17619](https://github.com/pingcap/tidb/pull/17619)
    - Fix an issue that may break the atomicity of DDL job: when a DDL job is retried, the schema is unexpectedly updated. [#17608](https://github.com/pingcap/tidb/pull/17608)
    - fix wrong result for field function when the argument contains column [#17562](https://github.com/pingcap/tidb/pull/17562)
    - fix the allocator batch size compute logic [#17550](https://github.com/pingcap/tidb/pull/17550)
    - Fix the issue that the max_execution_time sometimes fails. [#17536](https://github.com/pingcap/tidb/pull/17536)
    - `%h` in date formats should now be in 1..12 range. [#17498](https://github.com/pingcap/tidb/pull/17498)
    - Fix infinite follower/learner retry when network partition only between the leader and follower/learner [#17443](https://github.com/pingcap/tidb/pull/17443)
    - executor: Remove unnecessary information in explain analyze output [#17350](https://github.com/pingcap/tidb/pull/17350)

+ TiKV
    -
+ PD
    -
+ TiFlash
    - Fix the issue that proxy may panic when meet region not found [#807](https://github.com/pingcap/tics/pull/807)
    - Fix the issue that I/O exception thrown in drop table may lead to TiFlash schema sync failure. [#791](https://github.com/pingcap/tics/pull/791)
+ Tools
    - TiDB Binlog
        -
    - TiCDC
        -
    - Lignting
        -

## TiDB

- Pre-index stores in region-cache for different access pattern [#18105](https://github.com/pingcap/tidb/pull/18105)
- Correct the usage of json.Unmarshal in job.DecodeArgs to be compatible with future Go versionsã€‚ [#17889](https://github.com/pingcap/tidb/pull/17889)
- failpoint: update failpoint which will cause data race before [#17712](https://github.com/pingcap/tidb/pull/17712)
- pushdown expr to tiflash without check new collation status [#17705](https://github.com/pingcap/tidb/pull/17705)
- Mitigate the impact of failure recovery on QPS. [#17681](https://github.com/pingcap/tidb/pull/17681)
- fix the wrong behavior of const.String() [#17673](https://github.com/pingcap/tidb/pull/17673)
- Add config check for `storage.block-cache.capacity` of TiKV config. [#17671](https://github.com/pingcap/tidb/pull/17671)
- refactor current-load diagnosis rule to node-check [#17660](https://github.com/pingcap/tidb/pull/17660)
- none release note. [#17655](https://github.com/pingcap/tidb/pull/17655)
- fix failpoint race for analyze test [#17653](https://github.com/pingcap/tidb/pull/17653)
- improve row count estimation for index equal condition [#17611](https://github.com/pingcap/tidb/pull/17611)
- Assign different `Backoffer` for each region to avoid the SQL command timeout issue when multiple region requests fail at the same time [#17585](https://github.com/pingcap/tidb/pull/17585)
- avoid large CMSketch affecting the latency of normal query [#17545](https://github.com/pingcap/tidb/pull/17545)
- Datetime parsing now matches MySQL 5.7 behavior for delimiters. [#17501](https://github.com/pingcap/tidb/pull/17501)
- Users can see the statistics about the use of plan cache by [#17493](https://github.com/pingcap/tidb/pull/17493)


## TiKV

- No release notes. [#8103](https://github.com/tikv/tikv/pull/8103)
- Update the dependency of the status server to resolve a memory safety problem. [#8101](https://github.com/tikv/tikv/pull/8101)
- Improve PD client log. [#8093](https://github.com/tikv/tikv/pull/8093)
- fix precision lost in json numeric comparsion [#8087](https://github.com/tikv/tikv/pull/8087)
- Fix wrong query slow log [#8050](https://github.com/tikv/tikv/pull/8050)
- Fix a case that a peer can not be removed when its store is isolated during multiple merge process. [#8048](https://github.com/tikv/tikv/pull/8048)
- `tikv-ctl recover-mvcc` removes invalid pessimistic locks. [#8047](https://github.com/tikv/tikv/pull/8047)
- Add back `process_cpu_seconds_total` and `process_start_time_seconds`. [#8029](https://github.com/tikv/tikv/pull/8029)
- Fix missing titan histogram metrics [#7997](https://github.com/tikv/tikv/pull/7997)
- Add metric so that user could observe latency of each step of `RocksDB::WriteImpl` [#7991](https://github.com/tikv/tikv/pull/7991)
- Bugfix for TiKV returns `duplicated error` to TiCDC. [#7887](https://github.com/tikv/tikv/pull/7887)

## PD

- Set a suitable default store limit of the TiFlash stores [#2560](https://github.com/pingcap/pd/pull/2560)
- Improve the way to set store limit by removing `store-balance-rate` [#2557](https://github.com/pingcap/pd/pull/2557)
- fix the placement rules issue that prevent store changing to tombstone [#2554](https://github.com/pingcap/pd/pull/2554)
- Let the operator fast fail if the leader changed to the RemovePeer [#2551](https://github.com/pingcap/pd/pull/2551)
- Fix the issue that It may panic when setting `store-limit-mode` to `auto` [#2547](https://github.com/pingcap/pd/pull/2547)

## TiFlash

- Fix the issue that proxy may panic when meet region not found [#807](https://github.com/pingcap/tics/pull/807)
- Support new aggregation function APPROX_COUNT_DISTINCT. [#798](https://github.com/pingcap/tics/pull/798)
- Fix the issue that I/O exception thrown in drop table may lead to TiFlash schema sync failure. [#791](https://github.com/pingcap/tics/pull/791)
- Improve backward compatibility when upgrading from the older version. [#786](https://github.com/pingcap/tics/pull/786)
- Enable rough set filter feature by default. [#777](https://github.com/pingcap/tics/pull/777)
- Enable TiFlash running on ARM architecture. [#769](https://github.com/pingcap/tics/pull/769)

## BR

- Boost the restore speed by pipelining the restore process. [#356](https://github.com/pingcap/br/pull/356)
- Improved robustness: spurious network failure during ingestion would now be retried. [#344](https://github.com/pingcap/br/pull/344)
- Reduced the excessive refresh rate of progress logs when logging to terminal (e.g. when using K8s). [#341](https://github.com/pingcap/br/pull/341)

## Dumpling

- Add dump-empty-database option, check whether database exists before dump and allow filetype sql for --Sql command. [#103](https://github.com/pingcap/dumpling/pull/103)
- Set GC ts automatically before dumping [#97](https://github.com/pingcap/dumpling/pull/97).
- Support special named databases/tables/columns [#87](https://github.com/pingcap/dumpling/pull/87)
- Adjust CLI parameters to make them the same as mydumper [#86](https://github.com/pingcap/dumpling/pull/86)
- Implement --filter and --case-sensitive [#82](https://github.com/pingcap/dumpling/pull/82)
## Lightning

## TiCDC

- Support for migrating sub-tasks to new captures [#665](https://github.com/pingcap/ticdc/pull/665)
- Fix retry to create changefeed infinitely if start-ts is less than GC safepoint. [#662](https://github.com/pingcap/ticdc/pull/662)
- Fix the issue that CDC can not replicate data between three or more clusters. [#656](https://github.com/pingcap/ticdc/pull/656)
- Add a command to delete CDC GC TTL [#652](https://github.com/pingcap/ticdc/pull/652)
- Support canal protocol in MQ sink [#649](https://github.com/pingcap/ticdc/pull/649)
- Reduce the granularity of conflict detection and improve the concurrency in MySQL sink. [#648](https://github.com/pingcap/ticdc/pull/648)
- Fix the issue about the db content leak [#623](https://github.com/pingcap/ticdc/pull/623)
- Improve cyclic replication set up. [#611](https://github.com/pingcap/ticdc/pull/611)
