---
title: TiDB 4.0.2 Release Notes
category: Releases
---

# TiDB 4.0.2 Release Notes

Release date: Month Date, Year

TiDB version: 4.0.2

## Compatibility Changes

+ TiDB
    - Remove sensitive information in slow query log and statement summary table. [#18130](https://github.com/pingcap/tidb/pull/18130)
    - Forbid negative value in the sequence cache. [#18103](https://github.com/pingcap/tidb/pull/18103)
    - Remove tombstone TiKV and TiFlash servers from the `CLUSTER_INFO` table. [#17953](https://github.com/pingcap/tidb/pull/17953)

+ TiKV
    -
+ PD
    -
+ TiFlash
    - Improve backward compatibility when upgrading from the older version. [#786](https://github.com/pingcap/tics/pull/786)
+ Tools
    - TiDB Binlog
        -
    - TiCDC
        -
    - Lignting
        -

## New Features

+ TiDB
    - Support the `MEMORY_QUOTA()` hint in `INSERT` statements. [#18101](https://github.com/pingcap/tidb/pull/18101)
    - Support authentication based on TLS certificate SAN field [#17698](https://github.com/pingcap/tidb/pull/17698)
    - Support collation for the `REGEXP()` function. [#17581](https://github.com/pingcap/tidb/pull/17581)
    - Support the `sql_select_limit` session and global vairable. [#17604](https://github.com/pingcap/tidb/pull/17604)
    - Support spliting the region for the newly added partition by default. [#17665](https://github.com/pingcap/tidb/pull/17665)
    - Support pushing the `IF()`/`BITXOR()`/`BITNEG()`/`JSON_LENGTH()` functions to the TiFlash Coprocessor. [#17651](https://github.com/pingcap/tidb/pull/17651), [#17592](https://github.com/pingcap/tidb/pull/17592)
    - Support a new aggregate function `APPROX_COUNT_DISTINCT()` to calculate the approximate result of `COUNT(DISTINCT)`. [#18120](https://github.com/pingcap/tidb/pull/18120)
    - Add the `STATUS_ADDRESS` column in the `INFORMATION_SCHEMA.INSPECTION_RESULT` table to indicate the status address of servers. [#17695](https://github.com/pingcap/tidb/pull/17695)
    - Add the `SOURCE` column in the `MYSQL.BIND_INFO` table to indicate the how the bindings are created. [#17587](https://github.com/pingcap/tidb/pull/17587)
    - Add the config `enable-collect-execution-info` and session variable `tidb_enable_collect_execution_info` to control whether to collect execution information of each operator and record it in the slow query log. [#18073](https://github.com/pingcap/tidb/pull/18073), [#18072](https://github.com/pingcap/tidb/pull/18072)
    - Add the global variable `tidb_slow_log_masking` to control whether to desensitize the query in slow query log. [#17694](https://github.com/pingcap/tidb/pull/17694)

+ TiKV
    -
+ PD
    -
+ TiFlash
    - Support new aggregation function APPROX_COUNT_DISTINCT. [#798](https://github.com/pingcap/tics/pull/798)
    - Enable rough set filter feature by default. [#777](https://github.com/pingcap/tics/pull/777)
    - Enable TiFlash running on ARM architecture. [#769](https://github.com/pingcap/tics/pull/769)
    - Reduce memory consumption of delta index. [#787](https://github.com/pingcap/tics/pull/787)
    - Better update algorithm of delta index. [#794](https://github.com/pingcap/tics/pull/794)
    - Support function `JSON_LENGTH` in Coprocessor. [#742](https://github.com/pingcap/tics/pull/742)

+ Tools
    - TiDB Binlog
        -
    - TiCDC
        -
    - Lignting
        -

## Bug Fixes

+ TiDB
    - Fix the incorrect execution plan in plan cache after `tidb_isolation_read_engines` is changed. [#17570](https://github.com/pingcap/tidb/pull/17570)
    - Fix the occasionally runtime error in executing the `EXPLAIN FOR CONNECTION` statement. [#18124](https://github.com/pingcap/tidb/pull/18124)
    - Fix the incorrect result of session variable `last_plan_from_cache`. [#18111](https://github.com/pingcap/tidb/pull/18111)
    - Fix the runtime error in executing `UNIX_TIMESTAMP()` function from plan cache. [#18002](https://github.com/pingcap/tidb/pull/18002)
    - Fix the runtime error when the child of `HashJoin` executor returns `NULL` column. [#17937](https://github.com/pingcap/tidb/pull/17937)
    - Fix the runtime error caused by parallelly executing "DROP DATABASE" and other DDL on the same database. [#17659](https://github.com/pingcap/tidb/pull/17659)
    - Fix the incorrect result of function `COERCIBILITY()` on user variable. [#17890](https://github.com/pingcap/tidb/pull/17890)
    - Fix occasionally hang in the `IndexMergeJoin` executor. [#18091](https://github.com/pingcap/tidb/pull/18091)
    - Fix hang in the `IndexMergeJoin` executor when out of memory quota and query cancelling is triggered. [#17654](https://github.com/pingcap/tidb/pull/17654)
    - Fix over counting memory usage of the `Insert` and `Replace` executor. [#18062](https://github.com/pingcap/tidb/pull/18062)
    - Fix stoping replicating data to TiFlash storage when `DROP DATABASE` and `DROP TABLE` of the same database running concurrently. [#17901](https://github.com/pingcap/tidb/pull/17901)
    - Fix the `BACKUP`/`RESTORE` failure between TiDB and object storage. [#17844](https://github.com/pingcap/tidb/pull/17844)
    - Fix the incorrect error message of privelege check failure when access denied. [#17724](https://github.com/pingcap/tidb/pull/17724)
    - Discard the query feedbacks generated from the `DELETE`/`UPDATE` statements. [#17843](https://github.com/pingcap/tidb/pull/17843)
    - Forbid altering `AUTO_RANDOM_BASE` for a table without `AUTO_RANDOM` property. [#17828](https://github.com/pingcap/tidb/pull/17828)
    - Fix the issue that some system tables can not be access when setting `tidb_isolation_read_engines` without `tidb`. [#17719](https://github.com/pingcap/tidb/pull/17719)
    - Fix the incorrect result of JSON comparison on large integer and float values. [#17717](https://github.com/pingcap/tidb/pull/17717)
    - Fix the incorrect decimal property for the result of `COUNT()` function. [#17704](https://github.com/pingcap/tidb/pull/17704)
    - Fix the incorrect result of `HEX()` function when the type of input parameter is binary string. [#17620](https://github.com/pingcap/tidb/pull/17620)
    - Fix returning empty result when querying `INFORMATION_SCHEMA.INSPECTION_SUMMARY` table without filter condition. [#17697](https://github.com/pingcap/tidb/pull/17697)
    - Fix `ALTER USER` with hash string result in rehashed password issue. [#17646](https://github.com/pingcap/tidb/pull/17646)
    - Support collation for `ENUM` and `SET` values. [#17701](https://github.com/pingcap/tidb/pull/17701)

    - Fix the issue that old versioned range partition table can not be upgraded to TiDB 4.0.0. [#17983](https://github.com/pingcap/tidb/pull/17983)
    - Fix "Got too many pings" grpc error log in PD-server follower [#17947](https://github.com/pingcap/tidb/pull/17947)

    - Fix the pre-split region timeout constraint not work issue on `CREATE TABLE`. [#17619](https://github.com/pingcap/tidb/pull/17619)
    - Fix an issue that may break the atomicity of DDL job: when a DDL job is retried, the schema is unexpectedly updated. [#17608](https://github.com/pingcap/tidb/pull/17608)
    - fix wrong result for field function when the argument contains column [#17562](https://github.com/pingcap/tidb/pull/17562)
    - fix the allocator batch size compute logic [#17550](https://github.com/pingcap/tidb/pull/17550)
    - Fix the issue that the max_execution_time sometimes fails. [#17536](https://github.com/pingcap/tidb/pull/17536)
    - `%h` in date formats should now be in 1..12 range. [#17498](https://github.com/pingcap/tidb/pull/17498)
    - Fix infinite follower/learner retry when network partition only between the leader and follower/learner [#17443](https://github.com/pingcap/tidb/pull/17443)
    - executor: Remove unnecessary information in explain analyze output [#17350](https://github.com/pingcap/tidb/pull/17350)

+ TiKV
    -
+ PD
    -
+ TiFlash
    - Fix the issue that proxy may panic when meet region not found [#807](https://github.com/pingcap/tics/pull/807)
    - Fix the issue that I/O exception thrown in drop table may lead to TiFlash schema sync failure. [#791](https://github.com/pingcap/tics/pull/791)
+ Tools
    - TiDB Binlog
        -
    - TiCDC
        -
    - Lignting
        -

## TiDB

- Pre-index stores in region-cache for different access pattern [#18105](https://github.com/pingcap/tidb/pull/18105)
- Correct the usage of json.Unmarshal in job.DecodeArgs to be compatible with future Go versionsã€‚ [#17889](https://github.com/pingcap/tidb/pull/17889)
- failpoint: update failpoint which will cause data race before [#17712](https://github.com/pingcap/tidb/pull/17712)
- pushdown expr to tiflash without check new collation status [#17705](https://github.com/pingcap/tidb/pull/17705)
- Mitigate the impact of failure recovery on QPS. [#17681](https://github.com/pingcap/tidb/pull/17681)
- fix the wrong behavior of const.String() [#17673](https://github.com/pingcap/tidb/pull/17673)
- Add config check for `storage.block-cache.capacity` of TiKV config. [#17671](https://github.com/pingcap/tidb/pull/17671)
- refactor current-load diagnosis rule to node-check [#17660](https://github.com/pingcap/tidb/pull/17660)
- none release note. [#17655](https://github.com/pingcap/tidb/pull/17655)
- fix failpoint race for analyze test [#17653](https://github.com/pingcap/tidb/pull/17653)
- improve row count estimation for index equal condition [#17611](https://github.com/pingcap/tidb/pull/17611)
- Assign different `Backoffer` for each region to avoid the SQL command timeout issue when multiple region requests fail at the same time [#17585](https://github.com/pingcap/tidb/pull/17585)
- avoid large CMSketch affecting the latency of normal query [#17545](https://github.com/pingcap/tidb/pull/17545)
- Datetime parsing now matches MySQL 5.7 behavior for delimiters. [#17501](https://github.com/pingcap/tidb/pull/17501)
- Users can see the statistics about the use of plan cache by [#17493](https://github.com/pingcap/tidb/pull/17493)


## TiKV

- No release notes. [#8103](https://github.com/tikv/tikv/pull/8103)
- Update the dependency of the status server to resolve a memory safety problem. [#8101](https://github.com/tikv/tikv/pull/8101)
- Improve PD client log. [#8093](https://github.com/tikv/tikv/pull/8093)
- fix precision lost in json numeric comparsion [#8087](https://github.com/tikv/tikv/pull/8087)
- Fix wrong query slow log [#8050](https://github.com/tikv/tikv/pull/8050)
- Fix a case that a peer can not be removed when its store is isolated during multiple merge process. [#8048](https://github.com/tikv/tikv/pull/8048)
- `tikv-ctl recover-mvcc` removes invalid pessimistic locks. [#8047](https://github.com/tikv/tikv/pull/8047)
- Add back `process_cpu_seconds_total` and `process_start_time_seconds`. [#8029](https://github.com/tikv/tikv/pull/8029)
- Fix missing titan histogram metrics [#7997](https://github.com/tikv/tikv/pull/7997)
- Add metric so that user could observe latency of each step of `RocksDB::WriteImpl` [#7991](https://github.com/tikv/tikv/pull/7991)
- Bugfix for TiKV returns `duplicated error` to TiCDC. [#7887](https://github.com/tikv/tikv/pull/7887)

## PD

- Set a suitable default store limit of the TiFlash stores [#2560](https://github.com/pingcap/pd/pull/2560)
- Improve the way to set store limit by removing `store-balance-rate` [#2557](https://github.com/pingcap/pd/pull/2557)
- fix the placement rules issue that prevent store changing to tombstone [#2554](https://github.com/pingcap/pd/pull/2554)
- Let the operator fast fail if the leader changed to the RemovePeer [#2551](https://github.com/pingcap/pd/pull/2551)
- Fix the issue that It may panic when setting `store-limit-mode` to `auto` [#2547](https://github.com/pingcap/pd/pull/2547)

## TiFlash

- Fix the issue that proxy may panic when meet region not found [#807](https://github.com/pingcap/tics/pull/807)
- Support new aggregation function APPROX_COUNT_DISTINCT. [#798](https://github.com/pingcap/tics/pull/798)
- Fix the issue that I/O exception thrown in drop table may lead to TiFlash schema sync failure. [#791](https://github.com/pingcap/tics/pull/791)
- Improve backward compatibility when upgrading from the older version. [#786](https://github.com/pingcap/tics/pull/786)
- Enable rough set filter feature by default. [#777](https://github.com/pingcap/tics/pull/777)
- Enable TiFlash running on ARM architecture. [#769](https://github.com/pingcap/tics/pull/769)

## BR

- Boost the restore speed by pipelining the restore process. [#356](https://github.com/pingcap/br/pull/356)
- Improved robustness: spurious network failure during ingestion would now be retried. [#344](https://github.com/pingcap/br/pull/344)
- Reduced the excessive refresh rate of progress logs when logging to terminal (e.g. when using K8s). [#341](https://github.com/pingcap/br/pull/341)

## Dumpling

- Add dump-empty-database option, check whether database exists before dump and allow filetype sql for --Sql command. [#103](https://github.com/pingcap/dumpling/pull/103)
- Set GC ts automatically before dumping [#97](https://github.com/pingcap/dumpling/pull/97).
- Support special named databases/tables/columns [#87](https://github.com/pingcap/dumpling/pull/87)
- Adjust CLI parameters to make them the same as mydumper [#86](https://github.com/pingcap/dumpling/pull/86)
- Implement --filter and --case-sensitive [#82](https://github.com/pingcap/dumpling/pull/82)
## Lightning

## TiCDC

- Fix retry to create changefeed infinitely if start-ts is less than GC safepoint. [#662](https://github.com/pingcap/ticdc/pull/662)
- Fix the issue that CDC can not replicate data between three or more clusters. [#656](https://github.com/pingcap/ticdc/pull/656)
- Add a command to delete CDC GC TTL [#652](https://github.com/pingcap/ticdc/pull/652)
- Support canal protocol in MQ sink [#649](https://github.com/pingcap/ticdc/pull/649)
- Reduce the granularity of conflict detection and improve the concurrency in MySQL sink. [#648](https://github.com/pingcap/ticdc/pull/648)
- Fix the issue about the db content leak [#623](https://github.com/pingcap/ticdc/pull/623)
- Improve cyclic replication set up. [#611](https://github.com/pingcap/ticdc/pull/611)
