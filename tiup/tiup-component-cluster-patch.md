---
title: tiup cluster patch
summary: tiup cluster patch コマンドを使用すると、実行中のクラスターでバイナリを動的に置き換えることができます。バイナリ パッケージをアップロードし、対象サービスを停止し、バイナリを置き換えて、サービスを開始します。準備には、バイナリ パッケージをパックし、`--overwrite`、`--transfer-timeout`、`-N、--node`、`-R、--role`、`--offline` などのオプションを使用することが含まれます。出力は、 tiup-clusterの実行ログです。
---

# tiup cluster patch {#tiup-cluster-patch}

クラスターの実行中にサービスのバイナリを動的に置き換える必要がある場合 (つまり、置き換えプロセス中にクラスターを使用可能な状態に保つ必要がある場合)、 `tiup cluster patch`コマンドを使用できます。コマンドの実行後、 TiUP は次の処理を実行します。

-   置換用のバイナリ パッケージをターゲット マシンにアップロードします。
-   ターゲット サービスが TiKV、 TiFlash、TiDB Binlogなどのstorageサービスの場合、 TiUP はまず API 経由で関連ノードをオフラインにします。
-   対象サービスを停止します。
-   バイナリ パッケージを解凍し、サービスを置き換えます。
-   対象サービスを開始します。

## 構文 {#syntax}

```shell
tiup cluster patch <cluster-name> <package-path> [flags]
```

-   `<cluster-name>` : 操作対象となるクラスターの名前。
-   `<package-path>` : 置換に使用されるバイナリ パッケージへのパス。

### 準備 {#preparation}

`tiup cluster patch`コマンドを実行する前に、必要なバイナリ パッケージをパックする必要があります。次の手順を実行します。

1.  次の変数を決定します。

    -   `${component}` : 置換するコンポーネントの名前 ( `tidb` 、 `tikv` 、 `pd`など)。
    -   `${version}` :コンポーネントのバージョン ( `v8.1.0`や`v7.5.1`など)。
    -   `${os}` :オペレーティングシステム（ `linux` ）。
    -   `${arch}` :コンポーネントが実行されるプラットフォーム ( `amd64` 、 `arm64` )。

2.  次のコマンドを使用して、現在のコンポーネントパッケージをダウンロードします。

    ```shell
    wget https://tiup-mirrors.pingcap.com/${component}-${version}-${os}-${arch}.tar.gz -O /tmp/${component}-${version}-${os}-${arch}.tar.gz
    ```

3.  ファイルをパックするための一時ディレクトリを作成し、そこに移動します。

    ```shell
    mkdir -p /tmp/package && cd /tmp/package
    ```

4.  元のバイナリ パッケージを抽出します。

    ```shell
    tar xf /tmp/${component}-${version}-${os}-${arch}.tar.gz
    ```

5.  一時ディレクトリ内のファイル構造を確認します。

    ```shell
    find .
    ```

6.  バイナリ ファイルまたは構成ファイルを一時ディレクトリ内の対応する場所にコピーします。

7.  すべてのファイルを一時ディレクトリにパックします。

    ```shell
    tar czf /tmp/${component}-hotfix-${os}-${arch}.tar.gz *
    ```

上記の手順を完了したら、 `tiup cluster patch`コマンドの`<package-path>`として`/tmp/${component}-hotfix-${os}-${arch}.tar.gz`使用できます。

## オプション {#options}

### --overwrite {#overwrite}

-   特定のコンポーネント(TiDB や TiKV など) にパッチを適用した後、tiup クラスターがコンポーネントをスケールアウトすると、 TiUP はデフォルトで元のコンポーネントバージョンを使用します。将来クラスターがスケールアウトするときにパッチを適用したバージョンを使用するには、コマンドでオプション`--overwrite`を指定する必要があります。
-   データ型: `BOOLEAN`
-   このオプションは、デフォルトで値`false`で無効になっています。このオプションを有効にするには、このオプションをコマンドに追加し、値`true`を渡すか、値を渡さないようにする必要があります。

### --transfer-timeout {#transfer-timeout}

-   PD または TiKV サービスを再起動する場合、TiKV/PD は最初に再起動するノードのリーダーを別のノードに転送します。転送プロセスには時間がかかるため、オプション`--transfer-timeout`を使用して最大待機時間 (秒単位) を設定できます。タイムアウト後、 TiUP はサービスを直接再起動します。
-   データ型: `UINT`
-   このオプションを指定しない場合、 TiUP は`600`秒待機した後、サービスを直接再起動します。

> **注記：**
>
> タイムアウト後にTiUP がサービスを直接再起動すると、サービスのパフォーマンスが不安定になる可能性があります。

### -N、--ノード {#n-node}

-   置換するノードを指定します。このオプションの値は`tiup cluster display`ノード ID のコンマ区切りリストです。3 コマンドによって返される[クラスターステータステーブル](/tiup/tiup-component-cluster-display.md)の最初の列からノード ID を取得できます。
-   データ型: `STRINGS`
-   このオプションが指定されていない場合、 TiUP はデフォルトで置換するノードを選択しません。

> **注記：**
>
> オプション`-R, --role`が同時に指定されている場合、 TiUP は`-N, --node`と`-R, --role`の両方の要件に一致するサービス ノードを置き換えます。

### -R, --役割 {#r-role}

-   置き換えるロールを指定します。このオプションの値は、ノードのロールのコンマ区切りリストです。3 コマンドによって返される[クラスターステータステーブル](/tiup/tiup-component-cluster-display.md)の 2 番目の列から、ノードにデプロイされて`tiup cluster display`ロールを取得できます。
-   データ型: `STRINGS`
-   このオプションが指定されていない場合、 TiUP はデフォルトで置き換えるロールを選択しません。

> **注記：**
>
> オプション`-N, --node`が同時に指定されている場合、 TiUP は`-N, --node`と`-R, --role`の両方の要件に一致するサービス ノードを置き換えます。

### &#x20;--offline {#offline}

-   現在のクラスターが実行中でないことを宣言します。このオプションを指定すると、 TiUP はサービス リーダーを別のノードに移動したり、サービスを再起動したりせず、クラスター コンポーネントのバイナリ ファイルのみを置き換えます。
-   データ型: `BOOLEAN`
-   このオプションは、デフォルトで値`false`で無効になっています。このオプションを有効にするには、このオプションをコマンドに追加し、値`true`を渡すか、値を渡さないようにする必要があります。

### -h, --help {#h-help}

-   ヘルプ情報を出力します。
-   データ型: `BOOLEAN`
-   このオプションは、値`false`でデフォルトで無効になっています。このオプションを有効にするには、このオプションをコマンドに追加し、値`true`を渡すか、値を渡さないようにする必要があります。

## 出力 {#outputs}

tiup-clusterの実行ログ。

[&lt;&lt; 前のページに戻る - TiUP クラスタコマンド リスト](/tiup/tiup-component-cluster.md#command-list)
