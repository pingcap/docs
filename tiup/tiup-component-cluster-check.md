---
title: tiup cluster check
---

# tiup cluster check {#tiup-cluster-check}

正式な本番環境の場合、環境を稼働させる前に、一連のチェックを実行して、クラスターが最高のパフォーマンスを発揮していることを確認する必要があります。手動チェック手順を簡素化するために、TiUP Clusterは、指定されたクラスタのターゲットマシンのハードウェアおよびソフトウェア環境が正常に動作するための要件を満たしているかどうかをチェックする`check`コマンドを提供します。

## チェック項目一覧 {#list-of-check-items}

### オペレーティングシステムのバージョン {#operating-system-version}

デプロイされたマシンのオペレーティングシステムの配布とバージョンを確認してください。現在、CentOS7のみの展開がサポートされています。互換性を向上させるために、今後のリリースではより多くのシステムバージョンがサポートされる可能性があります。

### CPU EPOLLEXCLUSIVE {#cpu-epollexclusive}

ターゲットマシンのCPUがEPOLLEXCLUSIVEをサポートしているかどうかを確認します。

### numactl {#numactl}

numactlがターゲットマシンにインストールされているかどうかを確認します。タイドコアがターゲットマシンで構成されている場合は、numactlをインストールする必要があります。

### システム時刻 {#system-time}

ターゲットマシンのシステム時刻が同期されているかどうかを確認します。ターゲットマシンのシステム時間を中央制御マシンのシステム時間と比較し、偏差が特定のしきい値（500ミリ秒）を超えるとエラーを報告します。

### システムのタイムゾーン {#system-time-zone}

ターゲットマシンのシステムタイムゾーンが同期されているかどうかを確認します。これらのマシンのタイムゾーン構成を比較し、タイムゾーンに一貫性がない場合はエラーを報告してください。

### 時刻同期サービス {#time-synchronization-service}

ターゲットマシンに時刻同期サービスが設定されているか確認してください。つまり、ntpdが実行されているかどうかを確認します。

### スワップパーティショニング {#swap-partitioning}

ターゲットマシンでスワップパーティショニングが有効になっているかどうかを確認します。スワップパーティショニングを無効にすることをお勧めします。

### カーネルパラメータ {#kernel-parameters}

次のカーネルパラメータの値を確認してください。

-   `net.ipv4.tcp_tw_recycle` ：0
-   `net.ipv4.tcp_syncookies` ：0
-   `net.core.somaxconn` ：32768
-   `vm.swappiness` ：0
-   `vm.overcommit_memory` ：0または1
-   `fs.file-max` ：1000000

### 透明な巨大ページ（THP） {#transparent-huge-pages-thp}

ターゲットマシンでTHPが有効になっているかどうかを確認します。 THPを無効にすることをお勧めします。

### システム制限 {#system-limits}

`/etc/security/limits.conf`のファイルの制限値を確認してください。

```
<deploy-user> soft nofile 1000000
<deploy-user> hard nofile 1000000
<deploy-user> soft stack 10240
```

`<deploy-user>`はTiDBクラスタをデプロイして実行するユーザーであり、最後の列はシステムに必要な最小値です。

### SELinux {#selinux}

SELinuxが有効になっているかどうかを確認します。 SELinuxを無効にすることをお勧めします。

### ファイアウォール {#firewall}

FirewallDサービスが有効になっているか確認してください。 FirewallDサービスを無効にするか、TiDBクラスタの各サービスにアクセス許可ルールを追加することをお勧めします。

### irqbalance {#irqbalance}

irqbalanceサービスが有効になっているかどうかを確認します。 irqbalanceサービスを有効にすることをお勧めします。

### ディスクマウントオプション {#disk-mount-options}

ext4パーティションのマウントオプションを確認してください。マウントオプションにnodelallocオプションとnoatimeオプションが含まれていることを確認してください。

### ポートの使用法 {#port-usage}

トポロジで定義されたポート（オートコンプリートのデフォルトポートを含む）が、ターゲットマシンのプロセスによってすでに使用されているかどうかを確認します。

> **ノート：**
>
> ポート使用状況チェックは、クラスタがまだ開始されていないことを前提としています。クラスタがすでにデプロイされて開始されている場合、この場合はポートが使用されている必要があるため、クラスタのポート使用状況チェックは失敗します。

### CPUコア番号 {#cpu-core-number}

ターゲットマシンのCPU情報を確認してください。本番クラスタの場合、CPU論理コアの数は16以上にすることをお勧めします。

> **ノート：**
>
> CPUコア番号はデフォルトではチェックされていません。チェックを有効にするには、コマンドに`-enable-cpu`オプションを追加する必要があります。

### メモリー容量 {#memory-size}

ターゲットマシンのメモリサイズを確認してください。本番クラスタの場合、合計メモリー容量は32GB以上にすることをお勧めします。

> **ノート：**
>
> デフォルトでは、メモリサイズはチェックされていません。チェックを有効にするには、コマンドに`-enable-mem`オプションを追加する必要があります。

### Fioディスクパフォーマンステスト {#fio-disk-performance-test}

フレキシブルI/Oテスター（fio）を使用して、 `data_dir`が配置されているディスクのパフォーマンスをテストします。これには、次の3つのテスト項目が含まれます。

-   fio_randread_write_latency
-   fio_randread_write
-   fio_randread

> **ノート：**
>
> デフォルトでは、fioディスクのパフォーマンステストは実行されません。テストを実行するには、コマンドに`-enable-disk`オプションを追加する必要があります。

## 構文 {#syntax}

```shell
tiup cluster check <topology.yml | cluster-name> [flags]
```

-   クラスタがまだデプロイされていない場合は、クラスタのデプロイに使用される[トポロジ.yml](/tiup/tiup-cluster-topology-reference.md)のファイルを渡す必要があります。このファイルの内容によると、tiup-clusterは対応するマシンに接続してチェックを実行します。
-   クラスタがすでにデプロイされている場合は、 `<cluster-name>`をチェックオブジェクトとして使用できます。

> **ノート：**
>
> チェックに`<cluster-name>`を使用する場合は、コマンドに`--cluster`オプションを追加する必要があります。

## オプション {#options}

### - 申し込み {#apply}

-   失敗したチェック項目を自動的に修復しようとします。現在、tiup-clusterは次のチェック項目の修復のみを試みます。
    -   SELinux
    -   ファイアウォール
    -   irqbalance
    -   カーネルパラメータ
    -   システム制限
    -   THP（透明な巨大なページ）
-   データ型： `BOOLEAN`
-   このオプションは、デフォルトで`false`の値で無効になっています。このオプションを有効にするには、このオプションをコマンドに追加し、 `true`の値を渡すか、値を渡さないようにします。

### -クラスタ {#cluster}

-   チェックがデプロイされたクラスターに対するものであることを示します。
-   データ型： `BOOLEAN`
-   このオプションは、デフォルトで`false`の値で無効になっています。このオプションを有効にするには、このオプションをコマンドに追加し、 `true`の値を渡すか、値を渡さないようにします。

> **ノート：**
>
> tiup-clusterは、次のコマンド形式で、デプロイされていないクラスターとデプロイされたクラスターの両方のチェックをサポートします。
>
> ```shell
> tiup cluster check <topology.yml | cluster-name> [flags]
> ```
>
> `tiup cluster check <cluster-name>`コマンドを使用する場合は、 `--cluster`オプションを追加する必要があります： `tiup cluster check <cluster-name> --cluster` 。

### -N、-node {#n-node}

-   チェックするノードを指定します。このオプションの値は、ノードIDのコンマ区切りのリストです。 [`tiup cluster display`](/tiup/tiup-component-cluster-display.md)コマンドによって返されるクラスタステータステーブルの最初の列からノードIDを取得できます。
-   データ型： `STRINGS`
-   このオプションがコマンドで指定されていない場合、デフォルトですべてのノードがチェックされます。

> **ノート：**
>
> `-R, --role`オプションを同時に指定すると、 `-N, --node`と`-R, --role`の両方の仕様に一致するサービスノードのみがチェックされます。

### -R、-role {#r-role}

-   チェックする役割を指定します。このオプションの値は、ノードの役割のコンマ区切りのリストです。 [`tiup cluster display`](/tiup/tiup-component-cluster-display.md)コマンドによって返されるクラスタステータステーブルの2番目の列からノードの役割を取得できます。
-   データ型： `STRINGS`
-   このオプションがコマンドで指定されていない場合、すべての役割がデフォルトでチェックされます。

> **ノート：**
>
> `-N, --node`オプションを同時に指定すると、 `-N, --node`と`-R, --role`の両方の仕様に一致するサービスノードのみがチェックされます。

### --enable-cpu {#enable-cpu}

-   CPUコア番号のチェックを有効にします。
-   データ型： `BOOLEAN`
-   このオプションは、デフォルトで`false`の値で無効になっています。このオプションを有効にするには、このオプションをコマンドに追加し、 `true`の値を渡すか、値を渡さないようにします。

### --enable-disk {#enable-disk}

-   fioディスクパフォーマンステストを有効にします。
-   データ型： `BOOLEAN`
-   このオプションは、デフォルトで`false`の値で無効になっています。このオプションを有効にするには、このオプションをコマンドに追加し、 `true`の値を渡すか、値を渡さないようにします。

### --enable-mem {#enable-mem}

-   メモリサイズチェックを有効にします。
-   データ型： `BOOLEAN`
-   このオプションは、デフォルトで`false`の値で無効になっています。このオプションを有効にするには、このオプションをコマンドに追加し、 `true`の値を渡すか、値を渡さないようにします。

### --u、-user {#u-user}

-   ターゲットマシンに接続するためのユーザー名を指定します。指定されたユーザーは、ターゲットマシンでパスワードなしのsudoroot権限を持っている必要があります。
-   データ型： `STRING`
-   このオプションがコマンドで指定されていない場合、コマンドを実行するユーザーがデフォルト値として使用されます。

> **ノート：**
>
> このオプションは、 `-cluster`のオプションがfalseの場合にのみ有効です。それ以外の場合、このオプションの値は、クラスタ展開のトポロジーファイルで指定されたユーザー名に固定されます。

### -i、-identity_file {#i-identity-file}

-   ターゲットマシンに接続するためのキーファイルを指定します。
-   データ型： `STRING`
-   このオプションはデフォルトで有効になっており、 `~/.ssh/id_rsa` （デフォルト値）が渡されます。

> **ノート：**
>
> このオプションは、 `--cluster`のオプションがfalseの場合にのみ有効です。それ以外の場合、このオプションの値は`${TIUP_HOME}/storage/cluster/clusters/<cluster-name>/ssh/id_rsa`に固定されます。

### -p、-password {#p-password}

-   ターゲットマシンに接続するときにパスワードを使用してログインします。
    -   クラスタに`--cluster`オプションが追加された場合、パスワードは、クラスタがデプロイされたときにトポロジー・ファイルで指定されたユーザーのパスワードです。
    -   クラスタに`--cluster`オプションが追加されていない場合、パスワードは`-u/--user`オプションで指定されたユーザーのパスワードです。
-   データ型： `BOOLEAN`
-   このオプションは、デフォルトで`false`の値で無効になっています。このオプションを有効にするには、このオプションをコマンドに追加し、 `true`の値を渡すか、値を渡さないようにします。

### -h, --help {#h-help}

-   関連するコマンドのヘルプ情報を出力します。
-   データ型： `BOOLEAN`
-   このオプションは、デフォルトで`false`の値で無効になっています。このオプションを有効にするには、このオプションをコマンドに追加し、 `true`の値を渡すか、値を渡さないようにします。

## 出力 {#output}

次のフィールドを含むテーブル：

-   `Node` ：ターゲットノード
-   `Check` ：チェック項目
-   `Result` ：チェック結果（合格、警告、または不合格）
-   `Message` ：結果の説明

[&lt;&lt;前のページに戻る-TiUPクラスターコマンドリスト](/tiup/tiup-component-cluster.md#command-list)
