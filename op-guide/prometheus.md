# Use Prometheus and Grafana in TiDB

This page shows you how to deploy Prometheus and Grafana.  

## Preparation
Before you start, make sure you have: 

+ Installed the [Pushgateway](https://github.com/prometheus/pushgateway) and [Prometheus](https://prometheus.io/docs/introduction/install)
+ Started the TiDB/TiKV/PD with [metrics-addr](https://github.com/pingcap/docs/blob/master/op-guide/configuration.md)

## Step 1. Configure the Prometheus

See the following `prometheus.yml` as an example:

```yaml
#global config
global:
  scrape_interval:     15s # By default, scrape targets every 15 seconds.

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.

# scrape_configs:
# The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
#  - job_name: 'prometheus'

#    Override the global default and scrape targets from this job every 5 seconds.
#    scrape_interval: 5s
#    static_configs:
#      - targets: ['localhost:9090']

scrape_configs:
  - job_name: "cluster"

    # Override the global default and scrape targets from this job every 5 seconds.
    # scrape_interval: "5s"

    # honor_labels controls how Prometheus handles conflicts between labels that are
    # already present in scraped data and labels that Prometheus would attach
    # server-side ("job" and "instance" labels, manually configured target
    # labels, and labels generated by service discovery implementations).
    #
    # If honor_labels is set to "true", label conflicts are resolved by keeping label
    # values from the scraped data and ignoring the conflicting server-side labels.
    #
    # If honor_labels is set to "false", label conflicts are resolved by renaming
    # conflicting labels in the scraped data to "exported_<original-label>" (for
    # example "exported_instance", "exported_job") and then attaching server-side
    # labels. This is useful for use cases such as federation, where all labels
    # specified in the target should be preserved.
    
    honor_labels: true

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.
    # here target used pushgateway address.
    static_configs:
      - targets: ['192.168.199.118:9091'] 

```

**Note**:
 - If you use pushgateway, set `honor_labels:true`.
 - If you use Docker start TiDB, add the `-h $HOSTNAME` option to define the hostname in Docker. Then, you can start Prometheus using the `prometheus.yml` file.


## Step 2. Monitor TiDB with Prometheus and Grafana 

Grafana supports querying Prometheus. We use Grafana to show the querying result.

### Install the [Grafana](http://docs.grafana.org/)

### Open Grafana in your browser

You can use the default address: [http://localhost:3000]() and the default login credential: "admin" / "admin".

### Creating a Prometheus data source

To create a Prometheus data source:

1. Click the Grafana logo to open the sidebar menu.
2. Click "Data Sources" in the sidebar.
3. Click "Add data source".
4. Specify the name for the data source. Note: The Name of the data source must be consistent with the name in the .json file in the [Creating a Grafana dashboard] (#creating-a-grafana-dashboard) section. For example, if you specify the Name as "pingcap", the data source name in the [tidb-grafana.json] (https://github.com/pingcap/docs/blob/master/etc/tidb-grafana.json) file is also "pingcap". 
5. Select "Prometheus" as the Type.
6. Set the appropriate Prometheus server URL (for example, http://localhost:9090/).
7. Configure other data source settings.
8. Click "Add" to save the new data source.

See the following snapshot as an example of data source configuration:

![image alt text](datasource.png)    

### Creating a Grafana dashboard

Import the data source to add a new Grafana dashboard:

1. Click the Grafana logo to open the sidebar menu.
2. On the sidebar menu, click "Dashboards" -> "Import" to open the "Import Dashboard" window. 
3. Click "Upload .json File" to upload a JSON file. See [tidb-grafana.json](https://github.com/pingcap/docs/blob/master/etc/tidb-grafana.json) as an example. 
4. Click "Save & Open". A Prometheus dashboard is created.
