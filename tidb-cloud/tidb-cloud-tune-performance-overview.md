---
title: Overview for Analyzing and Tuning Performance
summary: Learn about how to analyze and tune SQL performance in TiDB Cloud.
---

# パフォーマンスの分析と調整の概要 {#overview-for-analyzing-and-tuning-performance}

このドキュメントでは、 TiDB CloudでSQLパフォーマンスを分析および調整するのに役立つ手順について説明します。

## ユーザーの応答時間 {#user-response-time}

ユーザー応答時間は、アプリケーションがリクエストの結果をユーザーに返すのにかかる時間を示します。次の順次タイミング図からわかるように、一般的なユーザー要求の時間には次のものが含まれます。

-   ユーザーとアプリケーション間のネットワーク遅延
-   アプリケーションの処理時間
-   アプリケーションとデータベース間の相互作用中のネットワーク遅延
-   データベースのサービス時間

ユーザーの応答時間は、ネットワーク遅延と帯域幅、同時ユーザーの数と要求の種類、サーバーのCPUとI / Oのリソース使用量など、要求チェーン上のさまざまなサブシステムの影響を受けます。システム全体を効果的に最適化するには、最初にユーザーの応答時間のボトルネックを特定する必要があります。

指定した時間範囲（ `ΔT` ）内の合計ユーザー応答時間を取得するには、次の式を使用できます。

`ΔT`の合計ユーザー応答時間=平均TPS（ `ΔT`秒あたりのトランザクション数）x平均ユーザー応答時間x3。

![user\_response\_time](/media/performance/user_response_time_en.png)

## ユーザーの応答時間とシステムスループットの関係 {#relationship-between-user-response-time-and-system-throughput}

ユーザー応答時間は、サービス時間、キューイング時間、およびユーザー要求を完了するための同時待機時間で構成されます。

```
User Response time = Service time + Queuing delay + Coherency delay
```

-   サービス時間：システムが要求を処理するときに特定のリソースで消費する時間。たとえば、データベースがSQL要求を完了するために消費するCPU時間。
-   キューイング遅延：システムが要求を処理するときに特定のリソースのサービスをキューで待機する時間。
-   コヒーレンシ遅延：システムが他の並行タスクと通信およびコラボレーションする時間。これにより、要求を処理するときに共有リソースにアクセスできます。

システムスループットは、1秒あたりにシステムが完了できる要求の数を示します。ユーザーの応答時間とスループットは通常、互いに逆です。スループットが増加すると、それに応じて、要求されたサービスのシステムリソース使用率とキューイング遅延が増加します。リソース使用率が特定の変曲点を超えると、キューイングの待ち時間が大幅に増加します。

たとえば、OLTPロードを実行しているデータベースシステムの場合、CPU使用率が65％を超えると、CPUキューイングのスケジューリング遅延が大幅に増加します。これは、システムの同時要求が完全に独立しているわけではないためです。つまり、これらの要求は協調して共有リソースをめぐって競合する可能性があります。たとえば、異なるユーザーからの要求は、同じデータに対して相互に排他的なロック操作を実行する場合があります。リソースの使用率が高くなると、キューイングとスケジューリングの待ち時間も長くなり、共有リソースを時間内に解放できなくなり、他のタスクによる共有リソースの待機時間が長くなります。

## ユーザー応答時間のボトルネックのトラブルシューティング {#troubleshoot-bottlenecks-in-user-response-time}

TiDB Cloudコンソールには、ユーザーの応答時間のトラブルシューティングに役立つページがいくつかあります。

-   **概要**：このタブでは、合計QPS、遅延、接続、要求QPS、要求期間、ストレージサイズ、CPU、IO読み取り、IO書き込みなどのTiDBメトリックを表示できます。
-   **診断**：

    -   **ステートメント**を使用すると、ページでSQLの実行を直接監視し、システムテーブルにクエリを実行せずにパフォーマンスの問題を簡単に見つけることができます。 SQLステートメントをクリックすると、トラブルシューティングと分析のためにクエリの実行プランをさらに表示できます。 SQLパフォーマンスチューニングの詳細については、 [SQLチューニングの概要](/tidb-cloud/tidb-cloud-sql-tuning-overview.md)を参照してください。
    -   **Key Visualizer**は、TiDBのデータアクセスパターンとデータホットスポットを監視するのに役立ちます。

追加のメトリックが必要な場合は、 [PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に連絡できます。

遅延とパフォーマンスの問題が発生した場合は、分析とトラブルシューティングについて、次のセクションの手順を参照してください。

### TiDBクラスタ外のボトルネック {#bottlenecks-outside-the-tidb-cluster}

[**概要**]タブで遅延（P80）を確認します。この値がユーザー応答時間のP80値よりもはるかに低い場合は、主なボトルネックがTiDBクラスタの外部にある可能性があると判断できます。この場合、次の手順を使用してボトルネックのトラブルシューティングを行うことができます。

1.  [[概要]タブ](/tidb-cloud/monitor-tidb-cluster.md)の左側にあるTiDBのバージョンを確認してください。 v6.0.0以前のバージョンの場合は、 [PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に連絡して、準備済みプランキャッシュ、ラフトエンジン、およびTiKVAsyncIO機能を有効にできるかどうかを確認することをお勧めします。これらの機能をアプリケーション側の調整とともに有効にすると、スループットパフォーマンスが大幅に向上し、遅延とリソース使用率が削減されます。
2.  必要に応じて、TiDBトークンの制限を増やしてスループットを上げることができます。
3.  準備済みプランのキャッシュ機能が有効になっていて、ユーザー側でJDBCを使用する場合は、次の構成を使用することをお勧めします。

    ```
    useServerPrepStmts=true&cachePrepStmts=true& prepStmtCacheSize=1000&prepStmtCacheSqlLimit=20480&useConfigs=maxPerformance
    ```

    JDBCを使用せず、現在のTiDBクラスタのプリペアドプランキャッシュ機能を最大限に活用したい場合は、クライアント側でプリペアドステートメントオブジェクトをキャッシュする必要があります。 StmtPrepareおよびStmtCloseへの呼び出しをリセットする必要はありません。各クエリで呼び出されるコマンドの数を3から1に減らします。パフォーマンス要件とクライアント側の変更の量に応じて、開発作業が必要になります。あなたは助けのために[PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)を調べることができます。

### TiDBクラスタのボトルネック {#bottlenecks-in-the-tidb-cluster}

パフォーマンスのボトルネックがTiDBクラスタ内にあると判断した場合は、次のことを行うことをお勧めします。

-   遅いSQLクエリを最適化します。
-   ホットスポットの問題を解決します。
-   クラスタをスケールアウトして、容量を拡張します。

#### 遅いSQLクエリを最適化する {#optimize-slow-sql-queries}

SQLパフォーマンスチューニングの詳細については、 [SQLチューニングの概要](/tidb-cloud/tidb-cloud-sql-tuning-overview.md)を参照してください。

#### ホットポットの問題を解決する {#resolve-hotstpot-issues}

[キービジュアライザータブ](/tidb-cloud/tune-performance.md#key-visualizer)でホットスポットの問題を表示できます。次のスクリーンショットは、サンプルのヒートマップを示しています。マップの水平座標は時間であり、垂直座標はテーブルとインデックスです。明るい色はトラフィックが多いことを示します。ツールバーで読み取りまたは書き込みトラフィックの表示を切り替えることができます。

![Hotspot issues](/media/tidb-cloud/tidb-cloud-troubleshoot-hotspot.png)

次のスクリーンショットは、書き込みホットスポットの例を示しています。明るい対角線（対角線上または対角線下）が書き込みフローグラフに表示され、書き込みトラフィックは線の終わりにのみ表示されます。テーブルRegionsの数が増えると、段階的なパターンになります。これは、テーブルに書き込みホットスポットがあることを示しています。書き込みホットスポットが発生した場合は、自己インクリメント型の主キーを使用しているか、主キーを使用していないか、または時間依存の挿入ステートメントまたはインデックスを使用しているかどうかを確認する必要があります。

![Write hotspot](/media/tidb-cloud/tidb-cloud-troubleshoot-write-hotspot.png)

次のスクリーンショットに示すように、読み取りホットスポットは通常、ヒートマップで明るい水平線として表されます。通常は、クエリの数が多い小さなテーブルです。

![Read hotspot](/media/tidb-cloud/tidb-cloud-troubleshoot-read-hotspot-new.png)

次のスクリーンショットに示すように、強調表示されたブロックにカーソルを合わせると、トラフィックの多いテーブルまたはインデックスが表示されます。

![Hotspot index](/media/tidb-cloud/tidb-cloud-troubleshoot-hotspot-index.png)

#### 規格外 {#scale-out}

クラスタ[概要](/tidb-cloud/monitor-tidb-cluster.md)ページで、ストレージスペース、CPU使用率、およびTiKVIOレートメトリックを確認します。それらのいずれかが長期間上限に達している場合、現在のクラスタサイズがビジネス要件を満たしていない可能性があります。クラスタをスケールアウトする必要があるかどうかを確認するには、 [PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に連絡することをお勧めします。

#### その他の問題 {#other-issues}

以前の方法でパフォーマンスの問題を解決できない場合は、 [PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に問い合わせてください。トラブルシューティングプロセスをスピードアップするために、次の情報を提供することをお勧めします。

-   クラスタID
-   発行間隔と同等の通常間隔
-   問題の現象と予想される動作
-   読み取りまたは書き込みの比率や主要な動作などのビジネスワークロードの特性

## 概要 {#summary}

一般に、次の最適化方法を使用して、パフォーマンスの問題を分析および解決できます。

| アクション                          | 効果                                                                                                 |
| :----------------------------- | :------------------------------------------------------------------------------------------------- |
| 準備された計画キャッシュ+JDBC              | スループットパフォーマンスが大幅に向上し、遅延が大幅に削減され、平均TiDBCPU使用率が大幅に削減されます。                                            |
| TiKVでAsyncIOとRaft-engineを有効にする | スループットパフォーマンスがいくらか改善されます。有効にするには、 [PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に連絡する必要があります。 |
| クラスター化されたインデックス                | スループットパフォーマンスが大幅に向上します。                                                                            |
| TiDBノードをスケールアウトする              | スループットパフォーマンスが大幅に向上します。                                                                            |
| クライアント側の最適化。 1つのJVMを3つに分割します   | スループットのパフォーマンスは大幅に向上し、さらに分割するとスループット容量がさらに向上する可能性があります。                                            |
| アプリケーションとデータベース間のネットワーク遅延を制限する | ネットワークの待ち時間が長いと、スループットが低下し、待ち時間が長くなる可能性があります。                                                      |

将来的には、 TiDB Cloudは、より観察可能なメトリックと自己診断サービスを導入する予定です。これらは、パフォーマンスメトリックのより包括的な理解と、エクスペリエンスを向上させるための運用上のアドバイスを提供します。
