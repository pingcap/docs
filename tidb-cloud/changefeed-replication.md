---
title: TiDB Cloud Replication
summary: Learn how to create a replica to stream data from a primary TiDB cluster to a secondary TiDB cluster.
---

# TiDBクラウドレプリケーション {#tidb-cloud-replication}

TiDBクラウドレプリケーションは、TiDBクラウドのプライマリTiDBクラスタ用に継続的にレプリケートされる読み取り可能なセカンダリTiDBクラスタを作成できるようにする機能です。この読み取り可能なセカンダリクラスタ（クロスリージョンレプリケーション、セカンダリレプリケーション、またはジオレプリケーションとも呼ばれます）は、プライマリTiDBクラスタと同じリージョンに配置することも、より一般的には別のリージョンに配置することもできます。

TiDB Cloud Replicationを使用すると、地域の災害や大規模な障害が発生した場合にデータベースの迅速なディザスタリカバリを実行でき、ビジネスの継続性を実現できます。セカンダリクラスタが設定されると、別のリージョンのセカンダリクラスタへの地理的なフェールオーバーを手動で開始できます。

> **警告：**
>
> 現在、 **TiDBクラウドレプリケーション**機能は<strong>パブリックプレビュー</strong>にあり、次の制限があります。
>
> -   1つのプライマリクラスタは1つのレプリケーションのみを持つことができます。
> -   別のクラスタへの**TiDBクラウドレプリケーション**のソースとしてセカンダリクラスタを使用することはできません。
> -   **TiDBクラウドレプリケーション**は[**ApacheKafkaにシンクします**](/tidb-cloud/changefeed-sink-to-apache-kafka.md)と[**MySQLにシンク**](/tidb-cloud/changefeed-sink-to-mysql.md)と矛盾します。 <strong>TiDBクラウドレプリケーション</strong>が有効になっている場合、プライマリクラスターもセカンダリクラスタも<strong>Sink</strong> <strong>toApacheKafka</strong>またはSinktoMySQLチェンジフィードを使用できず、その逆も可能です。
> -   TiDBクラウドはTiCDCを使用してレプリケーションを確立するため、同じ[TiCDCとしての制限](https://docs.pingcap.com/tidb/stable/ticdc-overview#restrictions)があります。

アプリケーションのレプリケーションをサポートするには、アプリケーションをプライマリリージョンとセカンダリリージョンの両方にデプロイし、各アプリケーションが同じリージョンのTiDBクラスタに接続されていることを確認する必要があります。セカンダリリージョンのアプリケーションはスタンバイ状態です。プライマリリージョンに障害が発生した場合、「デタッチ」操作を開始してセカンダリリージョンのTiDBクラスタをアクティブにし、すべてのデータトラフィックをセカンダリリージョンのアプリケーションに転送できます。

次の図は、TiDBクラウドレプリケーションを使用した地理冗長クラウドアプリケーションの一般的な展開を示しています。

<!-- https://www.figma.com/file/DaevXzW4aq35QodwZEkcTS/DBaaS-Architecture-Chart-(high-level)-(Copy)?node-id=0%3A1 -->

![TiDB Cloud Replication](/media/tidb-cloud/changefeed-replication-deployment.png)

セカンダリTiDBクラスタの作成は、ビジネス継続性ソリューションの一部にすぎません。壊滅的な障害の後にアプリケーション（またはサービス）をエンドツーエンドで回復するには、アプリケーションのすべてのコンポーネントと依存サービスを復元できることも確認する必要があります。

-   アプリケーションの各コンポーネントが同じ障害に対して回復力があり、アプリケーションの目標復旧時間（RTO）内に利用可能になるかどうかを確認します。アプリケーションの一般的なコンポーネントには、クライアントソフトウェア（カスタムJavaScriptを備えたブラウザーなど）、Webフロントエンド、ストレージ、およびDNSが含まれます。
-   依存するすべてのサービスを特定し、これらのサービスの保証と機能を確認し、これらのサービスのフェイルオーバー中にアプリケーションが動作していることを確認します。

## TiDBクラウドレプリケーションの用語と機能 {#terminology-and-capabilities-of-tidb-cloud-replication}

### 自動非同期レプリケーション {#automatic-asynchronous-replication}

プライマリTiDBクラスタごとに、作成できるセカンダリクラスタは1つだけです。 TiDB Cloudは、プライマリTiDBクラスタの完全バックアップを作成してから、新しく作成されたセカンダリクラスタにバックアップを復元します。これにより、セカンダリクラスタに既存のデータがすべて含まれるようになります。セカンダリクラスタが作成されると、プライマリクラスタでのすべてのデータ変更がセカンダリクラスタに非同期で複製されます。

### 読み取り可能なセカンダリクラスタ {#readable-secondary-cluster}

セカンダリクラスタは読み取り専用モードです。リアルタイムデータ要件が低い読み取り専用ワークロードがある場合は、それをセカンダリクラスタに分散できます。

同じリージョンで読み取りが集中するシナリオを満たすために、 **TiDB Cloud Replication**を使用して、プライマリクラスタと同じリージョンに読み取り可能なセカンダリクラスタを作成できます。ただし、同じリージョン内のセカンダリクラスタは、大規模な停止や壊滅的な障害に対する追加の復元力を提供しないため、リージョンのディザスタリカバリの目的でフェールオーバーターゲットとして使用しないでください。

### 計画されたデタッチ {#planned-detach}

**Planned Detach**は、手動でトリガーできます。災害復旧訓練など、ほとんどの場合、計画的なメンテナンスに使用されます。<strong>計画されたデタッチ</strong>により、すべてのデータ変更がデータ損失なしにセカンダリクラスタに複製されます（RPO = 0）。 RTOの場合、プライマリクラスターとセカンダリクラスター間のレプリケーションラグに依存します。ほとんどの場合、RTOは数分のレベルです。

**Planned Detach**は、セカンダリクラスタをプライマリクラスタから個々のクラスタにデタッチします。 <strong>Planned Detach</strong>がトリガーされると、次の手順が実行されます。

1.  プライマリクラスタを読み取り専用に設定して、新しいトランザクションがプライマリクラスタにコミットされないようにします。
2.  セカンダリクラスタがプライマリクラスタと完全に同期されるまで待機します。
3.  プライマリクラスターからセカンダリクラスタへのレプリケーションを停止します。
4.  元のセカンダリクラスタを書き込み可能として設定します。これにより、ビジネスにサービスを提供できるようになります。

**Planned Detach**が終了すると、元のプライマリクラスタが読み取り専用に設定されます。それでも元のプライマリクラスタに書き込む必要がある場合は、次のいずれかを実行して、クラスタを明示的に書き込み可能として設定できます。

-   クラスタの詳細ページに移動し、[**設定]**をクリックして、[<strong>書き込み可能</strong>にする]ドロップダウンボタンをクリックします。
-   元のプライマリクラスタのSQLポートに接続し、次のステートメントを実行します。

    {{< copyable "" >}}

    ```sql
    set global tidb_super_read_only=OFF;
    ```

### 強制デタッチ {#force-detach}

計画外の停止から回復するには、 **ForceDetach**を使用します。プライマリクラスタが配置されているリージョンで壊滅的な障害が発生した場合は、 <strong>Force Detach</strong>を使用して、セカンダリクラスタができるだけ早くビジネスにサービスを提供し、ビジネスの継続性を確保できるようにする必要があります。この操作により、セカンダリクラスタがすぐに個別のクラスタとして機能し、複製されていないデータを待機しないため、RPOはプライマリ-セカンダリ複製ラグに依存し、RTOは<strong>強制デタッチ</strong>がトリガーされる速度に依存します。

**Force Detach**は、セカンダリクラスタをプライマリクラスタから個々のクラスタにデタッチします。 <strong>Force Detach</strong>がトリガーされると、次の手順が実行されます。

1.  プライマリクラスターからセカンダリクラスタへのデータレプリケーションをすぐに停止します。
2.  元のセカンダリクラスタを書き込み可能として設定して、ワークロードの提供を開始できるようにします。
3.  元のプライマリクラスタに引き続きアクセスできる場合、または元のプライマリクラスタが回復した場合、TiDBクラウドはそれを読み取り専用に設定して、新しいトランザクションがコミットされないようにします。

元のプライマリクラスタが停止から回復した後も、2つのクラスターのデータを比較することにより、元のプライマリクラスタで実行されたが、元のセカンダリクラスタでは実行されなかったトランザクションを確認し、手動でレプリケートするかどうかを決定する機会があります。これらの非同期トランザクションは、ビジネスの状況に基づいて元のセカンダリクラスタに送信されます。

セカンダリクラスターをデタッチすると、プライマリクラスターとセカンダリクラスター間のデータレプリケーショントポロジは存在しなくなりクラスタ。元のプライマリクラスタは読み取り専用モードに設定され、元のセカンダリクラスタは書き込み可能になります。元のプライマリクラスタでDMLまたはDDLが計画されている場合は、次のいずれかを実行して、読み取り専用モードを手動で無効にする必要があります。

-   クラスタの詳細ページに移動し、[**設定]**をクリックして、[<strong>書き込み可能</strong>にする]ドロップダウンボタンをクリックします。
-   元のプライマリクラスタのSQLポートに接続し、次のステートメントを実行します。

    {{< copyable "" >}}

    ```sql
    set global tidb_super_read_only=OFF;
    ```

## TiDBクラウドレプリケーションを構成する {#configure-tidb-cloud-replication}

TiDBクラウドレプリケーションを構成するには、次の手順を実行します。

1.  **TiDB**クラスタの[チェンジフィード]タブに移動します。
2.  [ **TiDBクラスターのレプリカを作成する]を**クリックします。
3.  データベースのユーザー名とパスワードを入力します。
4.  セカンダリクラスタのリージョンを選択します。
5.  [**作成]**をクリックします。しばらくすると、シンクが動作を開始し、シンクのステータスが「<strong>生産</strong>中」に変わります。

**PlannedDetach**または<strong>ForceDetach</strong>をトリガーするには、次の手順を実行します。

1.  **TiDB**クラスタの[チェンジフィード]タブに移動します。
2.  [ **TiDBクラスターのレプリカを作成する]を**クリックします。
3.  [**計画されたデタッチ]**または[<strong>強制デタッチ</strong>]をクリックします。

## プライマリクラスタをスケーリングする {#scale-the-primary-cluster}

セカンダリクラスタを切断せずに、プライマリクラスタでスケールアウトまたはスケールアウトできます。プライマリクラスタがスケーリングされると、セカンダリクラスタは自動的に同じスケーリングに従います。

## プライマリ-セカンダリラグを監視します {#monitor-the-primary-secondary-lag}

RPOに関するラグを監視するには、次の手順を実行します。

1.  **TiDB**クラスタの[チェンジフィード]タブに移動します。
2.  [ **TiDBクラスターのレプリカを作成する]を**クリックします。
3.  プライマリ-セカンダリクラスタのラグを確認できます。
