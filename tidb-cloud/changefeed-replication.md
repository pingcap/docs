---
title: TiDB Cloud Replication
summary: TiDB Cloudレプリケーションは、プライマリ TiDB クラスター用に読み取り可能なセカンダリ TiDB クラスターを作成できる機能です。地域的な災害や障害が発生した場合にデータベースの迅速な災害復旧を実行でき、ビジネス継続性の実現に役立ちます。セカンダリ クラスターがセットアップされたら、別のリージョンにあるセカンダリ クラスターへの地理的フェールオーバーを手動で開始できます。ただし、現在はベータ版であり、いくつかの制限があります。TiDB Cloudレプリケーションはリクエストがあった場合にのみ利用可能です。
---

# TiDB Cloudレプリケーション {#tidb-cloud-replication}

TiDB Cloudレプリケーションは、 TiDB Cloud内のプライマリ TiDB クラスター用に、継続的に複製された読み取り可能なセカンダリ TiDB クラスターを作成できる機能です。この読み取り可能なセカンダリ クラスター (クロスリージョン レプリケーション、セカンダリ レプリケーション、または geo レプリケーションとも呼ばれます) は、プライマリ TiDB クラスターと同じリージョンに存在することも、より一般的には異なるリージョンに存在することもできます。

TiDB Cloudレプリケーションを使用すると、地域的な災害や大規模な障害が発生した場合にデータベースの迅速な災害復旧を実行でき、ビジネス継続性の実現に役立ちます。セカンダリ クラスターがセットアップされたら、別のリージョンにあるセカンダリ クラスターへの地理的フェールオーバーを手動で開始できます。

> **警告：**
>
> 現在、 **TiDB Cloudレプリケーション**機能はベータ版であり、次の制限があります。
>
> -   1 つのプライマリ クラスターはレプリケーションを 1 つだけ持つことができます。
> -   セカンダリ クラスターを別のクラスターへの**TiDB Cloudレプリケーション**のソースとして使用することはできません。
> -   **TiDB Cloudレプリケーションは**[**Apache Kafka にシンクする**](/tidb-cloud/changefeed-sink-to-apache-kafka.md)と[**MySQL にシンクする**](/tidb-cloud/changefeed-sink-to-mysql.md)に矛盾します。 **TiDB Cloudレプリケーション**が有効になっている場合、プライマリ クラスターもセカンダリ クラスターも、 **Sink to Apache Kafka**または**Sink to MySQL**変更フィードを使用できず、その逆も同様です。
> -   TiDB Cloud はTiCDC を使用してレプリケーションを確立するため、同じ[TiCDC としての制限](https://docs.pingcap.com/tidb/stable/ticdc-overview#restrictions)を持ちます。
> -   **TiDB Cloudレプリケーションは**リクエストがあった場合にのみ利用可能です。この機能をリクエストするには、 **「?」**をクリックしてください。 [TiDB Cloudコンソール](https://tidbcloud.com)の右下隅にある**[サポートをリクエスト]**をクリックします。次に、「**説明**」フィールドに「 TiDB Cloudレプリケーションの申請」と入力し、 **「送信」**をクリックします。

アプリケーションのレプリケーションをサポートするには、アプリケーションをプライマリ リージョンとセカンダリ リージョンの両方にデプロイし、各アプリケーションが同じリージョン内の TiDB クラスターに接続されていることを確認する必要があります。セカンダリ リージョンのアプリケーションはスタンバイ状態です。プライマリ リージョンに障害が発生した場合、「デタッチ」操作を開始してセカンダリ リージョンの TiDB クラスターをアクティブにし、すべてのデータ トラフィックをセカンダリ リージョンのアプリケーションに転送できます。

次の図は、 TiDB Cloudレプリケーションを使用した地理冗長クラウド アプリケーションの一般的なデプロイメントを示しています。

<!-- https://www.figma.com/file/DaevXzW4aq35QodwZEkcTS/DBaaS-Architecture-Chart-(high-level)-(Copy)?node-id=0%3A1 -->

![TiDB Cloud Replication](/media/tidb-cloud/changefeed-replication-deployment.png)

セカンダリ TiDB クラスターの作成は、ビジネス継続性ソリューションの一部にすぎません。壊滅的な障害が発生した後にアプリケーション (またはサービス) をエンドツーエンドで回復するには、アプリケーションのすべてのコンポーネントと依存サービスが復元できることを確認する必要もあります。

-   アプリケーションの各コンポーネントが同じ障害に対して回復力があり、アプリケーションの目標復旧時間 (RTO) 以内に使用可能になるかどうかを確認します。アプリケーションの一般的なコンポーネントには、クライアント ソフトウェア (カスタム JavaScript を備えたブラウザなど)、Web フロント エンド、storage、DNS などがあります。
-   すべての依存サービスを特定し、これらのサービスの保証と機能を確認し、これらのサービスのフェールオーバー中にアプリケーションが動作していることを確認します。

## TiDB Cloudレプリケーションの用語と機能 {#terminology-and-capabilities-of-tidb-cloud-replication}

### 自動非同期レプリケーション {#automatic-asynchronous-replication}

プライマリ TiDB クラスターごとに、セカンダリ クラスターを 1 つだけ作成できます。 TiDB Cloudは、プライマリ TiDB クラスターの完全バックアップを作成し、そのバックアップを新しく作成されたセカンダリ クラスターに復元します。これにより、セカンダリ クラスターにすべての既存データが確実に保持されます。セカンダリ クラスタが作成されると、プライマリ クラスタ上のすべてのデータ変更がセカンダリ クラスタに非同期的にレプリケートされます。

### 読み取り可能なセカンダリ クラスター {#readable-secondary-cluster}

セカンダリ クラスタは読み取り専用モードです。リアルタイム データ要件が低い読み取り専用ワークロードがある場合は、それをセカンダリ クラスターに分散できます。

同じリージョン内で読み取り集中型のシナリオを満たすには、 **TiDB Cloudレプリケーション**を使用して、プライマリ クラスターと同じリージョンに読み取り可能なセカンダリ クラスターを作成できます。ただし、同じリージョン内のセカンダリ クラスターは、大規模な停止や壊滅的な障害に対する追加の回復力を提供しないため、リージョンのディザスター リカバリーを目的としたフェールオーバー ターゲットとして使用しないでください。

### 計画的な切り離し {#planned-detach}

**計画的デタッチは**手動でトリガーできます。ほとんどの場合、災害復旧訓練などの計画的なメンテナンスに使用されます。**計画的デタッチにより**、すべてのデータ変更がデータ損失なしでセカンダリ クラスターにレプリケートされます (RPO=0)。 RTO の場合、プライマリ クラスタとセカンダリ クラスタ間のレプリケーション ラグに依存します。ほとんどの場合、RTO は数分のレベルです。

**計画的デタッチは、**セカンダリ クラスタをプライマリ クラスタから個別のクラスタに切り離します。**計画的デタッチ**がトリガーされると、次の手順が実行されます。

1.  プライマリ クラスターを読み取り専用として設定し、新しいトランザクションがプライマリ クラスターにコミットされないようにします。
2.  セカンダリ クラスタがプライマリ クラスタと完全に同期されるまで待機します。
3.  プライマリ クラスタからセカンダリ クラスタへのレプリケーションを停止します。
4.  元のセカンダリ クラスターを書き込み可能として設定し、ビジネスに使用できるようにします。

**計画的デタッチ**が完了すると、元のプライマリ クラスターは読み取り専用として設定されます。元のプライマリ クラスターに書き込む必要がある場合は、次のいずれかを実行してクラスターを明示的に書き込み可能に設定できます。

-   クラスターの詳細ページに移動し、 **[設定]**をクリックして、 **[書き込み可能にする]**ドロップダウン ボタンをクリックします。
-   元のプライマリ クラスターの SQL ポートに接続し、次のステートメントを実行します。

    ```sql
    set global tidb_super_read_only=OFF;
    ```

### 強制的に切り離す {#force-detach}

計画外の停止から回復するには、 **Force Detach**を使用します。プライマリ クラスターが配置されているリージョンで致命的な障害が発生した場合は、セカンダリ クラスターができるだけ早くビジネスにサービスを提供し、ビジネスの継続性を確保できるように、**強制デタッチ**を使用する必要があります。この操作により、セカンダリ クラスターがすぐに個別のクラスターとして機能し、レプリケートされていないデータを待機しないため、RPO はプライマリとセカンダリのレプリケーション ラグに依存し、RTO は**強制デタッチ**がトリガーされる速さに依存します。

**Force Detach は、**セカンダリ クラスタをプライマリ クラスタから個別のクラスタに切り離します。**強制デタッチ**がトリガーされると、次の手順が実行されます。

1.  プライマリ クラスターからセカンダリ クラスターへのデータ レプリケーションをただちに停止します。
2.  元のセカンダリ クラスターを書き込み可能に設定して、ワークロードの処理を開始できるようにします。
3.  元のプライマリ クラスターにまだアクセスできる場合、または元のプライマリ クラスターが回復した場合、 TiDB Cloudはそれを読み取り専用として設定し、新しいトランザクションがコミットされるのを回避します。

元のプライマリ クラスターが停止から回復した後も、2 つのクラスター内のデータを比較することによって、元のプライマリ クラスターで実行されたが元のセカンダリ クラスターでは実行されなかったトランザクションを確認し、手動でレプリケートするかどうかを決定する機会が得られます。ビジネス状況に基づいて、これらの非同期トランザクションを元のセカンダリ クラスターに転送します。

セカンダリ クラスタを切断すると、プライマリ クラスタとセカンダリ クラスタ間のデータ レプリケーション トポロジは存在しなくなります。元のプライマリ クラスタは読み取り専用モードに設定され、元のセカンダリ クラスタは書き込み可能になります。元のプライマリ クラスターで DML または DDL が計画されている場合は、次のいずれかを実行して、読み取り専用モードを手動で無効にする必要があります。

-   クラスターの詳細ページに移動し、 **[設定]**をクリックして、 **[書き込み可能にする]**ドロップダウン ボタンをクリックします。
-   元のプライマリ クラスターの SQL ポートに接続し、次のステートメントを実行します。

    ```sql
    set global tidb_super_read_only=OFF;
    ```

## TiDB Cloudレプリケーションの構成 {#configure-tidb-cloud-replication}

TiDB Cloudレプリケーションを構成するには、次の手順を実行します。

1.  [TiDB Cloudコンソール](https://tidbcloud.com)で、TiDB クラスターのクラスター概要ページに移動し、左側のナビゲーション ペインで**[Changefeed]**をクリックします。
2.  **[TiDBクラスタのレプリカを作成する]**をクリックします。
3.  データベースのユーザー名とパスワードを入力します。
4.  セカンダリ クラスターのリージョンを選択します。
5.  **「作成」**をクリックします。しばらくすると、シンクが作業を開始し、シンクのステータスが「**生産中**」に変わります。

**Planned Detach**または**Force Detach**をトリガーするには、次の手順を実行します。

1.  [TiDB Cloudコンソール](https://tidbcloud.com)で、TiDB クラスターのクラスター概要ページに移動し、左側のナビゲーション ペインで**[Changefeed]**をクリックします。
2.  **[TiDBクラスタのレプリカを作成する]**をクリックします。
3.  **[計画的なデタッチ]**または**[強制的なデタッチ]**をクリックします。

## プライマリクラスターをスケールする {#scale-the-primary-cluster}

セカンダリ クラスタを切断せずに、プライマリ クラスタをスケールアウトまたはスケールインできます。プライマリ クラスターがスケーリングされると、セカンダリ クラスターも同じスケーリングに自動的に従います。

## 一次-二次ラグを監視する {#monitor-the-primary-secondary-lag}

RPO に関する遅延を監視するには、次の手順を実行します。

1.  [TiDB Cloudコンソール](https://tidbcloud.com)で、TiDB クラスターのクラスター概要ページに移動し、左側のナビゲーション ペインで**[Changefeed]**をクリックします。
2.  **[TiDBクラスタのレプリカを作成する]**をクリックします。
3.  プライマリ - セカンダリ クラスターの遅れがわかります。
