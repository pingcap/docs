---
title: TiDB Cloud Serverless 的高可用性
summary: 了解 TiDB Cloud Serverless 的高可用性架构。探索分区高可用性和区域高可用性选项、自动备份、故障转移流程，以及 TiDB 如何确保数据持久性和业务连续性。
---

# TiDB Cloud Serverless 的高可用性

TiDB Cloud Serverless 默认设计了强大的机制来保持高可用性和数据持久性，防止单点故障，并确保即使在发生中断时也能持续提供服务。作为基于经过实战考验的 TiDB 开源产品的全托管服务，它继承了 TiDB 的核心高可用（HA）特性，并结合了额外的云原生能力。

## 概述

TiDB 通过 Raft 一致性算法来确保高可用性和数据持久性。该算法会将数据变更一致地复制到多个节点，即使在节点故障或网络分区的情况下，TiDB 也能处理读写请求。这种方式同时提供了高数据持久性和容错能力。

TiDB Cloud Serverless 通过两种高可用性选项扩展了这些能力，以满足不同的运维需求：

- **分区高可用性（默认）**：该选项将所有节点部署在同一个可用区内，从而降低网络延迟。它无需应用层跨区冗余即可实现高可用性，适用于优先考虑单区低延迟的应用。分区高可用性在所有支持 TiDB Cloud Serverless 的区域均可用。更多信息，参见 [分区高可用性架构](#zonal-high-availability-architecture)。

- **区域高可用性（测试版）**：该选项将节点分布在多个可用区，实现最大程度的基础设施隔离和冗余。它提供最高级别的可用性，但需要应用层实现跨区冗余。如果你需要最大程度防护单区基础设施故障，建议选择该选项。需要注意的是，这会增加延迟，并可能产生跨区数据传输费用。该功能仅在支持多可用区的特定区域可用，并且只能在集群创建时启用。更多信息，参见 [区域高可用性架构](#regional-high-availability-architecture)。

## 分区高可用性架构

> **注意：**
>
> 分区高可用性是默认选项，并在所有支持 TiDB Cloud Serverless 的 AWS 区域可用。

当你以默认的分区高可用性创建集群时，所有组件，包括 Gateway、TiDB、TiKV 和 TiFlash 计算/写入节点，都会运行在同一个可用区内。这些组件在数据平面上的部署通过虚拟机池提供基础设施冗余，从而最大程度减少故障转移时间和由于同地部署带来的网络延迟。

![TiDB Cloud Serverless zonal high availability](/media/tidb-cloud/serverless-zonal-high-avaliability-aws.png)

在分区高可用性架构中：

- Placement Driver（PD）部署在多个可用区，实现跨区冗余数据复制以确保高可用性。
- 数据会在本地可用区内的 TiKV 服务器和 TiFlash 写入节点之间复制。
- TiDB 服务器和 TiFlash 计算节点从 TiKV 和 TiFlash 写入节点读取和写入数据，这些节点通过存储层复制机制得到保护。

### 故障转移流程

TiDB Cloud Serverless 为你的应用确保了透明的故障转移流程。在故障转移期间：

- 会创建一个新的副本来替换故障副本。

- 提供存储服务的服务器会从 Amazon S3 持久化数据中恢复本地缓存，将系统恢复到与副本一致的状态。

在存储层，持久化数据会定期推送到 Amazon S3，以实现高持久性。此外，最新的数据不仅会在多个 TiKV 服务器之间复制，还会存储在每台服务器的 EBS 上，EBS 也会进一步复制数据以增强持久性。TiDB 会自动在毫秒级别进行退避和重试，确保故障转移过程对客户端应用无缝。

网关和计算层是无状态的，因此故障转移只需立即在其他地方重启即可。应用应实现连接重试逻辑。虽然分区部署提供了高可用性，但无法应对整个可用区的故障。如果该区不可用，将会发生停机，直到该区及其依赖服务恢复。

## 区域高可用性架构

当你以区域高可用性创建集群时，关键的 OLTP（联机事务处理）工作负载组件，如 PD 和 TiKV，会部署在多个可用区，实现冗余复制并最大化可用性。在正常运行期间，Gateway、TiDB 和 TiFlash 计算/写入节点等组件会托管在主可用区。这些数据平面组件通过虚拟机池提供基础设施冗余，从而最大程度减少故障转移时间和由于同地部署带来的网络延迟。

> **注意：**
>
> - 区域高可用性目前为测试版，仅在 AWS 东京（`ap-northeast-1`）区域可用。
> - 区域高可用性只能在集群创建时启用。

![TiDB Cloud Serverless regional high availability](/media/tidb-cloud/serverless-regional-high-avaliability-aws.png)

在区域高可用性架构中：

- Placement Driver（PD）和 TiKV 部署在多个可用区，数据始终在各区间冗余复制，以确保最高级别的可用性。
- 数据会在主可用区内的 TiFlash 写入节点之间复制。
- TiDB 服务器和 TiFlash 计算节点从这些 TiKV 和 TiFlash 写入节点读取和写入数据，这些节点通过存储层复制机制得到保护。

### 故障转移流程

在极少数情况下，主可用区发生故障（如自然灾害、配置变更、软件问题或硬件故障），关键的 OLTP 工作负载组件，包括 Gateway 和 TiDB，会自动在备用可用区启动。流量会自动重定向到备用区，以确保快速恢复并保持业务连续性。

TiDB Cloud Serverless 通过以下措施，在主可用区故障时最大程度减少服务中断并确保业务连续性：

- 自动在备用可用区创建 Gateway 和 TiDB 的新副本。
- 通过弹性负载均衡器检测备用可用区的活跃 Gateway 副本，并将 OLTP 流量从故障主区重定向到备用区。

除了通过 TiKV 复制提供高可用性外，TiKV 实例还会部署并配置为将每个数据副本放置在不同的可用区。只要有两个可用区正常运行，系统就能保持可用性。为实现高持久性，数据会定期备份到 S3。即使两个可用区同时故障，存储在 S3 上的数据依然可访问和恢复。

应用不会受到非主可用区故障的影响，也不会感知到此类事件。在主可用区故障期间，Gateway 和 TiDB 会在备用可用区启动以处理工作负载。请确保你的应用实现重试逻辑，将新请求重定向到备用可用区的活跃服务器。

## 自动备份与持久性

数据库备份对于业务连续性和灾难恢复至关重要，有助于防止数据损坏或意外删除。通过备份，你可以在保留期内将数据库恢复到某个时间点，最大程度减少数据丢失和停机时间。

TiDB Cloud Serverless 提供了强大的自动备份机制，确保持续的数据保护：

- **每日全量备份**：每天会创建一次数据库的全量备份，捕获整个数据库的状态。
- **持续事务日志备份**：事务日志会持续备份，大约每 5 分钟一次，具体频率取决于数据库活动量。

这些自动备份使你可以通过全量备份或结合全量备份与持续事务日志，将数据库恢复到某个特定时间点。这种灵活性确保你可以将数据库恢复到事故发生前的精确时间点。

> **注意：**
>
> 自动备份（包括基于快照的备份和用于时间点恢复（PITR）的持续备份）均在 Amazon S3 上执行，S3 提供区域级别的高持久性。

## 故障期间对会话的影响

在故障发生时，正在故障服务器上运行的事务可能会被中断。虽然故障转移对应用是透明的，但你必须实现逻辑来处理活动事务中的可恢复故障。不同的故障场景处理方式如下：

- **TiDB 故障**：如果 TiDB 实例发生故障，客户端连接不会受到影响，因为 TiDB Cloud Serverless 会自动通过 Gateway 重路由流量。虽然在故障 TiDB 实例上的事务可能会被中断，但系统会确保已提交的数据被保留，新事务会由其他可用的 TiDB 实例处理。
- **Gateway 故障**：如果 Gateway 发生故障，客户端连接会被中断。但 TiDB Cloud Serverless 的 Gateway 是无状态的，可以立即在新的可用区或服务器上重启。流量会自动重定向到新的 Gateway，最大程度减少停机时间。

建议你在应用中实现重试逻辑以处理可恢复故障。具体实现细节请参考你的驱动或 ORM 文档（例如 [JDBC](https://dev.mysql.com/doc/connector-j/en/connector-j-config-failover.html)）。

## RTO 和 RPO

在制定业务连续性计划时，请考虑以下两个关键指标：

- 恢复时间目标（RTO）：应用在发生中断事件后完全恢复所能接受的最长时间。
- 恢复点目标（RPO）：在从计划外中断事件恢复时，应用可容忍丢失的最近数据更新的最长时间间隔。

下表对比了每种高可用性选项的 RTO 和 RPO：

| 高可用性架构           | RTO（停机时间）           | RPO（数据丢失） |
|------------------------|--------------------------|-----------------|
| 分区高可用性           | 近 0 秒                  | 0               |
| 区域高可用性           | 通常小于 600 秒          | 0               |