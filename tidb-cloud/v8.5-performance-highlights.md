---
title: TiDB Cloud Performance Highlights for TiDB v8.5.0
summary: TiDB バージョン v8.5.0 では、 TiDB Cloud Dedicated クラスターのパフォーマンスが向上しました。
---

# TiDB v8.5.0 のTiDB Cloudパフォーマンスのハイライト {#tidb-cloud-performance-highlights-for-tidb-v8-5-0}

[TiDB v8.5.0](https://docs.pingcap.com/tidb/stable/release-8.5.0)は重要な長期サポート (LTS) リリースであり、パフォーマンス、スケーラビリティ、運用効率が大幅に向上しています。

このドキュメントでは、次の領域における v8.5.0 のパフォーマンス改善について概説します。

-   全体的なパフォーマンス
-   過剰なMVCCバージョンによるホットスポット読み取り
-   IOレイテンシージッター
-   バッチ処理
-   TiKVスケーリングパフォーマンス

## 全体的なパフォーマンス {#general-performance}

デフォルトのリージョンサイズが 96 MiB から 256 MiB に増加し、v8.5.0 ではその他のいくつかの改善も行われたため、パフォーマンスが大幅に向上しました。

-   `oltp_insert`パフォーマンスが 27% 向上します。
-   `Analyze`パフォーマンスは約 45% の大幅な向上を示します。

## 過剰なMVCCバージョンによるホットスポット読み取り {#hotspot-reads-with-excessive-mvcc-versions}

### チャレンジ {#challenge}

一部のユーザー シナリオでは、次のような課題が発生する可能性があります。

-   頻繁なバージョン更新: 一部のワークロードでは、データが非常に頻繁に更新され、読み取られます。
-   履歴バージョンの長期保存：特定の時点へのフラッシュバックのサポートといったビジネス要件を満たすために、ユーザーはGC（ガベージコレクション）時間を過度に長く（例えば24時間など）設定することがあります。その結果、多版型同時実行制御（MVCC）バージョンが過剰に蓄積され、クエリの効率が大幅に低下します。

MVCC バージョンが蓄積されると、要求されたデータと処理されたデータの間に大きなギャップが生じ、読み取りパフォーマンスが低下します。

### 解決 {#solution}

この問題に対処するため、TiKVでは[インメモリエンジン（IME）](https://docs.pingcap.com/tidb/stable/tikv-in-memory-engine)導入しています。最新バージョンをメモリにキャッシュすることで、TiKVは履歴バージョンが読み取りパフォーマンスに与える影響を軽減し、クエリ効率を大幅に向上させます。

### テスト環境 {#test-environment}

-   クラスタトポロジ: TiDB (16 vCPU、32 GiB) * 1 + TiKV (16 vCPU、32 GiB) * 6

-   クラスタ構成:

        tikv_configs:
        [in-memory-engine]
        enable = true

-   データセット: 頻繁に更新されるデータを含む、約 340 のリージョンを持つ 24 GiB のstorageサイズ

-   ワークロード: スキャンを必要とする行には、頻繁な更新によって導入された多数の MVCC バージョンが含まれています。

### テスト結果 {#test-results}

クエリのレイテンシーは50% 減少し、スループットは 100% 増加します。

| コンフィグレーション | 期間（秒） | スレッド | TPS   | QPS    | 平均レイテンシー（ミリ秒） | P95レイテンシー(ミリ秒) |
| ---------- | ----- | ---- | ----- | ------ | ------------- | -------------- |
| IMEを無効にする  | 3600  | 10   | 123.8 | 1498.3 | 80.76         | 207.82         |
| IMEを有効にする  | 3600  | 10   | 238.2 | 2881.5 | 41.99         | 78.60          |

## IOレイテンシージッター {#io-latency-jitter}

### チャレンジ {#challenge}

クラウド環境では、クラウドディスクにおける一時的または持続的なIOレイテンシーの変動が一般的な課題となります。こうした変動はリクエストレイテンシーの増大を招き、タイムアウト、エラー、通常の業務運用の中断を引き起こし、最終的にはサービス品質の低下につながります。

### 解決 {#solution}

TiDB v8.5.0 では、クラウド ディスク IO ジッターによるパフォーマンスへの影響を軽減するための複数の機能強化が導入されています。

-   **Leader書き込み最適化**: リーダーがコミットされたがまだ永続化されていないRaftログを早期に適用できるようにし、リーダー ピアの書き込みレイテンシーに対する IO ジッターの影響を軽減します。

-   **低速ノード検出の強化**：低速ノード検出アルゴリズムを改良し、デフォルトで低速スコア検出を有効にしました。これにより、低速ノードが特定されると、エビクトリーダースケジューラがトリガーされ、パフォーマンスが回復します。2 [遅いノード検出メカニズム](https://docs.pingcap.com/tidb/v8.5/pd-scheduling-best-practices#troubleshoot-tikv-node) [低速ストアの排除スケジューラ](https://docs.pingcap.com/tidb/v8.5/pd-control#scheduler-show--add--remove--pause--resume--config--describe)を使用して低速ノードを検出・管理し、クラウドディスクジッターの影響を軽減します。

-   **統合ヘルスコントローラー**：TiKVに統合ヘルスコントローラーを追加し、KVクライアントにフィードバックメカニズムを追加します。KVクライアントは、TiKVノードのヘルスとパフォーマンスに基づいて、エラー処理とレプリカ選択を最適化します。

-   **改良されたレプリカ セレクター**: KV クライアントにレプリカ セレクター V2 が導入され、不要な再試行やバックオフ操作を排除する改良された状態遷移が実現しました。

-   **追加の修正と改善**: TiKV のストア ループでの不要な IO 操作を回避しながら、リージョン キャッシュや KV クライアント ヘルス チェッカーなどの重要なコンポーネントの機能強化が含まれています。

### テスト環境 {#test-environment}

-   クラスタトポロジ: TiDB (32 vCPU、64 GiB) * 3 + TiKV (32 vCPU、64 GiB) * 6
-   ワークロード: 読み取り/書き込み比率 2:1、クラウド ディスク IO の遅延または 1 つの TiKV ノードでのハングをシミュレート

### テスト結果 {#test-results}

前述のテスト設定に基づいて、複数の IO 遅延シナリオでのフェイルオーバーが改善され、影響時の P99/999レイテンシーが最大 98% 削減されました。

次のテスト結果の表では、 **「現在」の**列には IOレイテンシージッターを削減するための改善を加えた結果が表示され、 **「オリジナル」の**列にはこれらの改善を加えていない結果が表示されます。

<table><thead><tr><th rowspan="2">ワークロードの説明</th><th colspan="2">フェイルオーバー時間</th><th colspan="2">衝撃時の最大レイテンシー（P999）</th><th colspan="2">衝撃時の最大レイテンシー（P99）</th></tr><tr><th>現在</th><th>オリジナル</th><th>現在</th><th>オリジナル</th><th>現在</th><th>オリジナル</th></tr></thead><tbody><tr><td>2ミリ秒のIO遅延が10分間続く</td><td>ほとんど効果なし</td><td>フェイルオーバーは利用できません</td><td>14ミリ秒</td><td>232ミリ秒</td><td>7.9ミリ秒</td><td>22.9ミリ秒</td></tr><tr><td>5ミリ秒のIO遅延が10分間続く</td><td>2分</td><td>フェイルオーバーは利用できません</td><td>37.9ミリ秒</td><td>462ミリ秒</td><td>10ミリ秒</td><td>246ミリ秒</td></tr><tr><td>10ミリ秒のIO遅延が10分間続く</td><td>3分</td><td>フェイルオーバーは利用できません</td><td>69ミリ秒</td><td>3秒</td><td>25ミリ秒</td><td>1.45秒</td></tr><tr><td>50ミリ秒のIO遅延が10分間続く</td><td>3分</td><td>フェイルオーバーは利用できません</td><td>1.36秒</td><td>13.2秒</td><td>238ミリ秒</td><td>6.7秒</td></tr><tr><td>100ミリ秒のIO遅延が10分間続く</td><td>3分</td><td>フェイルオーバーは利用できません</td><td>7.53秒</td><td>32秒</td><td>1.7秒</td><td>26秒</td></tr></tbody></table>

### さらなる改善 {#further-improvements}

ディスクジッターの重大度は、ユーザーのワークロードプロファイルにも大きく関係する可能性があります。レイテンシの影響を受けやすいシナリオでは、TiDBの機能と組み合わせてアプリケーションを設計することで、アプリケーションへのIOジッターの影響をさらに最小限に抑えることができます。例えば、読み取り負荷が高くレイテンシの影響を受けやすい環境では、レイテンシー要件に応じて[`tikv_client_read_timeout`](/system-variables.md#tikv_client_read_timeout-new-in-v740)システム変数を調整し、ステイルリードまたはフォロワーリードを使用することで、TiDBから送信されたKVリクエストに対する他のレプリカピアへのフェイルオーバー再試行を高速化できます。これにより、単一のTiKVノードへのIOジッターの影響が軽減され、クエリレイテンシーの改善に役立ちます。この機能の有効性はワークロードプロファイルに依存するため、実装前に評価する必要があります。

さらに、ユーザー[パブリッククラウドへのTiDBの導入](https://docs.pingcap.com/tidb/dev/best-practices-on-public-cloud)は、より高性能なクラウド ディスクを選択することで、ジッターの可能性を減らすことができます。

## バッチ処理 {#batch-processing}

### チャレンジ {#challenge}

大量データ更新、システム移行、ETLワークフローといった大規模トランザクションは、数百万行に及ぶ処理を伴い、重要な業務をサポートする上で不可欠です。TiDBは分散SQLデータベースとして優れた性能を発揮しますが、このような大規模なトランザクションの処理には、2つの大きな課題があります。

-   メモリ制限：TiDB v8.1.0より前のバージョンでは、トランザクションライフサイクル全体を通じてすべてのトランザクション変更がメモリ内に保持されるため、リソースに負担がかかり、パフォーマンスが低下します。数百万行に及ぶ操作では、メモリ使用量が過剰になり、場合によってはリソース不足によりOut of Memory（OOM）エラーが発生する可能性があります。

-   パフォーマンスの低下：大規模なメモリ内バッファの管理は赤黒木に依存しており、計算オーバーヘッドが発生します。バッファが大きくなると、これらのデータ構造に固有の*O(N log N)の*計算量により、バッファ操作が遅くなります。

### 解決 {#solution}

これらの課題は、スケーラビリティの向上、複雑さの軽減、信頼性の向上を実現する明確な機会を浮き彫りにしています。現代のデータワークロードの増加に伴い、TiDBは大規模トランザクションの処理を最適化し、リソース利用率と全体的なパフォーマンスを向上させるように設計された[パイプラインDML](https://docs.pingcap.com/tidb/stable/system-variables#tidb_dml_type-new-in-v800)機能を導入しました。

### テスト環境 {#test-environment}

-   クラスタトポロジ: TiDB (16 vCPU、32 GiB) * 1 + TiKV (16 vCPU、32 GiB) * 3
-   データセット: 1,000万行（約10GiBのデータ）のYCSB非クラスタ化テーブル。ホットスポットパターンの影響を分離・評価するため、特定のテストでは主キーを部分的に削除しています。
-   ワークロード: `INSERT` `UPDATE`含む`DELETE`操作。

### テスト結果 {#test-results}

実行速度は 2 倍になり、最大 TiDBメモリ使用量は 50% 減少し、TiKV 書き込みフローはよりスムーズになります。

-   レイテンシ（秒）

    | ワークロード（10 GiB） | 標準DML | パイプラインDML | 改善      |
    | -------------- | ----- | --------- | ------- |
    | YCSB-挿入-10M    | 368   | 159       | 131.45% |
    | YCSBアップデート10M  | 255   | 131       | 94.66%  |
    | YCSB-削除-10M    | 136   | 42        | 223.81% |

-   TiDBメモリ使用量のピーク (GiB)

    | ワークロード（10 GiB） | 標準DML | パイプラインDML | 削減     |
    | -------------- | ----- | --------- | ------ |
    | YCSB-挿入-10M    | 25.8  | 12        | 53.49% |
    | YCSBアップデート10M  | 23.1  | 12.9      | 44.16% |
    | YCSB-削除-10M    | 10.1  | 8.08      | 20.00% |

## TiKVスケーリングパフォーマンス {#tikv-scaling-performance}

### チャレンジ {#challenge}

水平スケーリングはTiKVの中核機能であり、必要に応じてシステムをスケールインまたはスケールアウトできます。ビジネス需要の拡大とテナント数の増加に伴い、TiDBクラスターではデータベース、テーブル、そしてデータ量が急速に増大します。サービス品質を維持するためには、TiKVノードを迅速にスケールアウトすることが不可欠になります。

シナリオによっては、TiDB が多数のデータベースとテーブルをホストすることがあります。これらのテーブルが小さい場合や空の場合、TiKV は多数の小さなリージョンを蓄積します。特にテーブル数が大規模（100万以上など）になると、その傾向が顕著になります。これらの小さなリージョンは、メンテナンスの負担を大きくし、リソースのオーバーヘッドを増加させ、効率を低下させます。

### 解決 {#solution}

この問題に対処するため、TiDB v8.5.0では、小規模なリージョンのマージパフォーマンスが向上し、内部オーバーヘッドが削減され、リソース使用率が向上しました。さらに、TiDB v8.5.0には、TiKVのスケーリングパフォーマンスをさらに向上させるためのいくつかの機能強化も含まれています。

### テスト環境 {#test-environment}

#### 小さな地域の統合 {#merging-small-regions}

-   クラスタトポロジ: TiDB (16 vCPU、32 GiB) * 1 + TiKV (16 vCPU、32 GiB) * 3
-   データセット: 約 100 万個の小さなテーブル (各テーブルのサイズは 2 MiB 未満)
-   ワークロード: 小さなリージョンの自動マージ

#### TiKVノードのスケールアウト {#scaling-out-tikv-nodes}

-   クラスタトポロジ: TiDB (16 vCPU、32 GiB) * 1 + TiKV (16 vCPU、32 GiB) * 4
-   データセット: 20,000 の倉庫を含む TPC-C データセット
-   ワークロード: TiKV ノードを 4 から 7 にスケールアウト

### テスト結果 {#test-results}

小さなリージョンの結合速度が約 10 倍向上します。

| メトリック         | 改善がなければ | 改善により |
| ------------- | ------- | ----- |
| リージョン統合期間（時間） | 20      | 2     |

TiKV スケーリング パフォーマンスは 40% 以上向上し、TiKV ノードのスケールアウト時間は 30% 短縮されます。

| メトリック               | 改善がなければ | 改善により |
| ------------------- | ------- | ----- |
| TiKV スケールアウト期間 (時間) | 5       | 3.5   |

## ベンチマーク {#benchmark}

前述のテスト データに加えて、v8.5.0 のパフォーマンスに関する次のベンチマーク結果を参照できます。

-   [TPC-Cパフォーマンステストレポート](/tidb-cloud/v8.5-performance-benchmarking-with-tpcc.md)
-   [Sysbenchパフォーマンステストレポート](/tidb-cloud/v8.5-performance-benchmarking-with-sysbench.md)
