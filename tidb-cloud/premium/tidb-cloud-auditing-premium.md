---
title: "TiDB Cloud Premium Database Audit Logging"
summary: TiDB Cloud Premium でインスタンスを監査する方法を学びます。
---

# TiDB Cloud Premium データベース監査ログ {#tidb-cloud-premium-database-audit-logging}

TiDB Cloud は、実行された SQL ステートメントなど、データベースへのユーザー アクセス アクティビティを記録する監査ログ機能を提供します。

組織のユーザー アクセス ポリシーやその他の情報セキュリティ対策の有効性を評価するには、データベース監査ログを定期的に分析することがセキュリティのベスト プラクティスです。

監査ログ機能は**デフォルトで無効になっています**。TiDBインスタンスを監査するには、まず監査ログを有効にし、次に監査フィルタルールを設定する必要があります。

> **注記：**
>
> 監査ログはインスタンスのリソースを消費するため、インスタンスを監査するかどうかは慎重に検討する必要があります。

## 前提条件 {#prerequisites}

-   TiDB Cloud Premium インスタンスを使用しています。

    > **注記：**
    >
    > -   データベース監査ログは、 TiDB Cloud Starter では使用できません。
    > -   TiDB Cloud Essential については、 [TiDB Cloud Essential のデータベース監査ログ (ベータ版)](/tidb-cloud/essential-database-audit-logging.md)参照してください。
    > -   TiDB Cloud Dedicated については、 [TiDB Cloud専用データベース監査ログ](/tidb-cloud/tidb-cloud-auditing.md)参照してください。

-   組織内で`Organization Owner`ロールを持っている必要があります。そうでない場合、 TiDB Cloudコンソールでデータベース監査関連のオプションを表示できません。

## 監査ログを有効にする {#enable-audit-logging}

TiDB Cloudは、 TiDB Cloud Premiumインスタンスの監査ログをクラウドstorageサービスに記録することをサポートしています。データベース監査ログを有効にする前に、インスタンスが配置されているクラウドプロバイダーでクラウドstorageサービスを設定してください。

### AWS 上の TiDB の監査ログを有効にする {#enable-audit-logging-for-tidb-on-aws}

AWS の監査ログを有効にするには、次の手順を実行します。

#### ステップ1. Amazon S3バケットを作成する {#step-1-create-an-amazon-s3-bucket}

TiDB Cloud が監査ログを書き込む宛先として、組織所有の AWS アカウント内の Amazon S3 バケットを指定します。

> **注記：**
>
> AWS S3バケットでオブジェクトロックを有効にしないでください。オブジェクトロックを有効にすると、 TiDB Cloudが監査ログファイルをS3にプッシュできなくなります。

詳細については、AWS ユーザーガイドの[汎用バケットの作成](https://docs.aws.amazon.com/AmazonS3/latest/userguide/create-bucket-overview.html)参照してください。

#### ステップ2. Amazon S3アクセスを構成する {#step-2-configure-amazon-s3-access}

1.  監査ログを有効にする TiDB インスタンスのTiDB Cloudアカウント ID と外部 ID を取得します。

    1.  TiDB Cloudコンソールで、 [**TiDBインスタンス**](https://tidbcloud.com/instances)ページに移動します。

    2.  ターゲット インスタンスの名前をクリックして概要ページに移動し、左側のナビゲーション ペインで**[設定]** &gt; **[DB 監査ログ]**をクリックします。

    3.  **DB 監査ログ**ページで、右上隅の**[有効化]**をクリックします。

    4.  **データベース監査ログのストレージコンフィグレーション**ダイアログで、 **AWS IAMポリシー設定**セクションを見つけて、後で使用するために**TiDB Cloudアカウント ID**と**TiDB Cloud外部 ID**を記録します。

2.  AWS マネジメントコンソールで、 **IAM** &gt;**アクセス管理**&gt;**ポリシー**に移動し、書き込み専用権限`s3:PutObject`を持つstorageバケットポリシーがあるかどうかを確認します。

    -   はいの場合は、後で使用するために一致したstorageバケット ポリシーを記録します。
    -   そうでない場合は、 **「IAM」** &gt; **「アクセス管理」** &gt; **「ポリシー」** &gt; **「ポリシーの作成」**に移動し、次のポリシー テンプレートに従ってバケット ポリシーを定義します。

        ```json
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": "s3:PutObject",
                    "Resource": "<Your S3 bucket ARN>/*"
                }
            ]
        }
        ```

        テンプレート内の`<Your S3 bucket ARN>`は、監査ログファイルが書き込まれるS3バケットのAmazonリソースネーム（ARN）です。S3バケットの**「プロパティ」**タブに移動し、 **「バケットの概要」**エリアでARN値を確認できます。「 `"Resource"`フィールドでは、ARNの後に`/*`を追加する必要があります。例えば、ARNが`arn:aws:s3:::tidb-cloud-test`の場合、 `"Resource"`フィールドの値を`"arn:aws:s3:::tidb-cloud-test/*"`に設定する必要があります。

3.  **「IAM」** &gt; **「アクセス管理」** &gt; **「ロール」**に移動し、前に記録したTiDB Cloudアカウント ID と外部 ID に対応する信頼エンティティを持つロールがすでに存在するかどうかを確認します。

    -   はいの場合は、後で使用するために一致したロールを記録します。
    -   そうでない場合は、 **「ロールの作成」**をクリックし、信頼エンティティタイプとして**「別のAWSアカウント」を**選択し、 **「アカウント**ID」フィールドにTiDB CloudのアカウントIDを入力します。次に、 **「外部IDが必要」**オプションを選択し、 **「外部ID」**フィールドにTiDB Cloudの外部IDを入力します。

4.  **IAM** &gt;**アクセス管理**&gt;**ロール**で、前の手順のロール名をクリックして**概要**ページに移動し、次の手順を実行します。

    1.  **「権限」**タブで、書き込み専用権限`s3:PutObject`を持つ記録済みのポリシーがロールにアタッチされているかどうかを確認します。アタッチされていない場合は、 **「ポリシーのアタッチ」**を選択し、必要なポリシーを検索して**「ポリシーのアタッチ」を**クリックします。
    2.  **概要**ページに戻り、**ロール ARN**値をクリップボードにコピーします。

#### ステップ3. 監査ログを有効にする {#step-3-enable-audit-logging}

TiDB Cloudコンソールで、 TiDB Cloudアカウント ID と外部 ID 値を取得した**データベース監査ログ ストレージコンフィグレーション**ダイアログに戻り、次の手順を実行します。

1.  **「バケット URI」**フィールドに、監査ログファイルが書き込まれる S3 バケットの URI を入力します。

2.  「**バケットリージョン」**ドロップダウンリストで、バケットが配置されている AWS リージョンを選択します。

3.  **「ロール ARN」**フィールドに、 [ステップ2. Amazon S3アクセスを構成する](#step-2-configure-amazon-s3-access)でコピーしたロール ARN 値を入力します。

4.  **「テスト接続」と「次へ」**をクリックして、 TiDB Cloud がバケットにアクセスして書き込むことができるかどうかを確認します。

    成功した場合は、 **「接続に成功しました」**と表示されます。そうでない場合は、アクセス設定を確認してください。

5.  インスタンスの監査ログを有効にするには、 **「有効」**をクリックします。

    TiDB Cloud は、指定されたインスタンスの監査ログを Amazon S3 バケットに書き込む準備が整いました。

> **注記：**
>
> -   監査ログを有効にした後、バケットのURI、場所、またはARNに新しい変更を加えた場合は、再度**「接続テスト」**をクリックして、 TiDB Cloudがバケットに接続できることを確認してください。その後、 **「有効化」**をクリックして変更を適用してください。
> -   TiDB Cloud の Amazon S3 へのアクセスを削除するには、AWS マネジメントコンソールでこのインスタンスに付与された信頼ポリシーを削除するだけです。

<CustomContent language="en,zh">

### Alibaba Cloud 上の TiDB の監査ログを有効にする {#enable-audit-logging-for-tidb-on-alibaba-cloud}

Alibaba Cloud 上の TiDB クラウドのデータベース監査ログを有効にするには、次の手順を実行します。

#### ステップ1. OSSバケットを作成する {#step-1-create-an-oss-bucket}

TiDB Cloud が監査ログを書き込む宛先として、組織所有の Alibaba Cloud アカウントにオブジェクト ストレージ サービス (OSS) バケットを作成します。

詳細については、Alibaba Cloud Storage ドキュメントの[バケットを作成する](https://www.alibabacloud.com/help/en/oss/user-guide/create-a-bucket-4)参照してください。

#### ステップ2. OSSアクセスを構成する {#step-2-configure-oss-access}

1.  監査ログを有効にする TiDB インスタンスの Alibaba Cloud サービス アカウント ID を取得します。

    1.  TiDB Cloudコンソールで、 [**TiDBインスタンス**](https://tidbcloud.com/instances)ページに移動します。
    2.  ターゲット インスタンスの名前をクリックして概要ページに移動し、左側のナビゲーション ペインで**[設定]** &gt; **[DB 監査ログ]**をクリックします。
    3.  **DB 監査ログ**ページで、右上隅の**[有効化]**をクリックします。
    4.  **データベース監査ログ ストレージコンフィグレーション**ダイアログで、 **Alibaba Cloud RAM ポリシー設定**セクションを見つけて、後で使用するために**TiDB Cloudアカウント ID**と**TiDB Cloud外部 ID**を記録します。

2.  Alibaba Cloud コンソールで、 **「RAM」** &gt; **「Permissions」** &gt; **「Policies」**に移動し、監査ログ OSS バケットの`oss:PutObject`書き込み専用権限を持つポリシーがすでに存在するかどうかを確認します。

    -   はいの場合は、後で使用するためにポリシー名を記録します。

    -   そうでない場合は、 **「ポリシーの作成」**をクリックし、次のポリシー テンプレートを使用してポリシーを定義します。

        ```json
        {
        "Version": "1",
        "Statement": [
            {
            "Effect": "Allow",
            "Action": [
                "oss:PutObject"
            ],
            "Resource": "acs:oss:*:*:<Your-Bucket-Name>/*"
            }
        ]
        }
        ```

    `<Your-Bucket-Name>` TiDB Cloud が監査ログを書き込む OSS バケットの名前に置き換えます。例えば、バケット名が`auditlog-bucket`場合は、 `"Resource": "acs:oss:*:*:auditlog-bucket/*"`使用します。

3.  Alibaba Cloud コンソールで、 **「RAM」** &gt; **「Identities」** &gt; **「Roles」**に移動し、**信頼できるエンティティ**が先ほど記録したTiDB Cloudアカウント ID と外部 ID と一致するロールがすでに存在するかどうかを確認します。

    -   はいの場合は、後で使用するためにロール名を記録します。

    -   そうでない場合は、次の手順に従って**「ロールの作成」を**クリックします。

        1.  ロール作成ページで、 **[ポリシー エディターに切り替える]**をクリックします。
        2.  **[プリンシパル]**の下で**[クラウド アカウント]**を選択し、フィールドに**TiDB Cloudアカウント ID**を入力します。
        3.  **[アクション]**の下で、ドロップダウン リストから**sts:AssumeRole**を選択します。
        4.  **[条件の追加]**をクリックし、次のように条件を設定します。
            -   **キーを**`sts:ExternalId`に設定します。
            -   **演算子を**`StringEquals`に設定します。
            -   **値を****TiDB Cloud外部 ID**に設定します。
        5.  **[OK]**をクリックすると、 **[ロールの作成]**ダイアログが開きます。
        6.  **「ロール名」**フィールドにロール名を入力し、 **「OK」**をクリックしてロールを作成します。

4.  ロールが作成されたら、 **「権限」**タブに移動して**「権限の付与」**をクリックします。

    ダイアログで、次の設定を構成します。

    -   **リソース スコープ**の場合は、**アカウント**を選択します。
    -   **[ポリシー]**フィールドで、先ほど作成した OSS 書き込みポリシーを選択します。
    -   **[権限の付与]**をクリックします。

5.  後で使用するために、**ロール ARN** (例: `acs:ram::<Your-Account-ID>:role/tidb-cloud-audit-role` ) をコピーします。

#### ステップ3. 監査ログを有効にする {#step-3-enable-audit-logging}

TiDB Cloudコンソールで、 TiDB Cloudアカウント ID を取得した**データベース監査ログ ストレージコンフィグレーション**ダイアログに戻り、次の手順を実行します。

1.  **「バケットURI」**フィールドに、OSSバケットのURIを入力します。例： `oss://tidb-cloud-audit-log`

2.  **「バケットリージョン」**フィールドで、バケットが配置されている Alibaba Cloud リージョンを選択します (TiDB インスタンスのリージョンと一致させることをお勧めします)。

3.  **「ロール ARN」**フィールドに、 [ステップ2. OSSアクセスを構成する](#step-2-configure-oss-access)でコピーしたロール ARN 値を貼り付けます。

4.  **「テスト接続」**をクリックして、 TiDB Cloud がOSS バケットにアクセスして書き込むことができるかどうかを確認します。

    -   成功した場合は、 **「接続に成功しました」**と表示されます。
    -   そうでない場合は、OSS バケットの権限、RAM ロールの構成、およびポリシーを確認してください。

5.  インスタンスの監査ログを有効にするには、 **[有効]**をクリックします。

    TiDB Cloud は、指定されたインスタンスの監査ログを OSS バケットに書き込む準備ができています。

> **注記：**
>
> -   監査ログを有効にした後、バケットのURIまたは場所に新たな変更を加えた場合は、 **「接続テスト」**を再度クリックして、TiDB Cloudがバケットに接続できることを確認してください。その後、 **「有効化」**をクリックして変更を適用してください。
> -   TiDB Cloud の OSS バケットへのアクセスを削除するには、Alibaba Cloud コンソールでこのインスタンスに付与された信頼ポリシーを削除します。

</CustomContent>

## 監査フィルタルールを指定する {#specify-auditing-filter-rules}

監査ログを有効にした後、監査フィルタルールを指定して、どのユーザーアクセスイベントをキャプチャし、監査ログに書き込むかを制御する必要があります。フィルタルールが指定されていない場合、 TiDB Cloudは何もログに記録しません。

インスタンスの監査フィルタ ルールを指定するには、次の手順を実行します。

1.  **「DB 監査ログ」**ページで、 **「ログ フィルタ ルール」**セクションの**「フィルタ ルールの追加」**をクリックして、監査フィルタ ルールを追加します。

    一度に追加できる監査ルールは1つだけです。各ルールでは、ユーザー式、データベース式、テーブル式、およびアクセスタイプを指定します。監査要件に合わせて複数の監査ルールを追加できます。

2.  **「ログ フィルター ルール」**セクションで**&gt;**をクリックして展開し、追加した監査ルールのリストを表示します。

> **注記：**
>
> -   フィルタールールは正規表現で、大文字と小文字が区別されます。ワイルドカードルール`.*`を使用すると、インスタンス内のすべてのユーザー、データベース、またはテーブルイベントがログに記録されます。
> -   監査ログはインスタンスリソースを消費するため、フィルタールールの指定には注意が必要です。消費を最小限に抑えるには、可能な限り、監査ログのスコープを特定のデータベースオブジェクト、ユーザー、およびアクションに限定するフィルタールールを指定することをお勧めします。

## 監査ログをビュー {#view-audit-logs}

デフォルトでは、 TiDB Cloud はデータベース監査ログ ファイルをstorageサービスに保存するため、storageサービスから監査ログ情報を読み取る必要があります。

TiDB Cloud監査ログは、インスタンス ID、内部 ID、およびログ作成日が完全修飾ファイル名に組み込まれた読み取り可能なテキスト ファイルです。

たとえば、 `13796619446086334065/tidb-5m5z34/tidb-audit-2022-04-21T18-16-29.529.log` 。この例では、 `13796619446086334065`インスタンス ID を示し、 `tidb-5m5z34`内部 ID を示します。

## 監査ログを無効にする {#disable-audit-logging}

インスタンスの監査が不要になった場合は、インスタンスのページに移動し、 **[設定]** &gt; **[監査設定]**をクリックして、右上隅の監査設定を**[無効]**に切り替えます。

> **注記：**
>
> ログファイルのサイズが10MiBに達するたびに、ログファイルはクラウドstorageバケットにプッシュされます。そのため、監査ログを無効化すると、10MiB未満のログファイルはクラウドstorageバケットに自動的にプッシュされなくなります。この状況でログファイルを取得するには、 [TiDB Cloudサポート](/tidb-cloud/tidb-cloud-support.md)お問い合わせください。

## 監査ログフィールド {#audit-log-fields}

監査ログ内の各データベース イベント レコードに対して、TiDB は次のフィールドを提供します。

> **注記：**
>
> 次の表では、フィールドの最大長が空の場合、このフィールドのデータ型には明確に定義された定数長 (たとえば、INTEGER の場合は 4 バイト) があることを意味します。

| 列番号 | フィールド名    | TiDBデータ型 | 最大長  | 説明                               |
| --- | --------- | -------- | ---- | -------------------------------- |
| 1   | 該当なし      | 該当なし     | 該当なし | 社内使用のために予約済み                     |
| 2   | 該当なし      | 該当なし     | 該当なし | 社内使用のために予約済み                     |
| 3   | 該当なし      | 該当なし     | 該当なし | 社内使用のために予約済み                     |
| 4   | ID        | 整数       |      | 一意のイベントID                        |
| 5   | タイムスタンプ   | タイムスタンプ  |      | イベントの時間                          |
| 6   | イベントクラス   | ヴァルチャー   | 15   | イベントの種類                          |
| 7   | イベントサブクラス | ヴァルチャー   | 15   | イベントのサブタイプ                       |
| 8   | ステータスコード  | 整数       |      | 声明の回答状況                          |
| 9   | コスト_時間    | フロート     |      | 声明に費やされた時間                       |
| 10  | ホスト       | ヴァルチャー   | 16   | サーバーIP                           |
| 11  | クライアントIP  | ヴァルチャー   | 16   | クライアントIP                         |
| 12  | ユーザー      | ヴァルチャー   | 17   | ログインユーザー名                        |
| 13  | データベース    | ヴァルチャー   | 64   | イベント関連データベース                     |
| 14  | テーブル      | ヴァルチャー   | 64   | イベント関連のテーブル名                     |
| 15  | SQL_テキスト  | ヴァルチャー   | 64KB | マスクされたSQL文                       |
| 16  | 行         | 整数       |      | 影響を受ける行の数（ `0`影響を受ける行がないことを示します） |

TiDB によって設定された EVENT_CLASS フィールドの値に応じて、監査ログ内のデータベース イベント レコードには次の追加フィールドも含まれます。

-   EVENT_CLASS 値が`CONNECTION`場合、データベース イベント レコードには次のフィールドも含まれます。

    | 列番号 | フィールド名         | TiDBデータ型 | 最大長  | 説明                                              |
    | --- | -------------- | -------- | ---- | ----------------------------------------------- |
    | 17  | クライアントポート      | 整数       |      | クライアントポート番号                                     |
    | 18  | 接続ID           | 整数       |      | 接続ID                                            |
    | 19  | 接続タイプ          | ヴァルチャー   | 12   | `socket`または`unix-socket`経由の接続                   |
    | 20  | サーバーID         | 整数       |      | TiDBサーバーID                                      |
    | 21  | サーバーポート        | 整数       |      | TiDBサーバーがMySQLプロトコル経由でクライアント通信をリッスンするために使用するポート |
    | 22  | サーバーOSログインユーザー | ヴァルチャー   | 17   | TiDBプロセス起動システムのユーザー名                            |
    | 23  | OS_バージョン       | ヴァルチャー   | 該当なし | TiDBサーバーが配置されているオペレーティング システムのバージョン             |
    | 24  | SSL_バージョン      | ヴァルチャー   | 6    | TiDBの現在のSSLバージョン                                |
    | 25  | PID            | 整数       |      | TiDBプロセスのPID                                    |

-   EVENT_CLASS 値が`TABLE_ACCESS`または`GENERAL`の場合、データベース イベント レコードには次のフィールドも含まれます。

    | 列番号 | フィールド名      | TiDBデータ型 | 最大長 | 説明                 |
    | --- | ----------- | -------- | --- | ------------------ |
    | 17  | 接続ID        | 整数       |     | 接続ID               |
    | 18  | 指示          | ヴァルチャー   | 14  | MySQLプロトコルのコマンドタイプ |
    | 19  | SQL_ステートメント | ヴァルチャー   | 17  | SQL文の種類            |
    | 20  | PID         | 整数       |     | TiDBプロセスのPID       |
