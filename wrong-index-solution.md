---
title: Wrong Index Solution
summary: 間違ったインデックスの問題を解決する方法を学びます。
---

# インデックス問題の解決方法 {#wrong-index-solution}

一部のクエリの実行速度が期待値に達しない場合は、オプティマイザーがクエリを実行するために間違ったインデックスを選択する可能性があります。

オプティマイザーが予期しないインデックスを選択する理由は複数あります。

-   **古い統計**：オプティマイザーはクエリコストを推定するために統計を使用します。統計が古い場合、オプティマイザーは最適ではない選択を行う可能性があります。
-   **統計の不一致**: 統計が最新であっても、データの分布を正確に反映していない可能性があり、コストの見積もりが不正確になる可能性があります。
-   **コスト計算が正しくありません**: クエリ構造やデータ分散が複雑なため、オプティマイザーがインデックスの使用コストを誤って計算する場合があります。
-   **不適切なエンジンの選択**: 場合によっては、オプティマイザーがクエリに最適ではないstorageエンジンを選択することがあります。
-   **関数のプッシュダウンの制限**: 特定の関数または操作がstorageエンジンにプッシュダウンされない可能性があり、クエリのパフォーマンスに影響する可能性があります。

## 統計の健康 {#statistics-health}

まず統計の[テーブルの健全性状態](/statistics.md#health-state-of-tables)確認し、次にさまざまなヘルス状態に応じてこの問題を解決します。

### 健康状態が低い {#low-health-state}

ヘルス状態が低いということは、TiDBが`ANALYZE`ステートメントを長期間実行していないことを意味します。3 `ANALYZE`コマンドを実行することで統計情報を更新できます。更新後もオプティマイザーが誤ったインデックスを使用している場合は、次のセクションを参照してください。

### ほぼ100%の健康状態 {#near-100-health-state}

ヘルス状態がほぼ100%であることは、 `ANALYZE`ステートメントが完了間近、または少し前に完了したことを示しています。この場合、インデックスの誤りは、TiDBの行数推定ロジックに関連している可能性があります。

同値クエリの場合、原因は[カウントミニマムスケッチ](/statistics.md#count-min-sketch)ある可能性があります。Count-Min Sketchが原因であるかどうかを確認し、適切な解決策を実行できます。

上記の原因が問題に当てはまらない場合は、 `USE_INDEX`または`use index`オプティマイザヒントを使用してインデックスを強制的に選択できます（詳細は[使用インデックス](/optimizer-hints.md#use_indext1_name-idx1_name--idx2_name-)参照）。また、 [SQLプラン管理](/sql-plan-management.md)を使用してクエリの動作を非侵入的に変更することもできます。

### その他の状況 {#other-situations}

上記の状況以外にも、データ更新によってすべてのインデックスが適用できなくなった場合、間違ったインデックスの問題が発生することがあります。このような場合は、状況とデータ分布を分析し、新しいインデックスによってクエリが高速化されるかどうかを確認する必要があります。高速化できる場合は、 [`ADD INDEX`](/sql-statements/sql-statement-add-index.md)コマンドを実行して新しいインデックスを追加できます。

## 統計の不一致 {#statistics-mismatch}

データ分布が大きく偏っている場合、統計情報が実際のデータを正確に反映しない可能性があります。そのような場合は、 [`ANALYZE TABLE`](/sql-statements/sql-statement-analyze-table.md)のステートメントのオプションを設定してみてください。統計情報の精度が向上し、インデックスとの整合性が向上する可能性があります。

例えば、列`customer_id`にインデックスが設定された`orders`テーブルがあり、注文の 50% 以上が同じ`customer_id`を共有しているとします。この場合、統計情報はデータ分布を適切に反映せず、クエリのパフォーマンスに影響を与える可能性があります。

## コスト情報 {#cost-information}

実行コストの詳細情報を表示するには、 [`EXPLAIN`](/sql-statements/sql-statement-explain.md)と[`EXPLAIN ANALYZE`](/sql-statements/sql-statement-explain-analyze.md)ステートメントを`FORMAT=verbose`オプション付きで実行します。この情報から、異なる実行パス間のコストの違いを確認できます。

## エンジンの選択 {#engine-selection}

デフォルトでは、TiDBはコスト見積もりに基づいてテーブルアクセスにTiKVまたはTiFlashを選択します。エンジン分離を適用することで、同じクエリに対して異なるエンジンを試すことができます。

詳細については[エンジン分離](/tiflash/use-tidb-to-read-tiflash.md#engine-isolation)参照してください。

## 関数プッシュダウン {#function-pushdown}

クエリパフォーマンスを向上させるため、TiDB は特定の関数をTiKV またはTiFlashstorageエンジンにプッシュダウンして実行できます。ただし、一部の関数はプッシュダウンをサポートしていないため、利用可能な実行プランが制限され、クエリパフォーマンスに影響を及ぼす可能性があります。

プッシュダウンをサポートする式については、 [TiKVはプッシュダウン計算をサポート](/functions-and-operators/expressions-pushed-down.md)と[TiFlashはプッシュダウン計算をサポート](/tiflash/tiflash-supported-pushdown-calculations.md)参照してください。

特定の式のプッシュダウンを無効にすることもできます。詳細については、 [最適化ルールと式プッシュダウンのブロックリスト](/blocklist-control-plan.md)参照してください。

## 参照 {#see-also}

-   [統計](/statistics.md)
-   [インデックスの選択](/choose-index.md)
-   [オプティマイザーヒント](/optimizer-hints.md)
-   [SQLプラン管理](/sql-plan-management.md)
