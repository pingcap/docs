---
title: LOCK TABLES and UNLOCK TABLES
summary: TiDBを使用すると、クライアントセッションがテーブルにアクセスし、他のセッションと連携したり、他のセッションによるテーブルの変更を防止したりするためにテーブルロックを取得できます。テーブルロックは`LOCK TABLES`で取得し、`UNLOCK TABLES`で解放します。テーブルロックはデフォルトで無効になっており、使用するには設定が必要です。テーブルロックは他のセッションによる読み取りや書き込みから保護し、`WRITE`ロックを保持するセッションは特定の操作を実行できます。テーブルロックは`KILL`を使用して安全に終了できます。
---

# テーブルのロックとテーブルのロック解除 {#lock-tables-and-unlock-tables}

> **警告：**
>
> `LOCK TABLES`と`UNLOCK TABLES`は現在のバージョンの実験的機能です。本番環境での使用はお勧めしません。

TiDB を使用すると、クライアント セッションがテーブルにアクセスするために他のセッションと連携したり、他のセッションによるテーブルの変更を防止したりする目的でテーブル ロックを取得できるようになります。セッションは、それ自体に対してのみロックを取得または解放できます。あるセッションが別のセッションのロックを取得したり、別のセッションが保持しているロックを解放したりすることはできません。

`LOCK TABLES`現在のクライアント セッションのテーブル ロックを取得します。ロックする各オブジェクトに対して`LOCK TABLES`および`SELECT`権限を持っている場合は、共通テーブルのテーブル ロックを取得できます。

`UNLOCK TABLES`現在のセッションが保持しているテーブル ロックを明示的に解放します。 `LOCK TABLES`新しいロックを取得する前に、現在のセッションによって保持されているすべてのテーブル ロックを暗黙的に解放します。

テーブル ロックは、他のセッションによる読み取りまたは書き込みから保護します。 `WRITE`ロックを保持するセッションは、 `DROP TABLE`や`TRUNCATE TABLE`などのテーブルレベルの操作を実行できます。

> **注記：**
>
> テーブル ロック機能はデフォルトでは無効になっています。
>
> -   TiDB セルフホストの場合、テーブル ロック機能を有効にするには、すべての TiDB インスタンスの構成ファイルで[`enable-table-lock`](https://docs.pingcap.com/tidb/stable/tidb-configuration-file#enable-table-lock-new-in-v400) ～ `true`を設定する必要があります。
> -   TiDB Cloudの場合、テーブル ロック機能を有効にするには、 [TiDB Cloudのサポート](https://docs.pingcap.com/tidbcloud/tidb-cloud-support)に連絡して[`enable-table-lock`](https://docs.pingcap.com/tidb/stable/tidb-configuration-file#enable-table-lock-new-in-v400)を`true`に設定する必要があります。

## あらすじ {#synopsis}

```ebnf+diagram
LockTablesDef
         ::= 'LOCK' ( 'TABLES' | 'TABLE' ) TableName LockType ( ',' TableName LockType)*


UnlockTablesDef
         ::= 'UNLOCK' 'TABLES'

LockType
         ::= 'READ' ('LOCAL')?
           | 'WRITE' ('LOCAL')?
```

## テーブルロックの取得 {#acquire-table-locks}

`LOCK TABLES`ステートメントを使用すると、現在のセッション内でテーブル ロックを取得できます。次のロック タイプが使用可能です。

`READ`ロック:

-   このロックを保持しているセッションはテーブルを読み取ることはできますが、書き込むことはできません。
-   複数のセッションが同じテーブルから同時に`READ`ロックを取得できます。
-   他のセッションは、明示的に`READ`ロックを取得しなくてもテーブルを読み取ることができます。

`READ LOCAL`ロックは MySQL との構文互換性のみを目的としており、サポートされていません。

`WRITE`ロック:

-   このロックを保持するセッションは、テーブルの読み取りと書き込みができます。
-   このロックを保持しているセッションのみがテーブルにアクセスできます。ロックが解放されるまで、他のセッションはアクセスできません。

`WRITE LOCAL`ロック:

-   このロックを保持するセッションは、テーブルの読み取りと書き込みができます。
-   このロックを保持しているセッションのみがテーブルにアクセスできます。他のセッションはテーブルを読み取ることはできますが、書き込むことはできません。

`LOCK TABLES`ステートメントに必要なロックが別のセッションによって保持されている場合、 `LOCK TABLES`ステートメントは待機する必要があり、このステートメントの実行時にエラーが返されます。次に例を示します。

```sql
> LOCK TABLES t1 READ;
ERROR 8020 (HY000): Table 't1' was locked in WRITE by server: f4799bcb-cad7-4285-8a6d-23d3555173f1_session: 2199023255959
```

前述のエラー メッセージは、TiDB `f4799bcb-cad7-4285-8a6d-23d3555173f1`の ID `2199023255959`のセッションがテーブル`t1`に対してすでに`WRITE`ロックを保持していることを示しています。したがって、現在のセッションはテーブル`t1`の`READ`ロックを取得できません。

1 つの`LOCK TABLES`ステートメントで同じテーブル ロックを複数回取得することはできません。

```sql
> LOCK TABLES t WRITE, t READ;
ERROR 1066 (42000): Not unique table/alias: 't'
```

## テーブルのロックを解除する {#release-table-locks}

セッションによって保持されているテーブル ロックが解放されると、それらはすべて同時に解放されます。セッションは、明示的または暗黙的にロックを解放できます。

-   セッションは`UNLOCK TABLES`を使用して明示的にロックを解放できます。
-   セッションがすでにロックを保持しているときに`LOCK TABLES`ステートメントを発行してロックを取得すると、新しいロックが取得される前に、既存のロックが暗黙的に解放されます。

クライアント セッションの接続が終了すると、正常か異常かに関係なく、TiDB はセッションによって保持されているすべてのテーブル ロックを暗黙的に解放します。クライアントが再接続すると、ロックは無効になります。このため、クライアントで自動再接続を有効にすることはお勧めできません。自動再接続を有効にすると、再接続が発生したときにクライアントに通知されず、すべてのテーブル ロックまたは現在のトランザクションが失われます。対照的に、自動再接続が無効になっている場合、接続が切断されると、次のステートメントの発行時にエラーが発生します。クライアントはエラーを検出し、ロックの再取得やトランザクションのやり直しなどの適切なアクションを実行できます。

## テーブルロックの制限と条件 {#table-locking-restrictions-and-conditions}

`KILL`を使用すると、テーブル ロックを保持しているセッションを安全に終了できます。

次のデータベースのテーブルではテーブル ロックを取得できません。

-   `INFORMATION_SCHEMA`
-   `PERFORMANCE_SCHEMA`
-   `METRICS_SCHEMA`
-   `mysql`

## MySQLの互換性 {#mysql-compatibility}

### テーブルロックの取得 {#table-lock-acquisition}

-   TiDB では、セッション A がすでにテーブル ロックを保持している場合、セッション B がテーブルに書き込もうとするとエラーが返されます。 MySQL では、セッション B の書き込みリクエストはセッション A がテーブル ロックを解放するまでブロックされ、他のセッションからのテーブル ロックのリクエストは現在のセッションがロック`WRITE`を解放するまでブロックされます。
-   TiDB では、 `LOCK TABLES`ステートメントが必要とするロックが別のセッションによって保持されている場合、 `LOCK TABLES`ステートメントは待機する必要があり、このステートメントの実行時にエラーが返されます。 MySQL では、このステートメントはロックが取得されるまでブロックされます。
-   TiDB では、 `LOCK TABLES`ステートメントはクラスター全体で有効です。 MySQL では、このステートメントは現在の MySQLサーバーでのみ有効であり、NDB クラスターとは互換性がありません。

### テーブルロック解除 {#table-lock-release}

トランザクションが TiDB セッションで明示的に開始された場合 (たとえば、 `BEGIN`ステートメントを使用して)、TiDB はセッションによって保持されているテーブル ロックを暗黙的に解放しません。ただし、MySQL は可能です。
