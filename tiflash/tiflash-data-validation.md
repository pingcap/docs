---
title: TiFlash Data Validation
summary: Learn the data validation mechanism and tools for TiFlash.
---

# TiFlashデータの検証 {#tiflash-data-validation}

このドキュメントでは、TiFlashのデータ検証メカニズムとツールを紹介します。

データの破損は通常、深刻なハードウェア障害によって引き起こされます。このような場合、手動でデータを回復しようとしても、データの信頼性が低下します。

データの整合性を確保するために、デフォルトでは、TiFlashは`City128`アルゴリズムを使用してデータファイルに対して基本的なデータ検証を実行します。データ検証に失敗した場合、TiFlashはすぐにエラーを報告して終了し、一貫性のないデータによって引き起こされる二次的な災害を回避します。このとき、TiFlashノードを復元する前に、手動で介入してデータを再度複製する必要があります。

v5.4.0以降、TiFlashはより高度なデータ検証機能を導入しています。 TiFlashはデフォルトで`XXH3`アルゴリズムを使用し、検証フレームとアルゴリズムをカスタマイズできます。

## 検証メカニズム {#validation-mechanism}

検証メカニズムは、DeltaTreeファイル（DTFile）に基づいて構築されています。 DTFileは、TiFlashデータを保持するストレージファイルです。 DTFileには次の3つの形式があります。

| バージョン | 州                      | 検証メカニズム                                                   | ノート                       |
| :---- | :--------------------- | :-------------------------------------------------------- | :------------------------ |
| V1    | 非推奨                    | ハッシュはデータファイルに埋め込まれています。                                   |                           |
| V2    | バージョン&lt;v6.0.0のデフォルト  | ハッシュはデータファイルに埋め込まれています。                                   | V1と比較して、V2は列データの統計を追加します。 |
| V3    | バージョン&gt;=v6.0.0のデフォルト | V3には、メタデータとトークンデータのチェックサムが含まれており、複数のハッシュアルゴリズムをサポートしています。 | v5.4.0の新機能。               |

DTFileは、データファイルディレクトリの`stable`フォルダに保存されます。現在有効になっているすべての形式はフォルダ形式です。つまり、データは`dmf_<file id>`のような名前のフォルダの下にある複数のファイルに保存されます。

### データ検証を使用する {#use-data-validation}

TiFlashは、自動データ検証と手動データ検証の両方をサポートしています。

-   自動データ検証：
    -   v6.0.0以降のバージョンでは、デフォルトでV3検証メカニズムが使用されます。
    -   v6.0.0より前のバージョンでは、デフォルトでV2検証メカニズムが使用されます。
    -   検証メカニズムを手動で切り替えるには、 [TiFlash構成ファイル](/tiflash/tiflash-configuration.md#configure-the-tiflashtoml-file)を参照してください。ただし、デフォルトの構成はテストによって検証されているため、推奨されます。
-   手動データ検証。 [`DTTool inspect`](/tiflash/tiflash-command-line-flags.md#dttool-inspect)を参照してください。

> **警告：**
>
> V3検証メカニズムを有効にすると、新しく生成されたDTFileをv5.4.0より前のTiFlashで直接読み取ることはできません。 v5.4.0以降、TiFlashはV2とV3の両方をサポートし、バージョンを積極的にアップグレードまたはダウングレードしません。既存のファイルのバージョンをアップグレードまたはダウングレードする必要がある場合は、手動で[バージョンの切り替え](/tiflash/tiflash-command-line-flags.md#dttool-migrate)を実行する必要があります。

### 検証ツール {#validation-tool}

TiFlashがデータを読み取るときに実行される自動データ検証に加えて、データの整合性を手動でチェックするためのツールがv5.4.0で導入されています。詳しくは[DTTool](/tiflash/tiflash-command-line-flags.md#dttool-inspect)をご覧ください。
