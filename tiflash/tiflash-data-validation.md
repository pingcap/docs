---
title: TiFlash Data Validation
summary: TiFlashのデータ検証メカニズムとツールについて学習します。
---

# TiFlashデータ検証 {#tiflash-data-validation}

このドキュメントでは、 TiFlashのデータ検証メカニズムとツールについて説明します。

データ破損は通常、深刻なハードウェア障害によって引き起こされます。このような場合、手動でデータを復旧しようとしても、データの信頼性は低下します。

データの整合性を確保するため、 TiFlash はデフォルトでデータファイルに対して`City128`アルゴリズムを用いた基本的なデータ検証を実行します。データ検証に失敗した場合、 TiFlash は直ちにエラーを報告して終了し、データの不整合による二次災害を回避します。この場合、 TiFlashノードを復元する前に、手動で介入してデータを再度複製する必要があります。

バージョン5.4.0以降、 TiFlashはより高度なデータ検証機能を導入しました。TiFlashはデフォルトで`XXH3`アルゴリズムを使用し、検証フレームとアルゴリズムをカスタマイズできます。

## 検証メカニズム {#validation-mechanism}

検証メカニズムはDeltaTreeファイル（DTFile）を基盤としています。DTFileはTiFlashデータを保存するstorageファイルです。DTFileには以下の3つの形式があります。

| バージョン | 州                         | 検証メカニズム                                                   | 注記                            |
| :---- | :------------------------ | :-------------------------------------------------------- | :---------------------------- |
| V1    | 非推奨                       | ハッシュはデータ ファイルに埋め込まれます。                                    |                               |
| V2    | バージョン6.0.0未満のデフォルト        | ハッシュはデータ ファイルに埋め込まれます。                                    | V1 と比較して、V2 では列データの統計が追加されます。 |
| V3    | バージョン &gt;= v6.0.0 のデフォルト | V3 にはメタデータとトークン データのチェックサムが含まれており、複数のハッシュ アルゴリズムをサポートします。 | v5.4.0 の新機能。                  |

DTFileはデータファイルディレクトリの`stable`フォルダに保存されます。現在有効な形式はすべてフォルダ形式です。つまり、データは`dmf_<file id>`ような名前のフォルダの下に複数のファイルとして保存されます。

### データ検証を使用する {#use-data-validation}

TiFlash は自動と手動の両方のデータ検証をサポートしています。

-   自動データ検証:
    -   v6.0.0 以降のバージョンでは、デフォルトで V3 検証メカニズムが使用されます。
    -   v6.0.0 より前のバージョンでは、デフォルトで V2 検証メカニズムが使用されます。
    -   検証メカニズムを手動で切り替えるには、 [TiFlash設定ファイル](/tiflash/tiflash-configuration.md#configure-the-tiflashtoml-file)を参照してください。ただし、デフォルト設定はテストによって検証されているため、推奨されます。
-   手動データ検証[`DTTool inspect`](/tiflash/tiflash-command-line-flags.md#dttool-inspect)を参照してください。

> **警告：**
>
> V3検証メカニズムを有効にすると、新しく生成されたDTFileはv5.4.0より前のTiFlashでは直接読み取ることができません。v5.4.0以降、 TiFlashはV2とV3の両方をサポートしており、積極的にバージョンのアップグレードやダウングレードを行うことはありません。既存のファイルのバージョンをアップグレードまたはダウングレードする必要がある場合は、手動で[スイッチバージョン](/tiflash/tiflash-command-line-flags.md#dttool-migrate)実行する必要があります。

### 検証ツール {#validation-tool}

TiFlashがデータを読み取る際に実行される自動データ検証に加えて、v5.4.0ではデータの整合性を手動でチェックするためのツールが導入されました。詳細は[DTツール](/tiflash/tiflash-command-line-flags.md#dttool-inspect)を参照してください。
