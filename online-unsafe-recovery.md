---
title: Online Unsafe Recovery
summary: Learn how to use Online Unsafe Recovery.
---

# オンラインの安全でない回復 {#online-unsafe-recovery}

> **警告：**
>
> -   オンラインの安全でないリカバリは、損失のあるリカバリの一種です。この機能を使用する場合、データとデータインデックスの整合性は保証されません。
> -   Online Unsafe Recoveryは実験的機能であり、実稼働環境で使用することはお勧めし**ません**。この機能のインターフェース、戦略、および内部実装は、一般提供（GA）になると変更される可能性があります。この機能はいくつかのシナリオでテストされていますが、完全には検証されておらず、システムが使用できなくなる可能性があります。
> -   TiDBチームのサポートを受けて、機能関連の操作を実行することをお勧めします。誤操作が発生した場合、クラスタの復旧が困難になる場合があります。

恒久的に損傷したレプリカが原因でTiKV上のデータの一部が読み取りおよび書き込み不能になった場合、オンラインの安全でない回復機能を使用して、不可逆回復操作を実行できます。

## 機能の説明 {#feature-description}

TiDBでは、ユーザーが定義したレプリカルールに従って、同じデータが同時に複数のストアに保存される場合があります。これにより、1つまたはいくつかのストアが一時的にオフラインになったり破損したりした場合でも、データの読み取りと書き込みが可能になります。ただし、リージョンのほとんどまたはすべてのレプリカが短期間にオフラインになると、データの整合性を確保するために、設計上、リージョンは一時的に使用できなくなります。

データ範囲の複数のレプリカで永続的な損傷（ディスクの損傷など）などの問題が発生し、これらの問題によってストアがオフラインのままになるとします。この場合、このデータ範囲は一時的に利用できません。クラスタを再び使用し、データの巻き戻しまたはデータの損失も受け入れる場合は、理論的には、障害が発生したレプリカをグループから手動で削除することで、レプリカの大部分を再形成できます。これにより、アプリケーション層サービスは、このデータ範囲（古くなっているか空である可能性があります）を再度読み書きできます。

この場合、損失耐性のあるデータを持つ一部のストアが恒久的に損傷している場合は、OnlineUnsafeRecoveryを使用して損失のある回復操作を実行できます。この機能を使用して、PDは、グローバルな視点で、すべてのストアからデータシャードのメタデータを収集し、リアルタイムで完全なリカバリプランを生成します。次に、PDは、存続しているすべてのストアに計画を配布して、データ回復タスクを実行させます。さらに、データ回復計画が配布されると、PDは定期的に回復の進行状況を監視し、必要に応じて計画を再送信します。

## ユーザーシナリオ {#user-scenarios}

オンラインの安全でないリカバリ機能は、次のシナリオに適しています。

-   永続的に破損したストアが原因でストアの再起動に失敗するため、アプリケーションサービスのデータは読み取りおよび書き込みできません。
-   データの損失を受け入れ、影響を受けるデータを読み取りおよび書き込み可能にすることができます。
-   ワンストップのオンラインデータ回復操作を実行したい。

## 使用法 {#usage}

### 前提条件 {#prerequisites}

Online Unsafe Recoveryを使用する前に、次の要件が満たされていることを確認してください。

-   オフラインストアでは、実際に一部のデータが使用できなくなります。
-   オフラインストアを自動的に回復または再開することはできません。

### 手順1.すべてのタイプのスケジューリングを無効にする {#step-1-disable-all-types-of-scheduling}

負荷分散など、すべてのタイプの内部スケジューリングを一時的に無効にする必要があります。それらを無効にした後、トリガーされたスケジューリングがスケジュールされたタスクを完了するのに十分な時間を確保できるように、約10分間待つことをお勧めします。

> **ノート：**
>
> スケジューリングを無効にすると、システムはデータホットスポットの問題を解決できなくなります。したがって、リカバリが完了した後、できるだけ早くスケジューリングを有効にする必要があります。

1.  PD制御を使用して、 [`config show`](/pd-control.md#config-show--set-option-value--placement-rules)コマンドを実行して現在の構成を取得します。
2.  PD制御を使用して、すべてのタイプのスケジューリングを無効にします。例えば：

    -   [`config set region-schedule-limit 0`](/pd-control.md#config-show--set-option-value--placement-rules)
    -   [`config set replica-schedule-limit 0`](/pd-control.md#config-show--set-option-value--placement-rules)
    -   [`config set merge-schedule-limit 0`](/pd-control.md#config-show--set-option-value--placement-rules)

### 手順2.自動的に復元できないストアを削除する {#step-2-remove-the-stores-that-cannot-be-automatically-recovered}

PD制御を使用して、 [`unsafe remove-failed-stores &#x3C;store_id>[,&#x3C;store_id>,...]`](/pd-control.md#unsafe-remove-failed-stores-store-ids--show--history)コマンドを実行しても自動的に回復できないストアを削除します。

> **ノート：**
>
> このコマンドの返される結果は、要求が受け入れられたことを示すだけであり、リカバリーが正常に完了したことを示すものではありません。店舗は実際にバックグラウンドで復元されます。

### ステップ3.進捗状況を確認します {#step-3-check-the-progress}

上記のストア削除コマンドが正常に実行されたら、PD Controlを使用して、 [`unsafe remove-failed-stores show`](/pd-control.md#config-show--set-option-value--placement-rules)コマンドを実行することで削除の進行状況を確認できます。コマンドの結果に「最後のリカバリが終了しました」と表示されたら、システムのリカバリは完了です。

### ステップ4.読み取りおよび書き込みタスクをテストする {#step-4-test-read-and-write-tasks}

progressコマンドで回復タスクが完了したことが示された後、次の例のようないくつかの単純なSQLクエリを実行するか、書き込みタスクを実行して、データの読み取りと書き込みが可能であることを確認できます。

```sql
select count(*) from table_that_suffered_from_group_majority_failure;
```

> **ノート：**
>
> データの読み取りと書き込みが可能な状況は、データの損失がないことを示すものではありません。

### ステップ5.スケジューリングを再開します {#step-5-restart-the-scheduling}

スケジューリングを再開するには、ステップ`config set merge-schedule-limit 0`で変更した`config set region-schedule-limit 0` 、および`config set replica-schedule-limit 0`の`0`の値を初期値に調整する必要があります。

その後、プロセス全体が終了します。
