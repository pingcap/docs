---
title: TiCDC Open Protocol
summary: TiCDC オープン プロトコルの概念とその使用方法を学びます。
---

# TiCDC オープンプロトコル {#ticdc-open-protocol}

TiCDC オープン プロトコルは、行レベルのデータ変更通知プロトコルであり、監視、キャッシュ、フルテキスト インデックス、分析エンジン、および異なるデータベース間のプライマリ - セカンダリ レプリケーション用のデータ ソースを提供します。TiCDC は TiCDC オープン プロトコルに準拠しており、TiDB のデータ変更を MQ (メッセージ キュー) などのサードパーティ データ メディアに複製します。

TiCDC オープン プロトコルは、データ変更イベントをダウンストリームに複製するための基本単位としてイベントを使用します。イベントは次の 3 つのカテゴリに分けられます。

-   行変更イベント: 行のデータの変更を表します。行が変更されると、このイベントが送信され、変更された行に関する情報が含まれます。
-   DDL イベント: DDL の変更を表します。このイベントは、アップストリームで DDL ステートメントが正常に実行された後に送信されます。DDL イベントは、すべての MQ パーティションにブロードキャストされます。
-   解決されたイベント: 受信したイベントが完了する特別な時点を表します。

## 制限 {#restrictions}

-   ほとんどの場合、バージョンの行変更イベントは 1 回だけ送信されますが、ノード障害やネットワーク パーティションなどの特殊な状況では、同じバージョンの行変更イベントが複数回送信されることがあります。
-   同じテーブルで、最初に送信される各バージョンの行変更イベントは、イベント ストリーム内のタイムスタンプ (TS) の順に増加されます。
-   解決されたイベントは、各 MQ パーティションに定期的にブロードキャストされます。解決されたイベントとは、解決されたイベント TS より前の TS を持つすべてのイベントがダウンストリームに送信されたことを意味します。
-   DDL イベントは各 MQ パーティションにブロードキャストされます。
-   行の複数の行変更イベントが同じ MQ パーティションに送信されます。

## メッセージ形式 {#message-format}

メッセージには、次の形式で配置された 1 つ以上のイベントが含まれます。

鍵：

| オフセット(バイト) | 0〜7        | 8〜15 | 16~(15+長さ1) | ... | ...     |
| :--------- | :--------- | :--- | :---------- | :-- | :------ |
| パラメータ      | プロトコルバージョン | 長さ1  | イベントキー1     | 長さN | イベントキーN |

価値：

| オフセット(バイト) | 0〜7 | 8~(7+長さ1) | ... | ...    |
| :--------- | :-- | :-------- | :-- | :----- |
| パラメータ      | 長さ1 | イベント値1    | 長さN | イベント値N |

-   `LengthN` `N`番目のキー/値の長さを表します。
-   長さとプロトコルバージョンはビッグエンディアン`int64`型です。
-   現在のプロトコルのバージョンは`1`です。

## イベント形式 {#event-format}

このセクションでは、行変更イベント、DDL イベント、解決イベントの形式について説明します。

### 行変更イベント {#row-changed-event}

-   **鍵：**

    ```json
    {
        "ts":<TS>,
        "scm":<Schema Name>,
        "tbl":<Table Name>,
        "t":1
    }
    ```

    | パラメータ | タイプ | 説明                           |
    | :---- | :-- | :--------------------------- |
    | TS    | 番号  | 行の変更の原因となったトランザクションのタイムスタンプ。 |
    | スキーマ名 | 弦   | 行が含まれるスキーマの名前。               |
    | テーブル名 | 弦   | 行が含まれているテーブルの名前。             |

-   **価値：**

    `Insert`イベント。新しく追加された行データが出力されます。

    ```json
    {
        "u":{
            <Column Name>:{
                "t":<Column Type>,
                "h":<Where Handle>,
                "f":<Flag>,
                "v":<Column Value>
            },
            <Column Name>:{
                "t":<Column Type>,
                "h":<Where Handle>,
                "f":<Flag>,
                "v":<Column Value>
            }
        }
    }
    ```

    `Update`イベント。新しく追加された行データ（「u」）と更新前の行データ（「p」）が出力されます。

    ```json
    {
        "u":{
            <Column Name>:{
                "t":<Column Type>,
                "h":<Where Handle>,
                "f":<Flag>,
                "v":<Column Value>
            },
            <Column Name>:{
                "t":<Column Type>,
                "h":<Where Handle>,
                "f":<Flag>,
                "v":<Column Value>
            }
        },
        "p":{
            <Column Name>:{
                "t":<Column Type>,
                "h":<Where Handle>,
                "f":<Flag>,
                "v":<Column Value>
            },
            <Column Name>:{
                "t":<Column Type>,
                "h":<Where Handle>,
                "f":<Flag>,
                "v":<Column Value>
            }
        }
    }
    ```

    `Delete`イベント。削除された行データが出力されます。

    ```json
    {
        "d":{
            <Column Name>:{
                "t":<Column Type>,
                "h":<Where Handle>,
                "f":<Flag>,
                "v":<Column Value>
            },
            <Column Name>:{
                "t":<Column Type>,
                "h":<Where Handle>,
                "f":<Flag>,
                "v":<Column Value>
            }
        }
    }
    ```

    | パラメータ   | タイプ  | 説明                                                                               |
    | :------ | :--- | :------------------------------------------------------------------------------- |
    | カラム名    | 弦    | 列名。                                                                              |
    | カラムタイプ  | 番号   | 列の種類。詳細については[カラムタイプコード](#column-type-code)参照してください。                              |
    | ハンドルの場所 | ブール  | この列が`Where`句のフィルター条件になるかどうかを決定します。この列がテーブル上で一意である場合、 `Where Handle` `true`になります。 |
    | フラグ     | 番号   | 列のビットフラグ。詳細は[列のビットフラグ](#bit-flags-of-columns)参照。                                 |
    | カラムの値   | どれでも | カラムの値。                                                                           |

### DDLイベント {#ddl-event}

-   **鍵：**

    ```json
    {
        "ts":<TS>,
        "scm":<Schema Name>,
        "tbl":<Table Name>,
        "t":2
    }
    ```

    | パラメータ | タイプ | 説明                            |
    | :---- | :-- | :---------------------------- |
    | TS    | 番号  | DDL 変更を実行するトランザクションのタイムスタンプ。  |
    | スキーマ名 | 弦   | DDL 変更のスキーマ名。空の文字列になる場合があります。 |
    | テーブル名 | 弦   | DDL 変更のテーブル名。空の文字列になる場合があります。 |

-   **価値：**

    ```json
    {
        "q":<DDL Query>,
        "t":<DDL Type>
    }
    ```

    | パラメータ  | タイプ | 説明                                              |
    | :----- | :-- | :---------------------------------------------- |
    | DDLクエリ | 弦   | DDLクエリSQL                                       |
    | DDLタイプ | 弦   | DDLタイプ。詳細は[DDL タイプコード](#ddl-type-code)参照してください。 |

### 解決されたイベント {#resolved-event}

-   **鍵：**

    ```json
    {
        "ts":<TS>,
        "t":3
    }
    ```

    | パラメータ | タイプ | 説明                                    |
    | :---- | :-- | :------------------------------------ |
    | TS    | 番号  | 解決されたタイムスタンプ。このイベントより前の TS は送信されています。 |

-   **値:**なし

## イベントストリーム出力の例 {#examples-of-the-event-stream-output}

このセクションでは、イベント ストリームの出力ログを表示します。

アップストリームで次の SQL ステートメントを実行し、MQ パーティション番号が 2 であるとします。

```sql
CREATE TABLE test.t1(id int primary key, val varchar(16));
```

次のログ 1 とログ 3 から、DDL イベントがすべての MQ パーティションにブロードキャストされ、解決されたイベントが各 MQ パーティションに定期的にブロードキャストされていることがわかります。

    1. [partition=0] [key="{\"ts\":415508856908021766,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":2}"] [value="{\"q\":\"CREATE TABLE test.t1(id int primary key, val varchar(16))\",\"t\":3}"]
    2. [partition=0] [key="{\"ts\":415508856908021766,\"t\":3}"] [value=]
    3. [partition=1] [key="{\"ts\":415508856908021766,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":2}"] [value="{\"q\":\"CREATE TABLE test.t1(id int primary key, val varchar(16))\",\"t\":3}"]
    4. [partition=1] [key="{\"ts\":415508856908021766,\"t\":3}"] [value=]

アップストリームで次の SQL ステートメントを実行します。

```sql
BEGIN;
INSERT INTO test.t1(id, val) VALUES (1, 'aa');
INSERT INTO test.t1(id, val) VALUES (2, 'aa');
UPDATE test.t1 SET val = 'bb' WHERE id = 2;
INSERT INTO test.t1(id, val) VALUES (3, 'cc');
COMMIT;
```

-   次のログ 5 とログ 6 から、同じテーブル上の行変更イベントは主キーに基づいて異なるパーティションに送信される可能性がありますが、同じ行への変更は同じパーティションに送信されるため、ダウンストリームでイベントを同時に簡単に処理できることがわかります。
-   ログ 6 から、トランザクション内の同じ行に対する複数の変更は、1 つの行変更イベントでのみ送信されます。
-   ログ 8 は、ログ 7 の繰り返しイベントです。行変更イベントは繰り返される可能性がありますが、各バージョンの最初のイベントは順番に送信されます。

<!---->

    5. [partition=0] [key="{\"ts\":415508878783938562,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":1},\"val\":{\"t\":15,\"v\":\"aa\"}}}"]
    6. [partition=1] [key="{\"ts\":415508878783938562,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":2},\"val\":{\"t\":15,\"v\":\"bb\"}}}"]
    7. [partition=0] [key="{\"ts\":415508878783938562,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":3},\"val\":{\"t\":15,\"v\":\"cc\"}}}"]
    8. [partition=0] [key="{\"ts\":415508878783938562,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":3},\"val\":{\"t\":15,\"v\":\"cc\"}}}"]

アップストリームで次の SQL ステートメントを実行します。

```sql
BEGIN;
DELETE FROM test.t1 WHERE id = 1;
UPDATE test.t1 SET val = 'dd' WHERE id = 3;
UPDATE test.t1 SET id = 4, val = 'ee' WHERE id = 2;
COMMIT;
```

-   ログ 9 は、 `Delete`タイプの行変更イベントです。このタイプのイベントには、主キー列または一意のインデックス列のみが含まれます。
-   ログ 13 とログ 14 は解決されたイベントです。解決されたイベントとは、このパーティションで、解決された TS よりも小さいイベント (行変更イベントや DDL イベントを含む) が送信されたことを意味します。

<!---->

    9. [partition=0] [key="{\"ts\":415508881418485761,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"d\":{\"id\":{\"t\":3,\"h\":true,\"v\":1}}}"]
    10. [partition=1] [key="{\"ts\":415508881418485761,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"d\":{\"id\":{\"t\":3,\"h\":true,\"v\":2}}}"]
    11. [partition=0] [key="{\"ts\":415508881418485761,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":3},\"val\":{\"t\":15,\"v\":\"ZGQ=\"}}}"]
    12. [partition=0] [key="{\"ts\":415508881418485761,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":4},\"val\":{\"t\":15,\"v\":\"ZWU=\"}}}"]
    13. [partition=0] [key="{\"ts\":415508881038376963,\"t\":3}"] [value=]
    14. [partition=1] [key="{\"ts\":415508881038376963,\"t\":3}"] [value=]

## 消費者向けプロトコル解析 {#protocol-parsing-for-consumers}

現在、TiCDC は TiCDC Open Protocol の標準解析ライブラリを提供していませんが、 GolangバージョンとJavaバージョンの解析例が提供されています。このドキュメントで提供されているデータ形式と次の例を参照して、コンシューマー向けのプロトコル解析を実装できます。

-   [Golangの例](https://github.com/pingcap/tiflow/tree/release-8.5/cmd/kafka-consumer)
-   [Javaの例](https://github.com/pingcap/tiflow/tree/release-8.5/examples/java)

## カラムタイプコード {#column-type-code}

`Column Type Code`変更イベントの列データ型を表します。

| タイプ                  | コード    | 出力例                                                                                                                      | 説明                                                                |
| :------------------- | :----- | :----------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------- |
| TINYINT/ブール          | 1      | {&quot;t&quot;:1,&quot;v&quot;:1}                                                                                        |                                                                   |
| スモールイント              | 2      | {&quot;t&quot;:2,&quot;v&quot;:1}                                                                                        |                                                                   |
| 内部                   | 3      | {&quot;t&quot;:3,&quot;v&quot;:123}                                                                                      |                                                                   |
| フロート                 | 4      | {&quot;t&quot;:4,&quot;v&quot;:153.123}                                                                                  |                                                                   |
| ダブル                  | 5      | {&quot;t&quot;:5,&quot;v&quot;:153.123}                                                                                  |                                                                   |
| NULL                 | 6      | {&quot;t&quot;:6,&quot;v&quot;:null}                                                                                     |                                                                   |
| タイムスタンプ              | 7      | {&quot;t&quot;:7,&quot;v&quot;:&quot;1973-12-30 15:30:00&quot;}                                                          |                                                                   |
| ビッグイント               | 8      | {&quot;t&quot;:8,&quot;v&quot;:123}                                                                                      |                                                                   |
| ミディアムミント             | 9      | {&quot;t&quot;:9,&quot;v&quot;:123}                                                                                      |                                                                   |
| 日付                   | 10/14  | {&quot;t&quot;:10,&quot;v&quot;:&quot;2000-01-01&quot;}                                                                  |                                                                   |
| 時間                   | 11     | {&quot;t&quot;:11,&quot;v&quot;:&quot;23:59:59&quot;}                                                                    |                                                                   |
| 日時                   | 12     | {&quot;t&quot;:12,&quot;v&quot;:&quot;2015-12-20 23:58:58&quot;}                                                         |                                                                   |
| 年                    | 13     | {&quot;t&quot;:13,&quot;v&quot;:1970}                                                                                    |                                                                   |
| VARCHAR/VARBINARY    | 15/253 | {&quot;t&quot;:15,&quot;v&quot;:&quot;テスト&quot;} / {&quot;t&quot;:15,&quot;v&quot;:&quot;\\x89PNG\\r\\n\\x1a\\n&quot;}   | 値は UTF-8 でエンコードされます。アップストリーム タイプが VARBINARY の場合、非表示の文字はエスケープされます。 |
| 少し                   | 16     | {&quot;t&quot;:16,&quot;v&quot;:81}                                                                                      |                                                                   |
| 翻訳                   | 245    | {&quot;t&quot;:245,&quot;v&quot;:&quot;{\&quot;キー1\&quot;: \&quot;値1\&quot;}&quot;}                                      |                                                                   |
| 小数点                  | 246    | {&quot;t&quot;:246,&quot;v&quot;:&quot;129012.1230000&quot;}                                                             |                                                                   |
| 列挙                   | 247    | {&quot;t&quot;:247,&quot;v&quot;:1}                                                                                      |                                                                   |
| セット                  | 248    | {&quot;t&quot;:248,&quot;v&quot;:3}                                                                                      |                                                                   |
| TINYテキスト/TINYブロブ     | 249    | {&quot;t&quot;:249,&quot;v&quot;:&quot;5rWL6K+VdGV4dA==&quot;}                                                           | 値は Base64 でエンコードされます。                                             |
| MEDIUMテキスト/MEDIUMブロブ | 250    | {&quot;t&quot;:250,&quot;v&quot;:&quot;5rWL6K+VdGV4dA==&quot;}                                                           | 値は Base64 でエンコードされます。                                             |
| LONGTEXT/LONGBLOB    | 251    | {&quot;t&quot;:251,&quot;v&quot;:&quot;5rWL6K+VdGV4dA==&quot;}                                                           | 値は Base64 でエンコードされます。                                             |
| TEXT/BLOB            | 252    | {&quot;t&quot;:252,&quot;v&quot;:&quot;5rWL6K+VdGV4dA==&quot;}                                                           | 値は Base64 でエンコードされます。                                             |
| 文字/バイナリ              | 254    | {&quot;t&quot;:254,&quot;v&quot;:&quot;テスト&quot;} / {&quot;t&quot;:254,&quot;v&quot;:&quot;\\x89PNG\\r\\n\\x1a\\n&quot;} | 値は UTF-8 でエンコードされます。アップストリーム タイプが BINARY の場合、非表示の文字はエスケープされます。    |
| 幾何学                  | 255    |                                                                                                                          | サポートされていません                                                       |

## DDL タイプコード {#ddl-type-code}

`DDL Type Code` DDL イベントの DDL ステートメント タイプを表します。

| タイプ                  | コード |
| :------------------- | :-- |
| スキーマの作成              | 1   |
| スキーマの削除              | 2   |
| テーブルを作成              | 3   |
| ドロップテーブル             | 4   |
| カラムを追加               | 5   |
| カラムの削除               | 6   |
| インデックスを追加            | 7   |
| ドロップインデックス           | 8   |
| 外部キーの追加              | 9   |
| 外部キーの削除              | 10  |
| テーブルを切り捨てる           | 11  |
| カラムの変更               | 12  |
| 自動IDのリベース            | 13  |
| テーブル名の変更             | 14  |
| デフォルト値を設定する          | 15  |
| シャード行ID              | 16  |
| テーブルコメントの変更          | 17  |
| インデックス名の変更           | 18  |
| テーブルパーティションの追加       | 19  |
| テーブルパーティションの削除       | 20  |
| ビューの作成               | 21  |
| 表の文字セットと照合を変更する      | 22  |
| テーブルパーティションの切り捨て     | 23  |
| ドロップビュー              | 24  |
| テーブルの回復              | 25  |
| スキーマ文字セットと照合を変更する    | 26  |
| ロックテーブル              | 27  |
| テーブルのロックを解除          | 28  |
| 修理表                  | 29  |
| TiFlashレプリカを設定する     | 30  |
| TiFlashレプリカのステータスを更新 | 31  |
| 主キーの追加               | 32  |
| 主キーを削除               | 33  |
| シーケンスを作成             | 34  |
| シーケンスの変更             | 35  |
| ドロップシーケンス            | 36  |

## 列のビットフラグ {#bit-flags-of-columns}

ビット フラグは列の特定の属性を表します。

| 少し | 価値   | 名前          | 説明                      |
| :- | :--- | :---------- | :---------------------- |
| 1  | 0x01 | バイナリフラグ     | 列がバイナリエンコードされた列であるかどうか。 |
| 2  | 0x02 | ハンドルキーフラグ   | 列がハンドル インデックス列であるかどうか。  |
| 3  | 0x04 | 生成された列フラグ   | 列が生成された列であるかどうか。        |
| 4  | 0x08 | プライマリキーフラグ  | 列が主キー列であるかどうか。          |
| 5  | 0x10 | ユニークキーフラグ   | 列が一意のインデックス列であるかどうか。    |
| 6  | 0x20 | 複数キーフラグ     | 列が複合インデックス列であるかどうか。     |
| 7  | 0x40 | Nullableフラグ | 列が NULL 可能列であるかどうか。     |
| 8  | 0x80 | 未署名フラグ      | 列が符号なし列であるかどうか。         |

例：

列フラグの値が`85`の場合、その列は NULL 可能列、一意のインデックス列、生成された列、およびバイナリ エンコードされた列です。

    85 == 0b_101_0101
       == NullableFlag | UniqueKeyFlag | GeneratedColumnFlag | BinaryFlag

列の値が`46`の場合、その列は複合インデックス列、主キー列、生成列、およびハンドル キー列です。

    46 == 0b_010_1110
       == MultipleKeyFlag | PrimaryKeyFlag | GeneratedColumnFlag | HandleKeyFlag

> **注記：**
>
> -   `BinaryFlag` 、列タイプが BLOB/ TEXT (TINYBLOB/TINYTEXT および BINARY/CHAR を含む) の場合にのみ意味を持ちます。上流列が BLOB タイプの場合、 `BinaryFlag`値は`1`に設定されます。上流列がTEXTタイプの場合、 `BinaryFlag`値は`0`に設定されます。
> -   アップストリームからテーブルを複製するために、TiCDC はハンドル インデックスとして[有効なインデックス](/ticdc/ticdc-overview.md#best-practices)選択します。ハンドル インデックス列の`HandleKeyFlag`値は`1`に設定されます。
