---
title: Bidirectional Replication
summary: Learn how to use bidirectional replication of TiCDC.
---

# 双方向レプリケーション {#bidirectional-replication}

v6.5.0 以降、TiCDC は 2 つの TiDB クラスター間の双方向レプリケーションをサポートします。この機能に基づいて、TiCDC を使用してマルチアクティブ TiDB ソリューションを作成できます。

このセクションでは、2 つの TiDB クラスターを例として、双方向レプリケーションの使用方法について説明します。

## 双方向レプリケーションをデプロイ {#deploy-bi-directional-replication}

TiCDC は、指定されたタイムスタンプの後に発生する増分データ変更のみをダウンストリーム クラスターにレプリケートします。双方向レプリケーションを開始する前に、次の手順を実行する必要があります。

1.  (オプション) 必要に応じて、データ エクスポート ツール[<a href="/dumpling-overview.md">Dumpling</a>](/dumpling-overview.md)とデータ インポート ツール[<a href="/tidb-lightning/tidb-lightning-overview.md">TiDB Lightning</a>](/tidb-lightning/tidb-lightning-overview.md)を使用して、2 つの TiDB クラスターのデータを相互にインポートします。

2.  2 つの TiDB クラスターの間に 2 つの TiCDC クラスターをデプロイ。クラスタのトポロジは以下のとおりです。図中の矢印はデータの流れの方向を示しています。

    ![TiCDC bidirectional replication](/media/ticdc/ticdc-bidirectional-replication.png)

3.  上流クラスターと下流クラスターのデータ複製の開始時点を指定します。

    1.  上流クラスターと下流クラスターの時点を確認します。 2 つの TiDB クラスターの場合は、2 つのクラスター内のデータが特定の時点で一貫していることを確認してください。たとえば、 `ts=1`の TiDB A のデータと`ts=2`の TiDB B のデータは一致します。

    2.  変更フィードを作成するときは、上流クラスターの変更フィードの`--start-ts` 、対応する`tso`に設定します。つまり、上流クラスターが TiDB A の場合は`--start-ts=1`を設定します。上流クラスターが TiDB B の場合は、 `--start-ts=2`を設定します。

4.  `--config`パラメータで指定された構成ファイルに、次の構成を追加します。

    ```toml
    # Whether to enable the bi-directional replication mode
    bdr-mode = true
    ```

5.  (オプション) データ ソースを追跡する必要がある場合は、 [<a href="/system-variables.md#tidb_source_id-new-in-v650">`tidb_source_id`</a>](/system-variables.md#tidb_source_id-new-in-v650)システム変数を使用して各クラスターに一意のデータ ソース ID を設定します。

構成が有効になると、クラスターは双方向レプリケーションを実行できるようになります。

## DDLの実行 {#execute-ddl}

双方向レプリケーションでは、DDL ステートメントのレプリケーションはサポートされていません。

DDL ステートメントを実行する必要がある場合は、次の手順を実行します。

1.  すべてのクラスターで DDL を実行する必要があるテーブルの書き込み操作を一時停止します。 DDL ステートメントが一意でないインデックスを追加している場合は、この手順をスキップしてください。
2.  すべてのクラスター内の対応するテーブルの書き込み操作が他のクラスターにレプリケートされた後、各 TiDB クラスター内のすべての DDL ステートメントを手動で実行します。
3.  DDL ステートメントが実行された後、書き込み操作を再開します。

一意でないインデックスを追加する DDL ステートメントは双方向レプリケーションを中断しないため、対応するテーブルでの書き込み操作を一時停止する必要がないことに注意してください。

## 双方向レプリケーションを停止する {#stop-bi-directional-replication}

アプリケーションがデータの書き込みを停止した後、各クラスターに特別なレコードを挿入できます。 2 つの特別なレコードをチェックすることで、2 つのクラスター内のデータが一貫していることを確認できます。

チェックが完了したら、変更フィードを停止して双方向レプリケーションを停止できます。

## 制限事項 {#limitations}

-   DDL の制限については、 [<a href="#execute-ddl">DDLの実行</a>](#execute-ddl)を参照してください。

-   双方向レプリケーション クラスターは書き込み競合を検出できず、未定義の動作が発生する可能性があります。したがって、アプリケーション側から書き込み競合がないことを確認する必要があります。

-   双方向レプリケーションは 3 つ以上のクラスターをサポートしますが、カスケード モードでの複数のクラスター、つまり、TiDB A -&gt; TiDB B -&gt; TiDB C -&gt; TiDB A のような循環レプリケーションはサポートしません。このようなトポロジでは、1 つのクラスターが失敗すると、データ レプリケーション全体が影響を受けます。したがって、複数のクラスター間で双方向レプリケーションを有効にするには、各クラスターを他のすべてのクラスター (たとえば、 `TiDB A <-> TiDB B` 、 `TiDB B <-> TiDB C` 、 `TiDB C <-> TiDB A`に接続する必要があります。
