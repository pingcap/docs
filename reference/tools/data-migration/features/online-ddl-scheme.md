---
title: DM online-ddl-scheme
summary: This document introduces the online-ddl-scheme feature of DM.
category: reference
---

# DM online-ddl-scheme

## Overview

DDL is a type of SQL statements which is bound to be used in database applications. After the 5.6 version, MySQL supports online-ddl, but there are restrictions for usage. For example, to acquire the MDL lock, some DDLs still need to be copied. In production scenario, the table lock during DDL execution can block the reads or writes to a certain extent.

By using gh-ost and pt-osc, DDLs can be executed on top of MySQL more effectively, and the impact on reads and writes is reduced as much as possible.

TiDB is implemented based on the online asynchronous schema change algorithm of Google F1. It does not block reads and writes during the DDL execution. Therefore, the large amount of data and binlog events in the intermediate tables generated by gh-ost and pt-osc in the process of online-schema-change is not needed during the replication from MySQL to TiDB.

For Data Migration (DM), which serves as the replication tool from MySQL to TiDB, the online-ddl-scheme feature is to perform special processing on the above two online-schema-change tools (gh-ost and pt-osc). This way, the required DDL replication can be completed more rapidly.

## Configuration

In the task configuration file, `online-ddl-scheme` is at the same level of `name`. For example:

```yml
# ----------- Global setting -----------
## ********* Basic configuration *********
name: test                      # The name of the task. Should be globally unique.
task-mode: all                  # The task mode. Can be set to `full`/`incremental`/`all`.
is-sharding: true               # Whether it is a task to merge shards.
meta-schema: "dm_meta"          # The downstream database that stores the `meta` information.
remove-meta: false              # Whether to remove the `meta` information (`checkpoint` and `onlineddl`) corresponding to the task name before starting the replication task.
enable-heartbeat: false         # Whether to enable the heartbeat feature.
online-ddl-scheme: "gh-ost"     # Only "gh-ost" and "pt" are currently supported.

target-database:                # Configuration of the downstream database instance.
  host: "192.168.0.1"
  port: 4000
  user: "root"
  password: ""                  # The dmctl encryption is needed when the password is not empty.
```

For all the configuration items and their usage, refer to [DM advanced task configuration file template](/reference/tools/data-migration/configure/task-configuration-file-full.md#task-configuration-file-template-advanced).

## online-schema-change: gh-ost

When gh-ost implements online-schema-change, 3 types of tables are created:

- gho: used to apply DDLs. When the data replication catches up with the origin table, the origin table is replaced by renaming.
- ghc: used to store information that is related to online-schema-change.
- del: created by renaming the origin table.

In the process of replication, DM divides the above tables into 3 categories:

- ghostTable: \_\*\_gho
- trashTable: \_\*\_ghc, \_\*\_del
- realTable: the origin table that executes online-ddl.

The SQL statements mostly used by gh-ost are as follows:

```sql
-- 1.
   Create /* gh-ost */ table `test`.`_test4_ghc` (
                        id bigint auto_increment,
                        last_update timestamp not null DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                        hint varchar(64) charset ascii not null,
                        value varchar(4096) charset ascii not null,
                        primary key(id),
                        unique key hint_uidx(hint)
                ) auto_increment=256 ;

-- 2.
   Create /* gh-ost */ table `test`.`_test4_gho` like `test`.`test4` ;

-- 3.
   Alter /* gh-ost */ table `test`.`_test4_gho` add column cl1 varchar(20) not null ;

-- 4.
   Insert /* gh-ost */ into `test`.`_test4_ghc`;

-- 5.
   Insert /* gh-ost `test`.`test4` */ ignore into `test`.`_test4_gho` (`id`, `date`, `account_id`, `conversion_price`, `ocpc_matched_conversions`, `ad_cost`, `cl2`)
      (select `id`, `date`, `account_id`, `conversion_price`, `ocpc_matched_conversions`, `ad_cost`, `cl2` from `test`.`test4` force index (`PRIMARY`)
        where (((`id` > _binary'1') or ((`id` = _binary'1'))) and ((`id` < _binary'2') or ((`id` = _binary'2')))) lock in share mode
      )   ;

-- 6.
   Rename /* gh-ost */ table `test`.`test4` to `test`.`_test4_del`, `test`.`_test4_gho` to `test`.`test4`;
```

> **Note:**
>
> The specific SQL statements of gh-ost vary with the parameters used in the execution of the tool. This document only lists the major SQL statements. For more details, refer to gh-ost documentation.

## Process `online-ddl-scheme: gh-ost`

1. The creation of `_test4_ghc` is not executed.

2. The creation of `_test4_gho` is not executed. Delete the `dm_meta.{task_name}\_onlineddl` record in the downstream according to the server_id of ghost_schema, ghost_table, and dm_worker. Clear the related information in memory.

    ```sql
    DELETE FROM dm_meta.{task_name}_onlineddl WHERE id = {server_id} and ghost_schema = {ghost_schema} and ghost_table = {ghost_table};
    ```

3. The DDL statement of `_test4_gho` is not executed. Record the executed DDL in `dm_meta.{task_name}\_onlineddl` and memory.

    ```sql
    REPLACE INTO dm_meta.{task_name}_onlineddl (id, ghost_schema , ghost_table , ddls) VALUES (......);
    ```

4. The DML statements that are not for **realtable** are not executed.

5. Split rename into two SQL statements.

    ```sql
    rename test.test4 to test._test4_del;
    rename test._test4_gho to test.test4;
    ```

6. `rename to _test4_del` is not executed. When `rename ghost_table to origin table` is executed, the following steps are taken:
   
   - Read the DDL statements recorded in memory in Step 3;
   - Replace ghost_table and ghost_schema with origin_table and its corresponding schema
   - Execute the modified command.

    ```sql
    alter table test._test4_gho add column cl1 varchar(20) not null;
    -- Replaced with:
    alter table test.test4 add column cl1 varchar(20) not null;
    ```

## online-schema-change: pt

When pt-osc implements online-schema-change, 2 types of tables are created:

- `new`: used to apply DDL. When the data replication catches up with the origin table, the origin table is replaced by renaming.
- `old`: created by renaming the origin table.
- 3 kinds of Trigger: `pt_osc\_\*\_ins`, `pt_osc\_\*\_upd`, `pt_osc\_\*\_del`. In the process of pt_osc, the new data generated by the origin table is replicated to `new` by the Trigger.

In the process of replication, DM divides the above tables into 3 categories:

- ghostTable: \_\*\_new
- trashTable: \_\*\_old
- realTable: the origin table that executes online-ddl.

The SQL statements mostly used by pt-osc are as follows:

``` sql
-- 1.
   CREATE TABLE `test`.`_test4_new` ( id int(11) NOT NULL AUTO_INCREMENT,
   date date DEFAULT NULL, account_id bigint(20) DEFAULT NULL, conversion_price decimal(20,3) DEFAULT NULL,  ocpc_matched_conversions bigint(20) DEFAULT NULL, ad_cost decimal(20,3) DEFAULT NULL,cl2 varchar(20) COLLATE utf8mb4_bin NOT NULL,cl1 varchar(20) COLLATE utf8mb4_bin NOT NULL,PRIMARY KEY (id) ) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin ;

-- 2.
   ALTER TABLE `test`.`_test4_new` add column c3 int

-- 3.
   CREATE TRIGGER `pt_osc_test_test4_del` AFTER DELETE ON `test`.`test4` ...... ;
   CREATE TRIGGER `pt_osc_test_test4_upd` AFTER UPDATE ON `test`.`test4` ...... ;
   CREATE TRIGGER `pt_osc_test_test4_ins` AFTER INSERT ON `test`.`test4` ...... ;

-- 4.
   INSERT LOW_PRIORITY IGNORE INTO `test`.`_test4_new` (`id`, `date`, `account_id`, `conversion_price`, `ocpc_matched_conversions`, `ad_cost`, `cl2`, `cl1`) SELECT `id`, `date`, `account_id`, `conversion_price`, `ocpc_matched_conversions`, `ad_cost`, `cl2`, `cl1` FROM `test`.`test4` LOCK IN SHARE MODE /*pt-online-schema-change 3227 copy table*/

- 5.
   RENAME TABLE `test`.`test4` TO `test`.`_test4_old`, `test`.`_test4_new` TO `test`.`test4`

-- 6.
   DROP TABLE IF EXISTS `test`.`_test4_old`;
   DROP TRIGGER IF EXISTS `pt_osc_test_test4_del` AFTER DELETE ON `test`.`test4` ...... ;
   DROP TRIGGER IF EXISTS `pt_osc_test_test4_upd` AFTER UPDATE ON `test`.`test4` ...... ;
   DROP TRIGGER IF EXISTS `pt_osc_test_test4_ins` AFTER INSERT ON `test`.`test4` ...... ;
```

> **Note:**
>
> The specific SQL statements of pt-osc vary with the parameters used in the execution of the tool. This document only lists the major SQL statements. For more details, refer to pt-osc documentation.

## Process `online-ddl-scheme: pt`

1. The creation of `_test4_new` is not executed. Delete the `dm_meta.{task_name}\_onlineddl` record in the downstream according to the server_id of ghost_schema, ghost_table, and dm_worker. Clear the related information in memory.

    ```sql
    DELETE FROM dm_meta.{task_name}_onlineddl WHERE id = {server_id} and ghost_schema = {ghost_schema} and ghost_table = {ghost_table};
    ```

2. The DDL statement of `_test4_new` is not executed. Record the executed DDL in `dm_meta.{task_name}\_onlineddl` and memory.

    ```sql
    REPLACE INTO dm_meta.{task_name}_onlineddl (id, ghost_schema , ghost_table , ddls) VALUES (......);
    ```

3. The Trigger operations that are not supported in TiDB are not executed.

4. The DML statements that are not for **realtable** are not executed.

5. Split rename into two SQL statements.

    ```sql
    rename test.test4 to test._test4_old; 
    rename test._test4_new to test.test4;
    ```

6. `rename to _test4_old` is not executed. When `rename ghost_table to origin table` is executed, the following steps are taken:

   - Read the DDL statements recorded in memory in Step 2;
   - Replace ghost_table and ghost_schema with origin_table and its corresponding schema
   - Execute the modified command.

    ```sql
    ALTER TABLE `test`.`_test4_new` add column c3 int;
    -- Replaced as:
    ALTER TABLE `test`.`test4` add column c3 int;
    ```

7. The deletion of `_test_old` and Trigger is not executed.
