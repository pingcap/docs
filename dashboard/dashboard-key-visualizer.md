---
title: Key Visualizer Page
summary: TiDBダッシュボードのKey Visualizerページでは、TiDBクラスタ内のトラフィックのホットスポットを分析およびトラブルシューティングできます。トラフィックの変化を時間経過とともに視覚的に表示し、特定の期間または地域範囲を拡大表示できます。また、明るさの調整、指標の選択、ヒートマップの更新などの設定も行えます。一般的なヒートマップの種類を特定し、ホットスポットの問題に対処するためのソリューションを提供します。
---

# キービジュアライザーページ {#key-visualizer-page}

TiDBダッシュボードのKey Visualizerページは、TiDBの使用状況を分析し、トラフィックのホットスポットをトラブルシューティングするために使用します。このページでは、一定期間にわたるTiDBクラスタのトラフィックを視覚的に表示します。

## アクセスキービジュアライザーページ {#access-key-visualizer-page}

Key Visualizer ページにアクセスするには、次の 2 つの方法のいずれかを使用できます。

-   TiDB ダッシュボードにログインしたら、左側のナビゲーション メニューで**Key Visualizer**をクリックします。

    ![Access Key Visualizer](/media/dashboard/dashboard-keyviz-access-v650.png)

-   ブラウザで[http://127.0.0.1:2379/ダッシュボード/#/keyviz](http://127.0.0.1:2379/dashboard/#/keyviz)アクセスしてください。3 `127.0.0.1:2379`実際のPDインスタンスのアドレスとポートに置き換えてください。

## インターフェースのデモンストレーション {#interface-demonstration}

次の画像は、Key Visualizer ページのデモです。

![Key Visualizer page](/media/dashboard/dashboard-keyviz-overview.png)

上記のインターフェースから、次のオブジェクトを確認できます。

-   全体的なトラフィックの経時的な変化を示す大きなヒートマップ。
-   特定の座標点の詳細情報。
-   テーブルとインデックスの情報 (ヒートマップの左側)。

## 基本概念 {#basic-concepts}

このセクションでは、Key Visualizer に関連する基本的な概念について説明します。

### リージョン {#region}

TiDBクラスタでは、保存されたデータはTiKVインスタンス間に分散されます。論理的には、TiKVは巨大で整然としたキーバリューマップです。キーバリュー空間全体は多数のセグメントに分割され、各セグメントは隣接するキーの列で構成されます。このようなセグメントは`Region`と呼ばれます。

リージョンの詳しい紹介については[TiDB 内部 (I) - データストレージ](https://www.pingcap.com/blog/tidb-internal-data-storage/)を参照してください。

### ホットスポット {#hotspot}

TiDBデータベースを使用する場合、ホットスポット問題が発生することがよくあります。これは、高トラフィックが狭い範囲のデータに集中する現象です。連続したデータ範囲が同じTiKVインスタンスで処理されることが多いため、ホットスポットが発生するTiKVインスタンスは、アプリケーション全体のパフォーマンスのボトルネックとなります。ホットスポット問題は、次のようなシナリオでよく発生します。

-   主キーが`AUTO_INCREMENT`であるテーブルに隣接するデータを書き込むと、このテーブルでホットスポットの問題が発生します。
-   隣接する時間データをテーブルの時間インデックスに書き込むと、テーブル インデックスでホットスポットの問題が発生します。

ホットスポットの詳細については、 [高同時書き込みのベストプラクティス](/best-practices/high-concurrency-best-practices.md#hotspot-causes)を参照してください。

### ヒートマップ {#heatmap}

ヒートマップはKey Visualizerの中核部分であり、メトリクスの経時的な変化を表示します。ヒートマップのX軸は時間を示します。Y軸は、TiDBクラスターのすべてのスキーマとテーブルをカバーするキー範囲に基づいて、連続したリージョンを示します。

ヒートマップ内の色が濃いほど、その期間におけるリージョンの読み取りおよび書き込みトラフィックが少ないことを示します。色が濃いほど（明るいほど）、トラフィックが多いことを示します。

### リージョン圧縮 {#region-compression}

TiDB クラスターには最大数十万のリージョンが含まれる場合があります。これほど多くのリージョンを画面に表示するのは困難です。そのため、各ヒートマップでは、これらのリージョンを 1,500 個の連続した範囲に圧縮し、各範囲を「バケット」と呼びます。ヒートマップでは、負荷の高いインスタンスに重点を置く必要があるため、Key Visualizer はトラフィックの少ない多数のリージョンを 1 つのバケットに圧縮し、トラフィックの多いリージョンも 1 つのバケットに表示するリージョンがあります。

## キービジュアライザーを使用する {#use-key-visualizer}

このセクションでは、Key Visualizer の使い方を紹介します。

### 設定 {#settings}

Key Visualizerページを初めてご利用になる場合は、 **「設定」**ページでこの機能を手動で有効にする必要があります。ページのガイドに従い、 **「設定を開く」**をクリックして設定ページを開きます。

![Feature disabled](/media/dashboard/dashboard-keyviz-not-enabled.png)

この機能を有効にすると、右上隅にある**設定**アイコンをクリックして設定ページを開くことができます。

![Settings icon](/media/dashboard/dashboard-keyviz-settings-button.png)

設定ページは次のように表示されます。

![Settings page](/media/dashboard/dashboard-keyviz-settings.png)

スイッチを介してデータ収集を開始するかどうかを設定し、 **「保存」**をクリックして設定を有効にします。機能を有効にすると、ツールバーが利用可能になります。

![Toolbar](/media/dashboard/dashboard-keyviz-toolbar.png)

この機能を有効にすると、バックエンドでデータ収集が開始されます。まもなくヒートマップが表示されます。

### 特定の期間またはリージョン範囲を観察する {#observe-a-certain-period-of-time-or-region-range}

Key Visualizer を開くと、デフォルトで過去 6 時間のデータベース全体のヒートマップが表示されます。このヒートマップでは、右側（現在時刻）に近いほど、各バケット列に対応する時間間隔が短くなります。特定の期間または特定のリージョン範囲を観察したい場合は、拡大して詳細を確認できます。具体的な手順は以下のとおりです。

1.  ヒートマップを上または下にスクロールします。
2.  範囲を選択するには、次のいずれかのボタンをクリックしてドラッグします。

    -   **「選択とズーム」**ボタンをクリックします。次に、このボタンをクリック＆ドラッグして、ズームインする領域を選択します。

    ![Selection box](/media/dashboard/dashboard-keyviz-select-zoom.gif)

    -   リージョン範囲をデータベース全体にリセットするには、 **[リセット]**ボタンをクリックします。
    -   **時間選択ボックス**(前のインターフェイスの`6 hour`の位置) をクリックし、観測期間を再度選択します。

    ![Select time](/media/dashboard/dashboard-keyviz-select-time.png)

> **注記：**
>
> 上記の手順2を実行すると、ヒートマップが再描画されますが、元のヒートマップとは大きく異なる可能性があります。この差異は正常です。詳しく観察すると、リージョン圧縮の粒度が変更されたか、特定の範囲における`hot`の基準が変更されたことがわかります。

### 明るさを調整する {#adjust-brightness}

ヒートマップでは、バケットのトラフィックを異なる明るさの色で示します。ヒートマップ上の寒色系は、その期間におけるリージョンの読み取りおよび書き込みトラフィックが少ないことを示します。暖色系（明るい色）は、トラフィックが多いことを示します。色が寒色系または暖色系すぎると、詳細な観察が困難になります。このような場合は、「**明るさ」**ボタンをクリックし、スライダーを使ってページの明るさを調整できます。

> **注記：**
>
> Key Visualizer がエリアのヒートマップを表示する際、そのエリアのトラフィックに基づいてコールドとホットの基準を定義します。エリア全体のトラフィックが比較的均一な場合、全体のトラフィック値が低くても、明るい色の大きなエリアが表示されることがあります。分析にはこの値を含めることを忘れないでください。

### 指標を選択 {#select-metrics}

![Select metrics](/media/dashboard/dashboard-keyviz-select-type.png)

関心のあるメトリックを表示するには**、メトリック選択ボックス**(上記のインターフェイスの`Write (bytes)`番目の位置) でこのメトリックを選択します。

-   `Read (bytes)` : トラフィックを読み取ります。
-   `Write (bytes)` : トラフィックを書き込みます。
-   `Read (keys)` : 読み取られた行数。
-   `Write (keys)` : 書き込まれた行数。
-   `All` : 読み取りトラフィックと書き込みトラフィックの合計。

### 更新と自動更新 {#refresh-and-automatic-refresh}

現在の時刻に基づくヒートマップを再度表示するには、 **「更新」**ボタンをクリックします。データベースのトラフィック分布をリアルタイムで確認する必要がある場合は、 **「更新」**ボタンの右側にある下矢印をクリックし、ヒートマップの自動更新間隔を指定します。

> **注記：**
>
> 時間範囲またはリージョン範囲を調整すると、自動更新は無効になります。

### バケットの詳細を見る {#see-bucket-details}

関心のあるバケットにマウスオーバーすると、そのリージョン範囲の詳細情報が表示されます。以下の画像は、この情報の例です。

![Bucket details](/media/dashboard/dashboard-keyviz-tooltip.png)

この情報をコピーしたい場合は、バケットをクリックしてください。すると、関連する詳細を含むページが一時的にピン留めされます。その情報をクリックすると、クリップボードにコピーされます。

![Copy Bucket details](/media/dashboard/dashboard-keyviz-tooltip-copy.png)

## 一般的なヒートマップの種類 {#common-heatmap-types}

このセクションでは、Key Visualizer の一般的な 4 種類のヒートマップを示して解釈します。

### 均等に分散された作業負荷 {#evenly-distributed-workload}

![Balanced](/media/dashboard/dashboard-keyviz-well-dist.png)

上のヒートマップでは、明るい色と暗い色が細かく混在しています。これは、読み取りまたは書き込みが時間の経過とともに、またキー範囲間で均等に分散されていることを示しています。ワークロードはすべてのノードに均等に分散されており、これは分散データベースに最適です。

### 定期的に読み書きする {#periodically-reads-and-writes}

![Periodically](/media/dashboard/dashboard-keyviz-period.png)

上記のヒートマップでは、X軸（時間）に沿って明暗が交互に変化していますが、Y軸（リージョン）に沿って明度は比較的均一です。これは、読み取りと書き込みが定期的に変化していることを示しています。これは、定期的にスケジュールされたタスクを実行するシナリオで発生する可能性があります。例えば、ビッグデータプラットフォームはTiDBから毎日定期的にデータを抽出します。このようなシナリオでは、ピーク使用時にリソースが十分かどうかに注意してください。

### 集中した読み取りまたは書き込み {#concentrated-reads-or-writes}

![Concentrated](/media/dashboard/dashboard-keyviz-continue.png)

上のヒートマップには、複数の明るい線が見られます。Y軸に沿って、明るい線の周囲の縁が暗くなっているのは、明るい線に対応するリージョンで読み取りと書き込みのトラフィックが多いことを示しています。これにより、トラフィックの分布がアプリケーションで想定されているかどうかを確認できます。例えば、すべてのサービスがユーザーテーブルに関連付けられている場合、ユーザーテーブル全体のトラフィックが高くなる可能性があるため、ヒートマップに明るい線を表示するのは妥当です。

さらに、明るい線の高さ（Y軸の太さ）も重要です。TiKVには独自のリージョンベースのホットスポット分散メカニズムがあるため、ホットスポットに関係するリージョンが多いほど、すべてのTiKVインスタンス間でトラフィック分散が適切に行われます。線が太く明るい線が多いほど、ホットスポットが分散しており、TiKVの活用度が高いことを示します。明るい線が細く少ないほど、ホットスポットが集中しており、TiKVにおけるホットスポットの問題がより顕著であり、手動による介入が必要になる可能性があることを示します。

### 順次読み取りまたは書き込み {#sequential-reads-or-writes}

![Sequential](/media/dashboard/dashboard-keyviz-sequential.png)

上のヒートマップには明るい線が見られます。これは、データの読み取りまたは書き込みがシーケンシャルであることを意味します。シーケンシャルなデータの読み取りまたは書き込みの典型的なシナリオは、データのインポートやテーブルとインデックスのスキャンです。例えば、自動インクリメントIDを持つテーブルにデータを継続的に書き込む場合などです。

明るいエリアにあるリージョンは、読み取りおよび書き込みトラフィックのホットスポットであり、多くの場合、クラスター全体のパフォーマンスのボトルネックとなります。このような状況では、アプリケーションのプライマリキーを再調整する必要があるかもしれません。これにより、リージョンを可能な限り分散させ、負荷を複数のリージョンに分散させることができます。また、アプリケーションタスクを低ピーク時にスケジュールすることもできます。

> **注記：**
>
> このセクションでは、一般的なタイプのヒートマップのみを示しています。Key Visualizer は実際にはクラスター全体のすべてのスキーマとテーブルのヒートマップを表示するため、エリアによって異なるタイプのヒートマップが表示されたり、複数のタイプのヒートマップが混在したりする場合があります。実際の状況に応じてヒートマップを使用してください。

## ホットスポットの問題に対処する {#address-hotspot-issues}

TiDBには、共通ホットスポット問題を軽減するための機能がいくつか組み込まれています。詳細は[高同時書き込みのベストプラクティス](/best-practices/high-concurrency-best-practices.md)を参照してください。
