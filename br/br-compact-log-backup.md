---
title: Compact Log Backup
summary: ログ バックアップを SST 形式に圧縮することで、ポイントインタイム リカバリ (PITR) の効率を向上させる方法を学習します。
---

# コンパクトログバックアップ {#compact-log-backup}

このドキュメントでは、ログバックアップを[SST](/glossary.md#static-sorted-table--sorted-string-table-sst)形式に圧縮することで、ポイントインタイムリカバリ ( [PITR](/glossary.md#point-in-time-recovery-pitr) ) の効率を向上させる方法について説明します。

## 概要 {#overview}

従来のログ バックアップでは、書き込み操作が極めて非構造化された方法で保存されるため、次のような問題が発生する可能性があります。

-   **回復パフォーマンスの低下**: 順序付けられていないデータは、 Raftプロトコルを介してクラスターに 1 つずつ書き込む必要があります。
-   **書き込み増幅**: すべての書き込みは、L0 から最下レベルまでレベルごとに圧縮する必要があります。
-   **完全バックアップへの依存**: リカバリ データの量を制御するには、頻繁な完全バックアップが必要であり、アプリケーションの操作に影響を及ぼす可能性があります。

バージョン8.5.5以降、コンパクトログバックアップ機能にオフラインコンパクション機能が追加され、非構造化ログバックアップデータを構造化SSTファイルに変換できるようになりました。これにより、以下の改善がもたらされます。

-   SST ファイルをクラスターに迅速にインポートできるため、**リカバリ パフォーマンスが向上します**。
-   圧縮中に冗長データが削除され、**storageスペースの消費量が削減されます**。
-   リカバリ時間目標 (RTO) を確保しながら、より長い完全バックアップ間隔を設定できるため、**アプリケーションへの影響を軽減できます**。

## 制限事項 {#limitations}

-   コンパクトログバックアップは完全バックアップの代替手段ではありません。定期的な完全バックアップと併用する必要があります。PITR機能を確保するため、圧縮プロセスではすべてのMVCCバージョンが保持されます。完全バックアップを長期間実行しないと、storage使用量が過剰になり、後でデータを復元する際に問題が発生する可能性があります。
-   現在、ローカル暗号化を有効にしたバックアップの圧縮はサポートされていません。

## コンパクトログバックアップを使用する {#use-compact-log-backup}

現在、ログバックアップの圧縮は手動でのみサポートされており、プロセスは複雑です。**本番環境でのログバックアップの圧縮には、今後リリースされるTiDB Operatorソリューションのご利用をお勧めします。**

### 手作業による圧縮 {#manual-compaction}

このセクションでは、ログ バックアップを手動で圧縮する手順について説明します。

#### 前提条件 {#prerequisites}

ログ バックアップを手動で圧縮するには、 `tikv-ctl`と`br` 2 つのツールが必要です。

#### ステップ1:storageをBase64でエンコードする {#step-1-encode-storage-to-base64}

次のエンコード コマンドを実行します。

```shell
br operator base64ify --storage "s3://your/log/backup/storage/here" --load-creds
```

> **注記：**
>
> -   上記のコマンドを実行する際にオプション`--load-creds`を指定した場合、エンコードされたBase64文字列には、現在のBR環境から読み込まれた認証情報が含まれます。適切なセキュリティとアクセス制御を確保するためにご注意ください。
> -   `--storage`値は、ログ バックアップ タスクの`log status`コマンドからのstorage出力と一致します。

#### ステップ2: ログ圧縮を実行する {#step-2-execute-log-compaction}

Base64エンコードstorageでは、 `tikv-ctl`で圧縮を開始できます。デフォルトのログレベルは`tikv-ctl`ですが、 `warning`です。より詳細な情報を取得するには`--log-level info`使用してください。

```shell
tikv-ctl --log-level info compact-log-backup \
    --from "<start-tso>" --until "<end-tso>" \
    -s 'bAsE64==' -N 8
```

パラメータの説明:

-   `-s` : 先ほど取得した Base64 でエンコードされたstorage文字列。
-   `-N` : 同時ログ圧縮タスクの最大数。
-   `--from` : 圧縮の開始タイムスタンプ。
-   `--until` : 圧縮の終了タイムスタンプ。

パラメータ`--from`と`--until`は、圧縮操作の時間範囲を定義します。圧縮操作では、指定された時間範囲内の書き込み操作を含むすべてのログファイルが処理されるため、生成されるSSTファイルにはこの範囲外のデータが含まれる場合があります。

特定の時点のタイムスタンプを取得するには、次のコマンドを実行します。

```shell
echo $(( $(date --date '2004-05-06 15:02:01Z' +%s%3N) << 18 ))
```

> **注記：**
>
> macOS ユーザーの場合は、 Homebrew経由で`coreutils`インストールし、 `date`ではなく`gdate`使用する必要があります。
>
> ```shell
> echo $(( $(gdate --date '2004-05-06 15:02:01Z' +%s%3N) << 18 ))
> ```
