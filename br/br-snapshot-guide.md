---
title: Snapshot Backup and Restore Guide
summary: このドキュメントでは、br コマンドラインツールを使用して TiDB スナップショットをバックアップおよび復元する方法について説明します。スナップショットのバックアップ、指定した時点のデータの復元、データベースまたはテーブルの復元の手順が含まれています。また、スナップショットのバックアップと復元のパフォーマンスと影響についても説明します。
---

# スナップショットのバックアップと復元ガイド {#snapshot-backup-and-restore-guide}

このドキュメントでは、br コマンドラインツール（以下、 `br`と呼びます）を使用して TiDB スナップショットをバックアップおよび復元する方法について説明します。データのバックアップと復元を行う前に、まず[brコマンドラインツールをインストールする](/br/br-use-overview.md#deploy-and-use-br)行う必要があります。

スナップショットバックアップは、クラスタ全体をバックアップする実装です。1 [マルチバージョン同時実行制御 (MVCC)](/tidb-storage.md#mvcc)ベースとし、指定されたスナップショット内のすべてのデータをターゲットstorageにバックアップします。バックアップデータのサイズは、クラスタ内の圧縮された単一レプリカのサイズとほぼ同等です。バックアップ完了後、バックアップデータを空のクラスタまたは競合データを含まないクラスタ（同一スキーマまたは同一テーブル）に復元したり、スナップショットバックアップの時点にクラスタを復元したり、クラスタレプリカ設定に従って複数のレプリカを復元したりできます。

基本的なバックアップと復元に加えて、スナップショット バックアップと復元では次の機能も提供されます。

-   [指定した時点のバックアップデータ](#back-up-cluster-snapshots)
-   [指定されたデータベースまたはテーブルのデータを復元する](#restore-a-database-or-a-table)

## クラスターのスナップショットをバックアップする {#back-up-cluster-snapshots}

> **注記：**
>
> -   以下の例では、Amazon S3 アクセスキーとシークレットキーを使用して権限を承認することを前提としています。IAM ロールを使用して権限を承認する場合は、 `--send-credentials-to-tikv`を`false`に設定する必要があります。
> -   他のstorageシステムまたは認証方法を使用して権限を認証する場合は、 [バックアップストレージ](/br/backup-and-restore-storages.md)に従ってパラメータ設定を調整します。

`tiup br backup full`コマンドを実行すると、TiDB クラスターのスナップショットをバックアップできます。ヘルプ情報を表示するには、 `tiup br backup full --help`を実行します。

```shell
tiup br backup full --pd "${PD_IP}:2379" \
    --backupts '2022-09-08 13:30:00 +08:00' \
    --storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}" 
```

上記のコマンドでは、次のようになります。

-   `--backupts` : スナップショットの時点。形式は[TSO](/tso.md)またはタイムスタンプ（例： `400036290571534337` 、 `2018-05-11 01:42:23 +08:00`です。このスナップショットのデータがガベージコレクションされた場合、 `tiup br backup`コマンドはエラーを返し、 `br`終了します。タイムスタンプを使用してバックアップする場合は、タイムゾーンも指定することをお勧めします。指定しない場合、 `br`デフォルトでローカルタイムゾーンを使用してタイムスタンプを作成するため、バックアップの時点が不正確になる可能性があります。このパラメータを指定しない場合、 `br`バックアップ開始時刻に対応するスナップショットを選択します。
-   `--storage` : バックアップデータのstorageアドレス。スナップショットバックアップは、Amazon S3、Google Cloud Storage、Azure Blob Storageをバックアップstorageとしてサポートしています。上記のコマンドでは、例としてAmazon S3を使用しています。詳細については、 [外部ストレージサービスのURI形式](/external-storage-uri.md)参照してください。

バックアップ中は、ターミナルに以下のようにプログレスバーが表示されます。プログレスバーが100%に達すると、バックアップタスクが完了し、合計バックアップ時間、平均バックアップ速度、バックアップデータサイズなどの統計情報が表示されます。

-   `total-ranges` : バックアップするファイルの総数を示します。
-   `ranges-succeed` : 正常にバックアップされたファイルの数を示します。
-   `ranges-failed` : バックアップに失敗したファイルの数を示します。
-   `backup-total-ranges` : バックアップするテーブル (パーティションを含む) とインデックスの数を示します。
-   `write-CF-files` : `write CF`データを含むバックアップ SST ファイルの数を示します。
-   `default-CF-files` : `default CF`データを含むバックアップ SST ファイルの数を示します。

```shell
Full Backup <-------------------------------------------------------------------------------> 100.00%
Checksum <----------------------------------------------------------------------------------> 100.00%
*** ["Full Backup success summary"] *** [total-ranges=20] [ranges-succeed=20] [ranges-failed=0] [backup-checksum=3.597416ms] [backup-fast-checksum=2.36975ms] [backup-total-ranges=11] [backup-total-regions=10] [write-CF-files=14] [default-CF-files=6] [total-take=4.715509333s] [BackupTS=435844546560000000] [total-kv=1131] [total-kv-size=250kB] [average-speed=53.02kB/s] [backup-data-size(after-compressed)=71.33kB] [Size=71330]
```

## スナップショットバックアップのバックアップ時点を取得する {#get-the-backup-time-point-of-a-snapshot-backup}

多数のバックアップを管理するために、スナップショット バックアップの物理的な時間を取得する必要がある場合は、次のコマンドを実行できます。

```shell
tiup br validate decode --field="end-version" \
--storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}" | tail -n1
```

出力は次のようになり、物理時間`2022-09-08 13:30:00 +0800 CST`に対応します。

    435844546560000000

## クラスタースナップショットを復元する {#restore-cluster-snapshots}

> **注記：**
>
> -   BR v7.5.0 以前のバージョンでは、TiKV ノードあたりのスナップショット復元速度は約 100 MiB/秒です。
> -   BR v7.6.0以降、大規模リージョンのシナリオにおける潜在的なリストアボトルネックに対処するため、粗粒度のリージョン分散アルゴリズム（実験的）によるリストアの高速化がBRでサポートされます。この機能は、コマンドラインパラメータ`--granularity="coarse-grained"`を指定することで有効化できます。
> -   BR v8.0.0 以降では、粗粒度リージョン分散アルゴリズムによるスナップショット復元が一般提供 (GA) され、デフォルトで有効になっています。BRBR、粗粒度リージョン分散アルゴリズムの採用、データベースとテーブルのバッチ作成、SST ファイルのダウンロードと取り込み操作の相互影響の低減、テーブル統計の復元の高速化など、さまざまな最適化を実装することで、スナップショットの復元速度が大幅に向上しています。実際のケースでのテスト結果によると、スナップショット復元の SST ファイルのダウンロード速度は最大約 10 倍向上し、TiKV ノードあたりのデータ復元速度は 1.2 GiB/s で安定し、エンドツーエンドの復元速度は約 1.5～3 倍向上し、100 TiB のデータを 1 時間以内に復元できます。
> -   BR v8.2.0 以降では、コマンド ライン パラメータ`--granularity`は非推奨となり、粗粒度リージョン散乱アルゴリズムがデフォルトで有効になります。
> -   BR v8.3.0 以降、スナップショット復元タスクでは、TiKV およびTiFlashの使用可能なディスク容量チェックが導入されています。タスクの開始時に、 BR は復元する SST ファイルのサイズに基づいて、TiKV およびTiFlashに十分なディスク容量があるかどうかを確認します。TiKV v8.3.0 以降のバージョンでは、TiKV は各 SST ファイルをダウンロードする前に十分なディスク容量があるかどうかを確認します。これらのチェックのいずれかで容量が不足している場合、復元タスクはエラーで失敗します。1 `--check-requirements=false`設定することで復元タスクの開始時のチェックをスキップできますが、TiKV が各 SST ファイルをダウンロードする前のディスク容量チェックはスキップできません。

スナップショットバックアップを復元するには、コマンド`tiup br restore full`を実行します。ヘルプ情報を表示するには、コマンド`tiup br restore full --help`を実行します。

次の例では、 [前のバックアップスナップショット](#back-up-cluster-snapshots)ターゲット クラスターに復元します。

```shell
tiup br restore full --pd "${PD_IP}:2379" \
--storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}"
```

復元中は、ターミナルに以下のようにプログレスバーが表示されます。プログレスバーが100%に達すると、復元タスクが完了し、合計復元時間、平均復元速度、合計データサイズなどの統計情報が表示されます。

-   `total-ranges` : 復元するファイルの合計数を示します。
-   `ranges-succeed` : 正常に復元されたファイルの数を示します。
-   `ranges-failed` : 復元に失敗したファイルの数を示します。
-   `merge-ranges` : データ範囲の結合にかかる時間を示します。
-   `split-region` : 領域を分割して分散するのにかかる時間を示します。
-   `restore-files` : TiKV が SST ファイルをダウンロードして取り込むのにかかる時間を示します。
-   `write-CF-files` : `write CF`データを含む復元された SST ファイルの数を示します。
-   `default-CF-files` : `default CF`データを含む復元された SST ファイルの数を示します。
-   `split-keys` : 領域を分割するために生成されたキーの数を示します。

```shell
Split&Scatter Region <--------------------------------------------------------------------> 100.00%
Download&Ingest SST <---------------------------------------------------------------------> 100.00%
Restore Pipeline <------------------------------------------------------------------------> 100.00%
*** ["Full Restore success summary"] [total-ranges=20] [ranges-succeed=20] [ranges-failed=0] [merge-ranges=7.546971ms] [split-region=343.594072ms] [restore-files=1.57662s] [default-CF-files=6] [write-CF-files=14] [split-keys=9] [total-take=4.344617542s] [total-kv=5] [total-kv-size=327B] [average-speed=75.27B/s] [restore-data-size(after-compressed)=4.813kB] [Size=4813] [BackupTS=435844901803917314]
```

データの復元中、対象テーブルのテーブルモードは自動的に`restore`に設定されます。モード`restore`のテーブルでは、読み取りおよび書き込み操作は許可されません。データの復元が完了すると、テーブルモードは自動的に`normal`に戻り、通常通りテーブルの読み取りおよび書き込みが可能になります。このメカニズムにより、復元プロセス全体を通じてタスクの安定性とデータの一貫性が確保されます。

### データベースまたはテーブルを復元する {#restore-a-database-or-a-table}

BRは、バックアップデータから指定されたデータベースまたはテーブルの部分的なデータを復元することをサポートしています。この機能により、不要なデータを除外し、特定のデータベースまたはテーブルのみをバックアップできます。

**データベースを復元する**

データベースをクラスターに復元するには、 `tiup br restore db`コマンドを実行します。次の例では、 `test`データベースをバックアップデータからターゲットクラスターに復元します。

```shell
tiup br restore db \
--pd "${PD_IP}:2379" \
--db "test" \
--storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}"
```

上記のコマンドでは、 `--db`復元するデータベースの名前を指定します。

**テーブルを復元する**

単一のテーブルをクラスターに復元するには、 `tiup br restore table`コマンドを実行します。次の例では、バックアップデータから`test.usertable`テーブルをターゲットクラスターに復元します。

```shell
tiup br restore table --pd "${PD_IP}:2379" \
--db "test" \
--table "usertable" \
--storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}"
```

上記のコマンドでは、 `--db`復元するデータベースの名前を指定し、 `--table`復元するテーブルの名前を指定します。

**テーブルフィルターを使用して複数のテーブルを復元する**

より複雑なフィルタールールを持つ複数のテーブルを復元するには、 `tiup br restore full`コマンドを実行し、 [テーブルフィルター](/table-filter.md)に`--filter`または`-f`を指定します。次の例では、バックアップデータから`db*.tbl*`フィルタールールに一致するテーブルをターゲットクラスターに復元します。

```shell
tiup br restore full \
--pd "${PD_IP}:2379" \
--filter 'db*.tbl*' \
--storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}"
```

### <code>mysql</code>スキーマ内のテーブルを復元する {#restore-tables-in-the-code-mysql-code-schema}

-   BR v5.1.0 以降では、スナップショットをバックアップすると、 BR は`mysql`スキーマ内の**システム テーブルを**自動的にバックアップしますが、デフォルトではこれらのシステム テーブルを復元しません。
-   v6.2.0 以降、 BR**一部のシステム テーブルのデータを**復元するために`--with-sys-table`指定できます。
-   v7.6.0 以降、 BR はデフォルトで`--with-sys-table`有効にします。つまり、 BR はデフォルトで**一部のシステム テーブルのデータ**を復元します。
-   v8.5.5以降、 BRはシステムテーブルの物理リストアをサポートするためにパラメータ`--fast-load-sys-tables`を導入しました。このパラメータはデフォルトで有効になっています。このアプローチでは、DDL文`RENAME TABLE`を使用して、データベース`__TiDB_BR_Temporary_mysql`のシステムテーブルとデータベース`mysql`のシステムテーブルをアトミックにスワップします。SQL文`REPLACE INTO`を使用したシステムテーブルの論理リストアとは異なり、物理リストアではシステムテーブル内の既存データが完全に上書きされます。

**BR は次のシステム テーブルのデータを復元できます。**

    +----------------------------------+
    | mysql.columns_priv               |
    | mysql.db                         |
    | mysql.default_roles              |
    | mysql.global_grants              |
    | mysql.global_priv                |
    | mysql.role_edges                 |
    | mysql.tables_priv                |
    | mysql.user                       |
    | mysql.bind_info                  |
    +----------------------------------+

**BR は次のシステム テーブルを復元しません。**

-   統計表（ `mysql.stat_*` ）。ただし、統計は復元可能です。3 [統計のバックアップ](/br/br-snapshot-manual.md#back-up-statistics)参照してください。
-   システム変数テーブル（ `mysql.tidb`と`mysql.global_variables` ）
-   [その他のシステムテーブル](https://github.com/pingcap/tidb/blob/release-8.5/br/pkg/restore/snap_client/systable_restore.go#L31)

<!---->

    +-----------------------------------------------------+
    | capture_plan_baselines_blacklist                    |
    | column_stats_usage                                  |
    | gc_delete_range                                     |
    | gc_delete_range_done                                |
    | global_variables                                    |
    | stats_buckets                                       |
    | stats_extended                                      |
    | stats_feedback                                      |
    | stats_fm_sketch                                     |
    | stats_histograms                                    |
    | stats_history                                       |
    | stats_meta                                          |
    | stats_meta_history                                  |
    | stats_table_locked                                  |
    | stats_top_n                                         |
    | tidb                                                |
    +-----------------------------------------------------+

システム権限に関連するデータを復元する場合、 BR は復元前に、ターゲット クラスタ内のシステム テーブルがバックアップ データ内のシステム テーブルと互換性があるかどうかを確認します。「互換性がある」とは、以下のすべての条件が満たされていることを意味します。

-   ターゲット クラスターには、バックアップ データと同じシステム テーブルがあります。
-   ターゲットクラスタのシステム権限テーブルの**列数は**、バックアップデータと同じになります。列の順序は重要ではありません。
-   ターゲットクラスタのシステム権限テーブルの列は、バックアップデータの列と互換性があります。列のデータ型が長さを持つ型（整数や文字列など）の場合、ターゲットクラスタの長さはバックアップデータの長さ以上である必要があります。列のデータ型が`ENUM`の場合、ターゲットクラスタの`ENUM`の値の数は、バックアップデータの値のスーパーセットである必要があります。

## パフォーマンスと影響 {#performance-and-impact}

### スナップショットバックアップのパフォーマンスと影響 {#performance-and-impact-of-snapshot-backup}

バックアップ機能はクラスターのパフォーマンス（トランザクションレイテンシーとQPS）に多少の影響を及ぼします。ただし、バックアップスレッド数を調整するか、クラスターを追加することで[`backup.num-threads`](/tikv-configuration-file.md#num-threads-1)影響を軽減できます。

バックアップの影響を説明するために、このドキュメントでは、いくつかのスナップショット バックアップ テストのテスト結果をリストします。

-   (5.3.0 以前) TiKV ノード上のBRのバックアップ スレッドがノードの合計 CPU の 75% を占めると、QPS は元の QPS の 35% 減少します。
-   (5.4.0 以降) TiKV ノード上のBRスレッドが`8`以下で、クラスターの合計 CPU 使用率が 80% を超えない場合、 BRタスク (書き込みと読み取り) がクラスターに与える影響は最大で 20% になります。
-   (5.4.0 以降) TiKV ノードにBRのスレッドが`8`以下で、クラスターの合計 CPU 使用率が 75% を超えない場合、 BRタスク (書き込みと読み取り) がクラスターに与える影響は最大で 10% になります。
-   (5.4.0 以降) TiKV ノードにBRのスレッドが`8`以下で、クラスターの合計 CPU 使用率が 60% を超えない場合、 BRタスクはクラスターにほとんど影響を与えません (書き込みと読み取り)。

以下の方法を使用して、バックアップタスクがクラスターのパフォーマンスに与える影響を手動で制御できます。ただし、これらの2つの方法は、バックアップタスクがクラスターに与える影響を軽減する一方で、バックアップタスクの速度も低下させます。

-   推奨方法：バックアップタスクで使用されるワーカースレッドの数を制御するTiKV構成パラメータ[`backup.num-threads`](/tikv-configuration-file.md#num-threads-1)を調整します。バックアップはCPUを大量に消費する処理であるため、このパラメータを調整することでTiKVのCPU使用率をより正確に制御し、リソースの分離と予測可能性を向上させることができます。ほとんどのシナリオでは、 `num-threads`調整するだけで、バックアップがクラスターに与える影響を制限するのに十分です。社内テストでは、スレッド数を`8`以下に設定し、クラスター全体のCPU使用率が60%未満であれば、バックアップがフォアグラウンドワークロードに与える影響はごくわずかであることが示されています。

-   代替方法：既に`backup.num-threads`小さな値（例えば`1` ）に設定しているものの、バックアップがクラスターに与える影響をさらに軽減したい場合は、 `--ratelimit`パラメータの使用を検討してください。このオプションは、バックアップファイルを外部storageに書き込む際に使用する帯域幅を MiB/s 単位で制限します。実際のレート制限効果は、圧縮データのサイズによって異なります。詳細については、ログの`backup data size (after compressed)`フィールドを参照してください。 `--ratelimit`有効にすると、 BR は同時リクエスト数を減らすために自動的に`--concurrency`を`1`に設定します。

> **注記：**
>
> `--ratelimit`有効にすると、バックアップスループットがさらに低下します。通常、オフピーク時にバックアップを実行しており、 `backup.num-threads`を 1 に減らしてもフォアグラウンドワークロードへのバックアップの影響が見られる場合、クラスターのリソース制限に近づいていることを示しています。
>
> このような状況では、次の代替案を検討できます。
>
> -   利用可能なリソースを増やすには[クラスターをスケールアウトする](/tiup/tiup-cluster.md#scale-out-a-cluster)します。
> -   [`Log Backup`](/br/br-log-architecture.md)有効にすると、バックアップの負荷が軽減され、オンライン ワークロードの中断が最小限に抑えられます。

バックアップスレッド数を制限することで、バックアップがクラスターのパフォーマンスに与える影響を軽減できますが、これはバックアップのパフォーマンスにも影響を及ぼします。前述のテストでは、バックアップ速度はバックアップスレッド数に比例することが示されています。スレッド数が少ない場合、バックアップ速度は約20MiB/スレッドです。例えば、単一のTiKVノードで5つのバックアップスレッドを実行すると、100MiB/秒のバックアップ速度に達する可能性があります。

### スナップショット復元のパフォーマンスと影響 {#performance-and-impact-of-snapshot-restore}

-   データ復元中、TiDBはTiKVのCPU、ディスクIO、ネットワーク帯域幅のリソースを最大限に活用しようとします。そのため、実行中のアプリケーションへの影響を避けるため、バックアップデータは空のクラスタ上で復元することをお勧めします。
-   バックアップデータの復元速度は、クラスタ構成、デプロイメント、実行中のアプリケーションに大きく依存します。スナップショット復元のパフォーマンスと影響は、ユーザーシナリオによって異なるため、実際の環境でテストする必要があります。
-   BRは、大規模リージョンシナリオにおけるリージョン復元を高速化するために、粗粒度のリージョン分散アルゴリズムを提供します。このアルゴリズムにより、各TiKVノードが安定的かつ均等に分散されたダウンロードタスクを受け取ることができるため、各TiKVノードのリソースを最大限に活用し、迅速な並列リカバリを実現できます。いくつかの実例において、大規模リージョンシナリオにおいて、クラスターのスナップショット復元速度が約3倍向上しました。
-   v8.0.0以降、コマンドラインツール`br`に、TiKVノードごとにBRがダウンロードおよびインジェストするファイルの最大数を制御するためのパラメータ`--tikv-max-restore-concurrency`が導入されました。このパラメータを設定することで、ジョブキューの最大長（ジョブキューの最大長 = 32 * TiKVノード数 * `--tikv-max-restore-concurrency` ）も制御でき、 BRノードのメモリ消費量を制御できます。

    通常、 `--tikv-max-restore-concurrency`クラスタ構成に基づいて自動的に調整されるため、手動での設定は不要です。Grafana の**TiKV-Details** &gt; **Backup &amp; Import** &gt; **Import RPC count**監視メトリックで、 BR がダウンロードするファイル数が長時間 0 に近い状態が続く一方で、 BR が取り込むファイル数が常に上限に達している場合は、ファイル取り込みタスクが山積みになり、ジョブキューが最大長に達していることを示しています。この場合、タスク山積みの問題を軽減するために、以下の対策を講じることができます。

    -   パラメータ`--ratelimit`を設定するとダウンロード速度が制限され、ファイル取り込みタスクに十分なリソースが確保されます。例えば、TiKVノードのディスクスループットが`x MiB/s`で、バックアップファイルのダウンロードに必要なネットワーク帯域幅が`x/2 MiB/s`超える場合は、パラメータを`--ratelimit x/2`に設定できます。TiKVノードのディスクスループットが`x MiB/s`で、バックアップファイルのダウンロードに必要なネットワーク帯域幅が`x/2 MiB/s`以下の場合は、パラメータ`--ratelimit`を設定せずにそのままにしておくことができます。
    -   ジョブ キューの最大長を増やすには、 `--tikv-max-restore-concurrency`を増やします。

## 参照 {#see-also}

-   [TiDB バックアップと復元のユースケース](/br/backup-and-restore-use-cases.md)
-   [br コマンドラインマニュアル](/br/use-br-command-line-tool.md)
-   [TiDB スナップショットのバックアップと復元のアーキテクチャ](/br/br-snapshot-architecture.md)
