---
title: Handle Performance Issues of TiDB Data Migration
summary: DM に存在する可能性のある一般的なパフォーマンスの問題とその対処方法について学習します。
---

# TiDBデータ移行のパフォーマンス問題への対処 {#handle-performance-issues-of-tidb-data-migration}

このドキュメントでは、DM に存在する可能性のある一般的なパフォーマンスの問題とその対処方法について説明します。

問題を診断する前に、 [DMベンチマークレポート](https://github.com/pingcap/docs-dm/blob/release-5.3/en/dm-benchmark-v5.3.0.md)を参照してください。

パフォーマンスの問題を診断して処理するときは、次の点を確認してください。

-   DM 監視コンポーネントが正しく構成およびインストールされています。
-   Grafana 監視ダッシュボードで[監視メトリック](/dm/monitor-a-dm-cluster.md#task)表示できます。
-   診断するコンポーネントは正常に動作しています。そうでない場合、監視メトリックの例外が発生する可能性があり、パフォーマンスの問題の診断に影響する可能性があります。

データ移行のレイテンシーが大きい場合、ボトルネックが DMコンポーネント内にあるか、TiDB クラスター内にあるかを素早く判断するには、まず[下流にSQL文を書き込む](#write-sql-statements-to-downstream)の`DML queue remain length`確認します。

## リレーログユニット {#relay-log-unit}

リレーログユニットのパフォーマンス問題を診断するには、監視メトリック`binlog file gap between master and relay`確認します。このメトリックの詳細については、 [リレーログの監視メトリクス](/dm/monitor-a-dm-cluster.md#relay-log)を参照してください。このメトリックが長時間にわたって1より大きい場合、通常はパフォーマンス問題が発生していることを示します。このメトリックが0の場合、通常はパフォーマンス問題が発生していないことを示します。

`binlog file gap between master and relay`の値が 0 であるにもかかわらず、パフォーマンスに問題があると思われる場合は、 `binlog pos`確認してください。このメトリックの`master` `relay`よりも大幅に大きい場合は、パフォーマンスに問題がある可能性があります。その場合は、問題を診断し、適切に対処してください。

### binlogデータを読み取る {#read-binlog-data}

`read binlog event duration` 、リレーログが上流データベース（MySQL/MariaDB）からbinlogを読み取る時間を表します。理想的には、このメトリックは DM ワーカーと MySQL/MariaDB インスタンス間のネットワークレイテンシーに近い値になります。

-   単一データセンター内でのデータ移行では、 binlogデータの読み取りはパフォーマンスのボトルネックにはなりません。値が`read binlog event duration`に設定されている場合は、DM-workerとMySQL/MariaDB間のネットワーク接続を確認してください。

-   地理的に分散された環境でのデータ移行では、DM ワーカーと MySQL/MariaDB を 1 つのデータ センターにデプロイし、TiDB クラスターをターゲット データ センターにデプロイするようにしてください。

アップストリーム データベースからbinlogデータを読み取るプロセスには、次のサブプロセスが含まれます。

-   上流のMySQL/MariaDBはbinlogデータをローカルで読み取り、ネットワーク経由で送信します。MySQL/MariaDBの負荷に例外が発生しない限り、このサブプロセスは通常ボトルネックにはなりません。
-   binlogデータは、MySQL/MariaDBが配置されているマシンからDM-workerが配置されているマシンへネットワーク経由で転送されます。このサブプロセスがボトルネックになるかどうかは、主にDM-workerと上流のMySQL/MariaDB間のネットワーク接続に依存します。
-   DM-workerはネットワークデータストリームからbinlogデータを読み取り、binlogイベントとして構築します。DM-workerの負荷に例外が発生しない限り、このサブプロセスは通常ボトルネックにはなりません。

> **注記：**
>
> `read binlog event duration`という値が大きい場合、上流の MySQL/MariaDB の負荷が低いことが原因として考えられます。これは、一定期間 DM にbinlogイベントを送信する必要がなく、リレーログユニットが待機状態にあることを意味します。そのため、この値には追加の待機時間が含まれています。

### binlogデータのデコードと検証 {#binlog-data-decoding-and-verification}

DMのリレー処理ユニットは、binlogイベントをDMメモリに読み込んだ後、データをデコードして検証します。これは通常、パフォーマンスのボトルネックにはならないため、デフォルトでは監視ダッシュボードに関連するパフォーマンスメトリックは表示されません。このメトリックを表示する必要がある場合は、Grafanaで手動で監視項目を追加できます。この監視項目は、Prometheusのメトリック`dm_relay_read_transform_duration`に対応しています。

### リレーログファイルを書き込む {#write-relay-log-files}

binlogイベントをリレーログファイルに書き込む場合、関連するパフォーマンスメトリックは`write relay log duration`です。3 `binlog event size`大きすぎる場合は、この値はマイクロ秒単位にする必要があります。5 `write relay log duration`大きすぎる場合は、ディスクの書き込みパフォーマンスを確認してください。書き込みパフォーマンスの低下を回避するには、DMワーカーにローカルSSDを使用してください。

## 負荷ユニット {#load-unit}

ロードユニットの主な操作は、ローカルからSQLファイルデータを読み取り、下流に書き込むことです。関連するパフォーマンスメトリックは`transaction execution latency`です。この値が大きすぎる場合は、下流データベースの監視をチェックして、下流のパフォーマンスを確認してください。また、DMと下流データベース間のネットワークレイテンシーが大きいかどうかも確認する必要があります。

## Binlogレプリケーションユニット {#binlog-replication-unit}

Binlogレプリケーションユニットのパフォーマンス問題を診断するには、 `binlog file gap between master and syncer`監視メトリックを確認できます。このメトリックの詳細については、 [Binlogレプリケーションの監視メトリクス](/dm/monitor-a-dm-cluster.md#binlog-replication)参照してください。

-   このメトリックが長時間にわたって 1 より大きい場合、通常はパフォーマンスの問題があることを示します。
-   このメトリックが 0 の場合、通常はパフォーマンスの問題がないことを示します。

`binlog file gap between master and syncer`長期間にわたって1より大きい場合は、 `binlog file gap between relay and syncer`確認して、レイテンシーが主にどのユニットに存在しているかを特定してください。この値が通常0の場合、レイテンシーはリレーログユニットに存在している可能性があります。その場合は[リレーログユニット](#relay-log-unit)を参照して問題を解決してください。それ以外の場合は、引き続きBinlogレプリケーションユニットを確認してください。

### binlogデータを読み取る {#read-binlog-data}

Binlogレプリケーションユニットは、設定に応じて、上流のMySQL/MariaDBからbinlogイベントを読み取るか、リレーログファイルから読み取るかを決定します。関連するパフォーマンスメトリックは`read binlog event duration`で、通常は数マイクロ秒から数十マイクロ秒の範囲です。

-   DM のBinlogレプリケーション処理ユニットがアップストリーム MySQL/MariaDB からbinlogイベントを読み取る場合、問題を特定して解決するには、「リレー ログ ユニット」セクションの[binlogデータを読み取る](#read-binlog-data)参照してください。

-   DMのBinlogレプリケーション処理ユニットがリレーログファイルからbinlogイベントを読み取る場合、 `binlog event size`が大きすぎない場合、 `read binlog event duration`の値はマイクロ秒単位にする必要があります。5 `read binlog event duration`大きすぎる場合は、ディスクの読み取りパフォーマンスを確認してください。書き込みパフォーマンスの低下を回避するには、DMワーカーにローカルSSDを使用してください。

### binlogイベント変換 {#binlog-event-conversion}

Binlogレプリケーションユニットは、DMLを構築し、DDLを解析し、 binlogイベントデータから[テーブルルーター](/dm/dm-table-routing.md)変換を実行します。関連メトリックは`transform binlog event duration`です。

実行時間は主に上流の書き込み操作によって影響を受けます。例えば、 `INSERT INTO`文を例に挙げると、1 個の`VALUES`変換するのにかかる時間は、大量の`VALUES`変換するのにかかる時間とは大きく異なります。処理時間は数十マイクロ秒から数百マイクロ秒の範囲に及ぶ可能性があります。しかし、通常、これがシステムのボトルネックとなることはありません。

### 下流にSQL文を書き込む {#write-sql-statements-to-downstream}

Binlogレプリケーション ユニットが変換された SQL ステートメントをダウンストリームに書き込む場合、関連するパフォーマンス メトリックは`DML queue remain length`と`transaction execution latency`なります。

DMはbinlogイベントからSQL文を構築した後、 `worker-count`キューを使用してこれらの文を下流に同時に書き込みます。ただし、監視エントリが過度に多くなりすぎないようにするため、DMは同時キューのIDに対して`8`法とする演算を実行します。つまり、すべての同時キューは`q_0`から`q_7`までの1つのアイテムに対応します。

`DML queue remain length` 、同時処理キューにおいて、消費されておらず、下流への書き込みが開始されていないDML文の数を示します。理想的には、各`q_*`に対応する曲線はほぼ同じです。そうでない場合、同時処理負荷が極端に不均衡であることを示します。

負荷が分散されていない場合は、移行対象のテーブルに主キーまたは一意キーがあるかどうかを確認してください。これらのキーが存在しない場合は、主キーまたは一意キーを追加してください。負荷が分散されていない状態でこれらのキーが存在する場合は、DMをv1.0.5以降にアップグレードしてください。

-   データ移行リンク全体に顕著なレイテンシーがない場合、対応する曲線`DML queue remain length`はほぼ常に 0 になり、最大値はタスク構成ファイルの値`batch`を超えません。

-   データ移行リンクに顕著なレイテンシーが見られ、各`q_*`に対応する`DML queue remain length`の曲線がほぼ同じで、ほぼ常に0である場合、DMが上流からのデータの読み取り、変換、または同時書き込みを時間内に実行できていないことを意味します（ボトルネックはリレーログユニットにある可能性があります）。トラブルシューティングについては、このドキュメントの前のセクションを参照してください。

`DML queue remain length`に対応する曲線が0でない場合（通常、最大値は1024以下）、下流へのSQL文の書き込み時にボトルネックが発生していることを示します。3 `transaction execution latency`使用すると、下流への単一トランザクションの実行に要した時間を表示できます。

`transaction execution latency`は通常数十ミリ秒です。この値が大きすぎる場合は、下流データベースの監視に基づいて下流のパフォーマンスを確認してください。また、DMと下流データベース間のネットワークレイテンシーが大きくないか確認することもできます。

`BEGIN` 、 `INSERT` 、 `UPDATE` 、 `DELETE` 、 `COMMIT`などの単一のステートメントをダウンストリームに書き込むのに費やされた時間を表示するには、 `statement execution latency`もチェックできます。
