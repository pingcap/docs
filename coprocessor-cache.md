---
title: Coprocessor Cache
summary: TiDB v4.0以降、TiKVにプッシュダウンされる計算結果のキャッシュ機能が追加されました。コプロセッサーキャッシュはTiDB構成ファイルの`tikv-client.copr-cache`で構成可能であり、効果は`EXPLAIN ANALYZE`またはGrafana監視パネルで確認できます。キャッシュはリージョン単位であり、ユーザーには透過的です。計算結果には影響せず、SQLの実行時間にのみ影響します。
---

# コプロセッサーキャッシュ {#coprocessor-cache}

v4.0 以降、TiDB インスタンスは、TiKV にプッシュダウンされる計算結果のキャッシュ (コプロセッサーキャッシュ機能) をサポートします。これにより、一部のシナリオで計算プロセスが高速化されます。

## コンフィグレーション {#configuration}

<CustomContent platform="tidb">

TiDB 構成ファイルの`tikv-client.copr-cache`構成項目を使用して、コプロセッサー・キャッシュを構成できます。コプロセッサーキャッシュを有効にして構成する方法の詳細については、 [TiDBコンフィグレーションファイル](/tidb-configuration-file.md#tikv-clientcopr-cache-new-in-v400)を参照してください。

</CustomContent>

<CustomContent platform="tidb-cloud">

コプロセッサーキャッシュ機能はデフォルトで有効になっています。キャッシュできるデータの最大サイズは 1000 MB です。

</CustomContent>

## 機能の説明 {#feature-description}

-   SQL ステートメントが単一の TiDB インスタンスで初めて実行されるとき、実行結果はキャッシュされません。

-   計算結果はTiDBのメモリにキャッシュされます。 TiDB インスタンスが再起動されると、キャッシュは無効になります。

-   キャッシュは TiDB インスタンス間で共有されません。

-   プッシュダウン計算結果のみキャッシュされます。キャッシュがヒットした場合でも、TiDB はその後の計算を実行する必要があります。

-   キャッシュはリージョン単位です。リージョンにデータを書き込むと、リージョンキャッシュが無効になります。このため、コプロセッサーキャッシュ機能は主に、めったに変更されないデータに対して有効になります。

-   プッシュダウン計算リクエストが同じ場合、キャッシュがヒットします。通常、次のシナリオでは、プッシュダウン計算リクエストは同じか部分的に同じです。
    -   SQL文は同じです。たとえば、同じ SQL ステートメントが繰り返し実行されます。

        このシナリオでは、すべてのプッシュダウン計算リクエストに一貫性があり、すべてのリクエストでプッシュダウン計算キャッシュを使用できます。

    -   SQL ステートメントには変更条件が含まれていますが、他の部分は一貫しています。変更条件はテーブルまたはパーティションの主キーです。

        このシナリオでは、プッシュダウン計算リクエストの一部は以前のリクエストと同じであり、これらの計算リクエストはキャッシュされた (以前の) プッシュダウン計算結果を使用できます。

    -   SQL ステートメントには複数の変更条件が含まれており、他の部分は一貫しています。変更条件は複合インデックス列と正確に一致します。

        このシナリオでは、プッシュダウン計算リクエストの一部は以前のリクエストと同じであり、これらの計算リクエストはキャッシュされた (以前の) プッシュダウン計算結果を使用できます。

-   この機能はユーザーに対して透過的です。この機能を有効または無効にしても、計算結果には影響せず、SQL の実行時間にのみ影響します。

## キャッシュ効果を確認する {#check-the-cache-effect}

コプロセッサーのキャッシュ効果は、 `EXPLAIN ANALYZE`を実行するか、Grafana監視パネルを表示することで確認できます。

### <code>EXPLAIN ANALYZE</code>を使用する {#use-code-explain-analyze-code}

[テーブルにアクセスするための演算子](/choose-index.md#operators-for-accessing-tables)のキャッシュ ヒット率は[`EXPLAIN ANALYZE`文](/sql-statements/sql-statement-explain-analyze.md)を使用して表示できます。次の例を参照してください。

```sql
EXPLAIN ANALYZE SELECT * FROM t USE INDEX(a);
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
| id                            | estRows   | actRows | task      | access object          | execution info                                                                                                                                                                                                                                           | operator info                  | memory                | disk |
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
| IndexLookUp_6                 | 262400.00 | 262400  | root      |                        | time:620.513742ms, loops:258, cop_task: {num: 4, max: 5.530817ms, min: 1.51829ms, avg: 2.70883ms, p95: 5.530817ms, max_proc_keys: 2480, p95_proc_keys: 2480, tot_proc: 1ms, tot_wait: 1ms, rpc_num: 4, rpc_time: 10.816328ms, copr_cache_hit_rate: 0.75} |                                | 6.685169219970703 MB  | N/A  |
| ├─IndexFullScan_4(Build)      | 262400.00 | 262400  | cop[tikv] | table:t, index:a(a, c) | proc max:93ms, min:1ms, p80:93ms, p95:93ms, iters:275, tasks:4                                                                                                                                                                                           | keep order:false, stats:pseudo | 1.7549400329589844 MB | N/A  |
| └─TableRowIDScan_5(Probe)     | 262400.00 | 0       | cop[tikv] | table:t                | time:0ns, loops:0                                                                                                                                                                                                                                        | keep order:false, stats:pseudo | N/A                   | N/A  |
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
3 rows in set (0.62 sec)
```

実行結果の列`execution info`には、コプロセッサーキャッシュのヒット率を示す`copr_cache_hit_ratio`情報が表示されます。上記の例の`0.75`ヒット率が約 75% であることを意味します。

### Grafana 監視パネルをビュー {#view-the-grafana-monitoring-panel}

Grafana では、 `tidb`名前空間の下の`distsql`サブシステムに**copr-cache**パネルが表示されます。このパネルは、クラスター全体のコプロセッサーキャッシュのヒット、ミス、およびキャッシュ破棄の数を監視します。
