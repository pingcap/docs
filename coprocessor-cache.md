---
title: Coprocessor Cache
summary: コプロセッサーキャッシュの機能について学習します。
---

# コプロセッサーキャッシュ {#coprocessor-cache}

v4.0 以降、TiDB インスタンスは TiKV (コプロセッサーキャッシュ機能) にプッシュダウンされる計算結果のキャッシュをサポートしており、これにより一部のシナリオで計算プロセスを高速化できます。

## コンフィグレーション {#configuration}

<CustomContent platform="tidb">

コプロセッサーキャッシュは、TiDB 構成ファイルの`tikv-client.copr-cache`構成項目を介して構成できます。コプロセッサーキャッシュを有効にして構成する方法の詳細については、 [TiDBコンフィグレーションファイル](/tidb-configuration-file.md#tikv-clientcopr-cache-new-in-v400)参照してください。

</CustomContent>

<CustomContent platform="tidb-cloud">

コプロセッサーキャッシュ機能はデフォルトで有効になっています。キャッシュできるデータの最大サイズは 1000 MB です。

</CustomContent>

## 機能の説明 {#feature-description}

-   単一の TiDB インスタンスで SQL ステートメントが初めて実行されると、実行結果はキャッシュされません。

-   計算結果は TiDB のメモリにキャッシュされます。TiDB インスタンスを再起動すると、キャッシュは無効になります。

-   キャッシュは TiDB インスタンス間で共有されません。

-   プッシュダウン計算結果のみがキャッシュされます。キャッシュにヒットした場合でも、TiDB は後続の計算を実行する必要があります。

-   キャッシュはリージョン単位です。リージョンにデータを書き込むとリージョンキャッシュが無効になります。このため、コプロセッサーキャッシュ機能は主に変更頻度の低いデータに効果を発揮します。

-   プッシュダウン計算要求が同じ場合、キャッシュがヒットします。通常、次のシナリオでは、プッシュダウン計算要求は同じか、部分的に同じです。
    -   SQL 文は同じです。たとえば、同じ SQL 文が繰り返し実行されます。

        このシナリオでは、すべてのプッシュダウン計算要求は一貫しており、すべての要求はプッシュダウン計算キャッシュを使用できます。

    -   SQL ステートメントには変更条件が含まれており、他の部分は一貫しています。変更条件は、テーブルまたはパーティションの主キーです。

        このシナリオでは、プッシュダウン計算要求の一部は以前の要求と同じであり、これらの計算要求はキャッシュされた (以前の) プッシュダウン計算結果を使用できます。

    -   SQL ステートメントには複数の変更条件が含まれており、他の部分は一貫しています。変更条件は複合インデックス列と完全に一致します。

        このシナリオでは、プッシュダウン計算要求の一部は以前の要求と同じであり、これらの計算要求はキャッシュされた (以前の) プッシュダウン計算結果を使用できます。

-   この機能はユーザーに対して透過的です。この機能を有効または無効にしても計算結果には影響せず、SQL 実行時間にのみ影響します。

## キャッシュ効果を確認する {#check-the-cache-effect}

`EXPLAIN ANALYZE`を実行するか、Grafana 監視パネルを表示することで、コプロセッサーのキャッシュ効果を確認できます。

### <code>EXPLAIN ANALYZE</code>使用する {#use-code-explain-analyze-code}

[`EXPLAIN ANALYZE`ステートメント](/sql-statements/sql-statement-explain-analyze.md)使用すると、 [テーブルにアクセスするための演算子](/choose-index.md#operators-for-accessing-tables)のキャッシュヒット率を表示できます。次の例を参照してください。

```sql
EXPLAIN ANALYZE SELECT * FROM t USE INDEX(a);
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
| id                            | estRows   | actRows | task      | access object          | execution info                                                                                                                                                                                                                                           | operator info                  | memory                | disk |
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
| IndexLookUp_6                 | 262400.00 | 262400  | root      |                        | time:620.513742ms, loops:258, cop_task: {num: 4, max: 5.530817ms, min: 1.51829ms, avg: 2.70883ms, p95: 5.530817ms, max_proc_keys: 2480, p95_proc_keys: 2480, tot_proc: 1ms, tot_wait: 1ms, rpc_num: 4, rpc_time: 10.816328ms, copr_cache_hit_rate: 0.75} |                                | 6.685169219970703 MB  | N/A  |
| ├─IndexFullScan_4(Build)      | 262400.00 | 262400  | cop[tikv] | table:t, index:a(a, c) | proc max:93ms, min:1ms, p80:93ms, p95:93ms, iters:275, tasks:4                                                                                                                                                                                           | keep order:false, stats:pseudo | 1.7549400329589844 MB | N/A  |
| └─TableRowIDScan_5(Probe)     | 262400.00 | 0       | cop[tikv] | table:t                | time:0ns, loops:0                                                                                                                                                                                                                                        | keep order:false, stats:pseudo | N/A                   | N/A  |
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
3 rows in set (0.62 sec)
```

実行結果の列`execution info`には、コプロセッサーキャッシュのヒット率を示す`copr_cache_hit_ratio`情報が表示されます。上記の例の`0.75` 、ヒット率が約 75% であることを意味します。

### Grafana モニタリング パネルをビュー {#view-the-grafana-monitoring-panel}

Grafana では、 `tidb`名前空間の`distsql`サブシステムに**copr-cache**パネルが表示されます。このパネルは、クラスター全体のコプロセッサーキャッシュのヒット数、ミス数、キャッシュ破棄数を監視します。
