---
title: Coprocessor Cache
summary: コプロセッサーキャッシュの機能について学習します。
---

# コプロセッサーキャッシュ {#coprocessor-cache}

v4.0 以降、TiDB インスタンスは TiKV (コプロセッサーキャッシュ機能) にプッシュダウンされる計算結果のキャッシュをサポートしており、これにより一部のシナリオで計算プロセスを高速化できます。

## コンフィグレーション {#configuration}

<CustomContent platform="tidb">

コプロセッサーキャッシュは、TiDB設定ファイルの`tikv-client.copr-cache`設定項目で設定できます。コプロセッサーキャッシュの有効化と設定方法の詳細については、 [TiDBコンフィグレーションファイル](/tidb-configuration-file.md#tikv-clientcopr-cache-new-in-v400)参照してください。

</CustomContent>

<CustomContent platform="tidb-cloud">

コプロセッサーキャッシュ機能はデフォルトで有効になっています。キャッシュできるデータの最大サイズは1000MBです。

</CustomContent>

## 機能の説明 {#feature-description}

-   単一の TiDB インスタンスで SQL ステートメントが初めて実行されると、実行結果はキャッシュされません。

-   計算結果はTiDBのメモリにキャッシュされます。TiDBインスタンスを再起動すると、キャッシュは無効になります。

-   キャッシュは TiDB インスタンス間で共有されません。

-   プッシュダウン計算の結果のみがキャッシュされます。キャッシュにヒットした場合でも、TiDBは後続の計算を実行する必要があります。

-   キャッシュはリージョン単位で管理されます。リージョンにデータを書き込むと、リージョンキャッシュは無効になります。そのため、コプロセッサーキャッシュ機能は、主に変更頻度の低いデータに効果を発揮します。

-   プッシュダウン計算リクエストが同じ場合、キャッシュにヒットします。通常、以下のシナリオでは、プッシュダウン計算リクエストは同じか、部分的に同じです。
    -   SQL文は同じです。例えば、同じSQL文が繰り返し実行されます。

        このシナリオでは、すべてのプッシュダウン計算要求は一貫しており、すべての要求はプッシュダウン計算キャッシュを使用できます。

    -   SQL文には変更条件が含まれており、その他の部分は一貫しています。変更条件は、テーブルまたはパーティションの主キーです。

        このシナリオでは、プッシュダウン計算要求の一部は以前の要求の一部と同じであり、これらの計算要求はキャッシュされた (以前の) プッシュダウン計算結果を使用できます。

    -   SQL文には複数の変更条件が含まれており、その他の部分は一貫しています。変更条件は複合インデックス列と完全に一致します。

        このシナリオでは、プッシュダウン計算要求の一部は以前の要求の一部と同じであり、これらの計算要求はキャッシュされた (以前の) プッシュダウン計算結果を使用できます。

-   この機能はユーザーにとって透過的です。この機能を有効または無効にしても計算結果には影響せず、SQL実行時間のみに影響します。

## キャッシュ効果を確認する {#check-the-cache-effect}

`EXPLAIN ANALYZE`実行するか、Grafana 監視パネルを表示することで、コプロセッサーのキャッシュ効果を確認できます。

### <code>EXPLAIN ANALYZE</code>使用する {#use-code-explain-analyze-code}

[テーブルにアクセスするための演算子](/choose-index.md#operators-for-accessing-tables)のキャッシュヒット率は[`EXPLAIN ANALYZE`ステートメント](/sql-statements/sql-statement-explain-analyze.md)使って確認できます。次の例をご覧ください。

```sql
EXPLAIN ANALYZE SELECT * FROM t USE INDEX(a);
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
| id                            | estRows   | actRows | task      | access object          | execution info                                                                                                                                                                                                                                           | operator info                  | memory                | disk |
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
| IndexLookUp_6                 | 262400.00 | 262400  | root      |                        | time:620.513742ms, loops:258, cop_task: {num: 4, max: 5.530817ms, min: 1.51829ms, avg: 2.70883ms, p95: 5.530817ms, max_proc_keys: 2480, p95_proc_keys: 2480, tot_proc: 1ms, tot_wait: 1ms, rpc_num: 4, rpc_time: 10.816328ms, copr_cache_hit_rate: 0.75} |                                | 6.685169219970703 MB  | N/A  |
| ├─IndexFullScan_4(Build)      | 262400.00 | 262400  | cop[tikv] | table:t, index:a(a, c) | proc max:93ms, min:1ms, p80:93ms, p95:93ms, iters:275, tasks:4                                                                                                                                                                                           | keep order:false, stats:pseudo | 1.7549400329589844 MB | N/A  |
| └─TableRowIDScan_5(Probe)     | 262400.00 | 0       | cop[tikv] | table:t                | time:0ns, loops:0                                                                                                                                                                                                                                        | keep order:false, stats:pseudo | N/A                   | N/A  |
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
3 rows in set (0.62 sec)
```

実行結果の列`execution info`は、コプロセッサーキャッシュのヒット率を示す「 `copr_cache_hit_ratio`という情報が表示されます。上記の例の「 `0.75`は、ヒット率が約75%であることを意味します。

### Grafana 監視パネルをビュー {#view-the-grafana-monitoring-panel}

Grafanaでは、 `tidb`名前空間の`distsql`サブシステムに**copr-cache**パネルが表示されます。このパネルは、クラスター全体のコプロセッサーキャッシュのヒット数、ミス数、キャッシュ破棄数を監視します。
