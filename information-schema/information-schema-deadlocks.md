---
title: DEADLOCKS
summary: Learn the `DEADLOCKS` INFORMATION_SCHEMA table.
---

# 行き詰まり {#deadlocks}

表`DEADLOCKS`は、現在の TiDB ノードで最近発生したいくつかのデッドロック エラーの情報を示しています。

```sql
USE INFORMATION_SCHEMA;
DESC deadlocks;
```

出力は次のとおりです。

```sql
+-------------------------+---------------------+------+------+---------+-------+
| Field                   | Type                | Null | Key  | Default | Extra |
+-------------------------+---------------------+------+------+---------+-------+
| DEADLOCK_ID             | bigint(21)          | NO   |      | NULL    |       |
| OCCUR_TIME              | timestamp(6)        | YES  |      | NULL    |       |
| RETRYABLE               | tinyint(1)          | NO   |      | NULL    |       |
| TRY_LOCK_TRX_ID         | bigint(21) unsigned | NO   |      | NULL    |       |
| CURRENT_SQL_DIGEST      | varchar(64)         | YES  |      | NULL    |       |
| CURRENT_SQL_DIGEST_TEXT | text                | YES  |      | NULL    |       |
| KEY                     | text                | YES  |      | NULL    |       |
| KEY_INFO                | text                | YES  |      | NULL    |       |
| TRX_HOLDING_LOCK        | bigint(21) unsigned | NO   |      | NULL    |       |
+-------------------------+---------------------+------+------+---------+-------+
```

`DEADLOCKS`テーブルは複数の行を使用して同じデッドロック イベントを表示し、各行にはデッドロック イベントに関係するトランザクションの 1 つに関する情報が表示されます。 TiDB ノードが複数のデッドロック エラーを記録する場合、各エラーは`DEADLOCK_ID`列を使用して区別されます。同じ`DEADLOCK_ID`同じデッドロック イベントを示します。 `DEADLOCK_ID`**はグローバルな一意性を保証せず、永続化されないこと**に注意してください。同じ結果セット内の同じデッドロック イベントのみが表示されます。

`DEADLOCKS`テーブルの各列フィールドの意味は次のとおりです。

-   `DEADLOCK_ID` : デッドロック イベントの ID。テーブル内に複数のデッドロック エラーが存在する場合、この列を使用して、異なるデッドロック エラーに属する行を区別できます。
-   `OCCUR_TIME` : デッドロックエラーが発生した時刻。
-   `RETRYABLE` : デッドロックエラーをリトライできるかどうか。再試行可能なデッドロック エラーの説明については、 [再試行可能なデッドロック エラー](#retryable-deadlock-errors)セクションを参照してください。
-   `TRY_LOCK_TRX_ID` : ロックを取得しようとするトランザクションの ID。この ID はトランザクションの`start_ts`でもあります。
-   `CURRENT_SQL_DIGEST` : ロック取得トランザクションで現在実行中のSQL文のダイジェスト。
-   `CURRENT_SQL_DIGEST_TEXT` : ロック取得トランザクションで現在実行されている SQL ステートメントの正規化された形式。
-   `KEY` : トランザクションがロックしようとしたブロックされたキー。このフィールドの値は 16 進文字列の形式で表示されます。
-   `KEY_INFO` ： `KEY`の詳細情報です。 [`KEY_INFO`](#key_info)セクションを参照してください。
-   `TRX_HOLDING_LOCK` : 現在キーのロックを保持し、ブロックを引き起こしているトランザクションの ID。この ID はトランザクションの`start_ts`でもあります。

<CustomContent platform="tidb">

`DEADLOCKS`テーブルに記録できるデッドロック イベントの最大数を調整するには、TiDB 構成ファイルの[`pessimistic-txn.deadlock-history-capacity`](/tidb-configuration-file.md#deadlock-history-capacity)構成を調整します。デフォルトでは、最近の 10 件のデッドロック イベントの情報がテーブルに記録されます。

</CustomContent>

<CustomContent platform="tidb-cloud">

最近の 10 件のデッドロック イベントの情報が`DEADLOCKS`テーブルに記録されます。

</CustomContent>

> **警告：**
>
> -   [プロセス](https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html#priv_process)権限を持つユーザーのみがこのテーブルをクエリできます。
> -   `CURRENT_SQL_DIGEST`列目の情報（SQLダイジェスト）は、正規化されたSQL文から計算されたハッシュ値です。 `CURRENT_SQL_DIGEST_TEXT`列の情報はステートメント概要テーブルから内部的にクエリされるため、対応するステートメントが内部で見つからない可能性があります。 SQL ダイジェストとステートメント概要テーブルの詳細については、 [ステートメント概要テーブル](/statement-summary-tables.md)を参照してください。

## <code>KEY_INFO</code> {#code-key-info-code}

`KEY_INFO`列目は`KEY`列目の詳細情報を表示します。情報はJSON形式で表示されます。各フィールドの説明は次のとおりです。

-   `"db_id"` : キーが属するスキーマの ID。
-   `"db_name"` : キーが属するスキーマの名前。
-   `"table_id"` : キーが属するテーブルの ID。
-   `"table_name"` : キーが属するテーブルの名前。
-   `"partition_id"` : キーが配置されているパーティションの ID。
-   `"partition_name"` : キーが存在するパーティションの名前。
-   `"handle_type"` : 行キー (つまり、データ行を格納するキー) のハンドル タイプ。可能な値は次のとおりです。
    -   `"int"` : ハンドルのタイプは int です。これは、ハンドルが行 ID であることを意味します。
    -   `"common"` : ハンドルの型は int64 ではありません。この型は、クラスター化インデックスが有効になっている場合、非 int 主キーに表示されます。
    -   `"unknown"` : ハンドル タイプは現在サポートされていません。
-   `"handle_value"` : ハンドル値。
-   `"index_id"` : インデックスキー(インデックスを格納するキー)が属するインデックスID。
-   `"index_name"` : インデックスキーが属するインデックスの名前。
-   `"index_values"` : インデックス キーのインデックス値。

上記のフィールドでは、フィールドの情報が適用できない場合、または現在利用できない場合、そのフィールドはクエリ結果で省略されます。たとえば、行キー情報には`index_id` 、 `index_name` 、および`index_values`は含まれません。インデックス キーには`handle_type`と`handle_value`が含まれません。パーティション化されていないテーブルには`partition_id`と`partition_name`は表示されません。削除されたテーブルのキー情報は、 `table_name`などのスキーマ情報`db_name`取得できず、テーブル`index_name`パーティションテーブルである`db_id`どうかを区別できません。

> **注記：**
>
> パーティショニングが有効になっているテーブルからキーが取得され、クエリ中に何らかの理由 (キーが属するテーブルが削除されたなど) によりキーが属するスキーマの情報をクエリできない場合、IDキーが属するパーティションの名前が`table_id`フィールドに表示される場合があります。これは、TiDB が複数の独立したテーブルのキーをエンコードするのと同じ方法で、異なるパーティションのキーをエンコードするためです。したがって、スキーマ情報が欠落している場合、TiDB はキーがパーティション化されていないテーブルに属しているのか、テーブルの 1 つのパーティションに属しているのかを確認できません。

## 再試行可能なデッドロック エラー {#retryable-deadlock-errors}

<CustomContent platform="tidb-cloud">

> **注記：**
>
> このセクションはTiDB Cloudには適用されません。

</CustomContent>

<CustomContent platform="tidb">

> **注記：**
>
> `DEADLOCKS`テーブルは、デフォルトでは再試行可能なデッドロック エラーの情報を収集しません。テーブルで再試行可能なデッドロック エラー情報を収集する場合は、TiDB 構成ファイルで値[`pessimistic-txn.deadlock-history-collect-retryable`](/tidb-configuration-file.md#deadlock-history-collect-retryable)を調整できます。

</CustomContent>

トランザクション A がトランザクション B がすでに保持しているロックによってブロックされており、トランザクション B が現在のトランザクション A が保持しているロックによって直接的または間接的にブロックされている場合、デッドロック エラーが発生します。このデッドロックでは、次の 2 つのケースが考えられます。

-   ケース 1:トランザクションB は、トランザクション A の開始後、トランザクション A がブロックされる前に実行されたステートメントによって生成されたロックによって (直接的または間接的に) ブロックされる可能性があります。
-   ケース 2:トランザクションB は、トランザクション A で現在実行中のステートメントによってブロックされる可能性もあります。

ケース 1 では、TiDB はトランザクション A のクライアントにデッドロック エラーを報告し、トランザクションを終了します。

ケース 2 では、トランザクション A で現在実行中のステートメントが TiDB で自動的に再試行されます。たとえば、トランザクション A が次のステートメントを実行するとします。

```sql
UPDATE t SET v = v + 1 WHERE id = 1 OR id = 2;
```

トランザクションB は、次の 2 つのステートメントを連続して実行します。

```sql
UPDATE t SET v = 4 WHERE id = 2;
UPDATE t SET v = 2 WHERE id = 1;
```

次に、トランザクション A が`id = 1`と`id = 2`の 2 つの行をロックし、2 つのトランザクションが次の順序で実行されるとします。

1.  トランザクションA は行を`id = 1`でロックします。
2.  トランザクションB は最初のステートメントを実行し、行を`id = 2`でロックします。
3.  トランザクションB は 2 番目のステートメントを実行し、行を`id = 1`でロックしようとしますが、これはトランザクション A によってブロックされます。
4.  トランザクションA は行を`id = 2`でロックしようとしますが、トランザクション B によってブロックされ、デッドロックが形成されます。

この場合、他のトランザクションをブロックするトランザクション A のステートメントは現在実行中のステートメントでもあるため、現在のステートメントの悲観的ロックを解決でき (トランザクション B が実行を継続できるように)、現在のステートメントを再試行できます。 。 TiDB は内部でキー ハッシュを使用して、これが当てはまるかどうかを判断します。

再試行可能なデッドロックが発生した場合、内部の自動再試行ではトランザクション エラーが発生しないため、クライアントに対して透過的です。ただし、この状況が頻繁に発生すると、パフォーマンスに影響が出る可能性があります。これが発生すると、TiDB ログに`single statement deadlock, retry statement`が表示されます。

## 例1 {#example-1}

テーブル定義と初期データが次のとおりであると仮定します。

```sql
CREATE TABLE t (id int primary key, v int);
INSERT INTO t VALUES (1, 10), (2, 20);
```

2 つのトランザクションは次の順序で実行されます。

| トランザクション1                           | トランザクション2                           | 説明                           |
| ----------------------------------- | ----------------------------------- | ---------------------------- |
| `UPDATE t SET v = 11 WHERE id = 1;` |                                     |                              |
|                                     | `UPDATE t SET v = 21 WHERE id = 2;` |                              |
| `UPDATE t SET v = 12 WHERE id = 2;` |                                     | トランザクション1 がブロックされます。         |
|                                     | `UPDATE t SET v = 22 WHERE id = 1;` | トランザクション2 はデッドロック エラーを報告します。 |

次に、トランザクション 2 がデッドロック エラーを報告します。この時点で、 `DEADLOCKS`テーブルに対してクエリを実行します。

```sql
SELECT * FROM INFORMATION_SCHEMA.DEADLOCKS;
```

期待される出力は次のとおりです。

```sql
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
| DEADLOCK_ID | OCCUR_TIME                 | RETRYABLE | TRY_LOCK_TRX_ID    | CURRENT_SQL_DIGEST                                               | CURRENT_SQL_DIGEST_TEXT                 | KEY                                    | KEY_INFO                                                                                           | TRX_HOLDING_LOCK   |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
|           1 | 2021-08-05 11:09:03.230341 |         0 | 426812829645406216 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000002 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"2"} | 426812829645406217 |
|           1 | 2021-08-05 11:09:03.230341 |         0 | 426812829645406217 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000001 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"1"} | 426812829645406216 |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
```

`DEADLOCKS`テーブルに 2 行のデータが生成されます。両方の行の`DEADLOCK_ID`フィールドは`1`です。これは、両方の行の情報が同じデッドロック エラーに属していることを意味します。最初の行は、キー`"7480000000000000355F728000000000000002"`で、ID `"426812829645406216"`のトランザクションが ID `"426812829645406217"`のトランザクションによってブロックされていることを示しています。 2 行目は、キー`"7480000000000000355F728000000000000001"`上で ID `"426812829645406217"`のトランザクションが ID `426812829645406216`のトランザクションによってブロックされ、相互ブロックとなりデッドロックが形成されていることを示しています。

## 例 2 {#example-2}

`DEADLOCKS`テーブルに対してクエリを実行し、次の結果が得られたとします。

```sql
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
| DEADLOCK_ID | OCCUR_TIME                 | RETRYABLE | TRY_LOCK_TRX_ID    | CURRENT_SQL_DIGEST                                               | CURRENT_SQL_DIGEST_TEXT                 | KEY                                    | KEY_INFO                                                                                           | TRX_HOLDING_LOCK   |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
|           1 | 2021-08-05 11:09:03.230341 |         0 | 426812829645406216 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000002 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"2"} | 426812829645406217 |
|           1 | 2021-08-05 11:09:03.230341 |         0 | 426812829645406217 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000001 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"1"} | 426812829645406216 |
|           2 | 2021-08-05 11:09:21.252154 |         0 | 426812832017809412 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000002 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"2"} | 426812832017809413 |
|           2 | 2021-08-05 11:09:21.252154 |         0 | 426812832017809413 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000003 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"3"} | 426812832017809414 |
|           2 | 2021-08-05 11:09:21.252154 |         0 | 426812832017809414 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000001 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"1"} | 426812832017809412 |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
```

前述のクエリ結果の`DEADLOCK_ID`列は、最初の 2 行が合わせてデッドロック エラーの情報を表しており、相互に待機している 2 つのトランザクションがデッドロックを形成していることを示しています。次の 3 行は合わせて別のデッドロック エラーの情報を表し、1 つのサイクルで待機する 3 つのトランザクションがデッドロックを形成します。

## CLUSTER_DEADLOCKS {#cluster-deadlocks}

`CLUSTER_DEADLOCKS`テーブルは、クラスター全体の各 TiDB ノードで最近発生したデッドロック エラーに関する情報を返します。これは、各ノードの`DEADLOCKS`テーブルの情報を組み合わせたものです。 `CLUSTER_DEADLOCKS`は、異なる TiDB ノードを区別するためにノードの IP アドレスとポートを表示する追加の`INSTANCE`列も含まれています。

`DEADLOCK_ID`グローバルな一意性を保証しないため、 `CLUSTER_DEADLOCKS`テーブルのクエリ結果では、結果セット内のさまざまなデッドロック エラーの情報を区別するために`INSTANCE`と`DEADLOCK_ID`一緒に使用する必要があることに注意してください。

```sql
USE INFORMATION_SCHEMA;
DESC CLUSTER_DEADLOCKS;
```

出力は次のとおりです。

```sql
+-------------------------+---------------------+------+------+---------+-------+
| Field                   | Type                | Null | Key  | Default | Extra |
+-------------------------+---------------------+------+------+---------+-------+
| INSTANCE                | varchar(64)         | YES  |      | NULL    |       |
| DEADLOCK_ID             | bigint(21)          | NO   |      | NULL    |       |
| OCCUR_TIME              | timestamp(6)        | YES  |      | NULL    |       |
| RETRYABLE               | tinyint(1)          | NO   |      | NULL    |       |
| TRY_LOCK_TRX_ID         | bigint(21) unsigned | NO   |      | NULL    |       |
| CURRENT_SQL_DIGEST      | varchar(64)         | YES  |      | NULL    |       |
| CURRENT_SQL_DIGEST_TEXT | text                | YES  |      | NULL    |       |
| KEY                     | text                | YES  |      | NULL    |       |
| KEY_INFO                | text                | YES  |      | NULL    |       |
| TRX_HOLDING_LOCK        | bigint(21) unsigned | NO   |      | NULL    |       |
+-------------------------+---------------------+------+------+---------+-------+
```
